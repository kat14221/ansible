# Role: user-security-dashboard
# Genera evidencias de usuarios, permisos y pol√≠ticas.

- name: Ensure remote dashboard directory exists
  file:
    path: /tmp/user_security_dashboard
    state: directory
    mode: '0750'
  become: yes

- name: Capture local users with login shell
  shell: |
    {
      echo "# Usuarios con shell v√°lido";
      printf "%-18s %-6s %-6s %-25s %-20s\n" "USUARIO" "UID" "GID" "DIRECTORIO" "SHELL";
      getent passwd | awk -F: '$7 ~ /(bash|sh|zsh)$/ {printf "%-18s %-6s %-6s %-25s %-20s\n", $1, $3, $4, $6, $7}' | sort;
    } > /tmp/user_security_dashboard/01_usuarios.txt
  become: yes

- name: Capture key groups
  shell: |
    {
      echo "# Grupos cr√≠ticos";
      getent group alumnos profesores lab-admins operator sudo 2>/dev/null;
    } > /tmp/user_security_dashboard/02_grupos.txt
  failed_when: false
  become: yes

- name: Capture password policy details
  shell: |
    {
      echo "# Pol√≠tica de contrase√±as";
      for usr in academico operator admin {{ vault_ansible_user | default('ansible') }}; do
        chage -l "$usr" 2>/dev/null && echo "";
      done;
      echo "# /etc/login.defs";
      egrep 'PASS_(MIN|MAX|WARN)' /etc/login.defs;
    } > /tmp/user_security_dashboard/03_politica_contrasenas.txt
  failed_when: false
  become: yes

- name: Capture sudo policies
  shell: |
    {
      echo "# sudoers.d";
      ls /etc/sudoers.d 2>/dev/null || true;
      echo "";
      for file in /etc/sudoers.d/*; do
        [ -e "$file" ] || continue;
        echo "## $file";
        cat "$file";
        echo "";
      done;
    } > /tmp/user_security_dashboard/04_sudo_policies.txt
  args:
    warn: false
  become: yes

- name: Capture ACLs for evidence repository
  shell: |
    getfacl -p /srv/evidence 2>/dev/null > /tmp/user_security_dashboard/05_acl_evidence.txt || true
  failed_when: false
  become: yes

- name: Capture audit rules related to identity
  shell: |
    auditctl -l 2>/dev/null | egrep '(identity|sudo|sshd)' > /tmp/user_security_dashboard/06_audit_rules.txt || true
  failed_when: false
  become: yes

- name: Build markdown dashboard
  shell: |
    cat <<EOF > /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md
    # Dashboard de Seguridad por Usuario

    ## 1. Usuarios con Shell Activo
    
    ```text
    $(cat /tmp/user_security_dashboard/01_usuarios.txt)
    ```
    
    ## 2. Grupos Cr√≠ticos
    
    ```text
    $(cat /tmp/user_security_dashboard/02_grupos.txt)
    ```
    
    ## 3. Pol√≠ticas de Contrase√±a
    
    ```text
    $(cat /tmp/user_security_dashboard/03_politica_contrasenas.txt)
    ```
    
    ## 4. Reglas sudoers Delegadas
    
    ```text
    $(cat /tmp/user_security_dashboard/04_sudo_policies.txt)
    ```
    
    ## 5. Permisos y ACLs sobre Evidencias
    
    ```text
    $(cat /tmp/user_security_dashboard/05_acl_evidence.txt)
    ```
    
    ## 6. Auditor√≠a Activa
    
    ```text
    $(cat /tmp/user_security_dashboard/06_audit_rules.txt)
    ```
    EOF
  become: yes

- name: Ensure local evidence directory exists
  delegate_to: localhost
  file:
    path: "{{ (playbook_dir | dirname) + '/evidence/gestion_seguridad' }}"
    state: directory
    mode: '0750'
  run_once: true

- name: Fetch dashboard artifacts
  fetch:
    src: /tmp/user_security_dashboard/
    dest: "{{ (playbook_dir | dirname) + '/evidence/gestion_seguridad/' + inventory_hostname }}"
    flat: no
  become: yes

- name: Show summary
  debug:
    msg:
      - "üìÅ Evidencias descargadas en evidence/gestion_seguridad/{{ inventory_hostname }}"
      - "Incluye SEGURIDAD_DASHBOARD.md y archivos fuente (users, groups, sudo, ACL, audit)"
