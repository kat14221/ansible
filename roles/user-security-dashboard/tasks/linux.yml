---
# Linux workflow for user-security-dashboard

- name: Ensure remote dashboard directory exists
  file:
    path: /tmp/user_security_dashboard
    state: directory
    mode: 0750
  become: true

- name: Capture local users with login shell
  shell: >
    echo "# Usuarios con shell valido" > /tmp/user_security_dashboard/01_usuarios.txt &&
    printf "%-18s %-6s %-6s %-25s %-20s\n" "USUARIO" "UID" "GID" "DIRECTORIO" "SHELL" >> /tmp/user_security_dashboard/01_usuarios.txt &&
    timeout 30 getent passwd | awk -F: '$7 ~ /(bash|sh|zsh)$/{printf "%-18s %-6s %-6s %-25s %-20s\n", $1, $3, $4, $6, $7}' | sort >> /tmp/user_security_dashboard/01_usuarios.txt || echo "Timeout en captura de usuarios" >> /tmp/user_security_dashboard/01_usuarios.txt
  become: true
  ignore_errors: true

- name: Capture key groups
  shell: >
    echo "# Grupos criticos" > /tmp/user_security_dashboard/02_grupos.txt &&
    getent group alumnos profesores lab-admins operator sudo >> /tmp/user_security_dashboard/02_grupos.txt 2>/dev/null || true
  failed_when: false
  become: true

- name: Capture password policy details
  shell: >
    echo "# Politica de contraseñas" > /tmp/user_security_dashboard/03_politica_contrasenas.txt &&
    for usr in academico operator admin ansible; do
      chage -l "$usr" >> /tmp/user_security_dashboard/03_politica_contrasenas.txt 2>/dev/null || true;
    done &&
    echo "# /etc/login.defs" >> /tmp/user_security_dashboard/03_politica_contrasenas.txt &&
    egrep 'PASS_(MIN|MAX|WARN)' /etc/login.defs >> /tmp/user_security_dashboard/03_politica_contrasenas.txt 2>/dev/null || true
  failed_when: false
  become: true

- name: Capture sudo policies
  shell: >
    echo "# sudoers.d" > /tmp/user_security_dashboard/04_sudo_policies.txt &&
    ls /etc/sudoers.d >> /tmp/user_security_dashboard/04_sudo_policies.txt 2>/dev/null || true &&
    for file in /etc/sudoers.d/*; do
      if [ -e "$file" ]; then
        echo "## $file" >> /tmp/user_security_dashboard/04_sudo_policies.txt;
        cat "$file" >> /tmp/user_security_dashboard/04_sudo_policies.txt 2>/dev/null || true;
      fi;
    done
  become: true

- name: Capture ACLs for evidence repository
  shell: >
    getfacl -p /srv/evidence > /tmp/user_security_dashboard/05_acl_evidence.txt 2>/dev/null ||
    echo "No ACLs found or getfacl not available" > /tmp/user_security_dashboard/05_acl_evidence.txt
  failed_when: false
  become: true

- name: Capture audit rules related to identity
  shell: >
    auditctl -l 2>/dev/null | egrep '(identity|sudo|sshd)' > /tmp/user_security_dashboard/06_audit_rules.txt ||
    echo "No audit rules found" > /tmp/user_security_dashboard/06_audit_rules.txt
  failed_when: false
  become: true

- name: Build markdown dashboard
  shell: >
    echo "# Dashboard de Seguridad por Usuario" > /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "## 1. Usuarios con Shell Activo" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```text' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    cat /tmp/user_security_dashboard/01_usuarios.txt >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "## 2. Grupos Criticos" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```text' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    cat /tmp/user_security_dashboard/02_grupos.txt >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "## 3. Politicas de Contraseña" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```text' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    cat /tmp/user_security_dashboard/03_politica_contrasenas.txt >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "## 4. Reglas sudoers Delegadas" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```text' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    cat /tmp/user_security_dashboard/04_sudo_policies.txt >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "## 5. Permisos y ACLs sobre Evidencias" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```text' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    cat /tmp/user_security_dashboard/05_acl_evidence.txt >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "## 6. Auditoria Activa" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo "" >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```text' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    cat /tmp/user_security_dashboard/06_audit_rules.txt >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md &&
    echo '```' >> /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md
  become: true

- name: Check if usuarios file exists
  stat:
    path: /tmp/user_security_dashboard/01_usuarios.txt
  register: usuarios_file
  become: true

- name: Load usuarios section
  slurp:
    src: /tmp/user_security_dashboard/01_usuarios.txt
  register: usuarios_raw
  become: true
  when: usuarios_file.stat.exists
  ignore_errors: true

- name: Load grupos section
  slurp:
    src: /tmp/user_security_dashboard/02_grupos.txt
  register: grupos_raw
  become: true
  ignore_errors: true

- name: Load contrasenas section
  slurp:
    src: /tmp/user_security_dashboard/03_politica_contrasenas.txt
  register: contrasenas_raw
  become: true
  ignore_errors: true

- name: Load sudo section
  slurp:
    src: /tmp/user_security_dashboard/04_sudo_policies.txt
  register: sudo_raw
  become: true
  ignore_errors: true

- name: Load ACL section
  slurp:
    src: /tmp/user_security_dashboard/05_acl_evidence.txt
  register: acl_raw
  become: true
  ignore_errors: true

- name: Load audit section
  slurp:
    src: /tmp/user_security_dashboard/06_audit_rules.txt
  register: audit_raw
  become: true
  ignore_errors: true

- name: Check if nftables is available
  command: which nft
  register: nft_available
  failed_when: false
  changed_when: false

- name: Check nftables table for dashboard
  shell: nft list table inet ansible 2>/dev/null || echo "table not found"
  register: user_dash_nft_table
  failed_when: false
  changed_when: false
  become: true
  when: nft_available.rc == 0

- name: Create nftables table for dashboard when missing
  shell: nft add table inet ansible 2>/dev/null || true
  when: 
    - nft_available.rc == 0
    - "'table not found' in user_dash_nft_table.stdout"
  become: true
  ignore_errors: true

- name: Check nftables chain for dashboard
  shell: nft list chain inet ansible input 2>/dev/null || echo "chain not found"
  register: user_dash_nft_chain
  failed_when: false
  changed_when: false
  become: true
  when: nft_available.rc == 0

- name: Create nftables chain for dashboard when missing
  shell: 'nft add chain inet ansible input "{ type filter hook input priority 0; policy accept; }" 2>/dev/null || true'
  when: 
    - nft_available.rc == 0
    - "'chain not found' in user_dash_nft_chain.stdout"
  become: true
  ignore_errors: true

- name: Add firewall rule for dashboard port (if nftables available)
  shell: |
    if command -v nft >/dev/null 2>&1; then
      nft add rule inet ansible input tcp dport 8080 counter accept 2>/dev/null || true
    elif command -v ufw >/dev/null 2>&1; then
      ufw allow 8080/tcp || true
    elif command -v iptables >/dev/null 2>&1; then
      iptables -A INPUT -p tcp --dport 8080 -j ACCEPT || true
    fi
  become: true
  ignore_errors: true

- name: Enumerate dashboard artifacts
  find:
    paths: /tmp/user_security_dashboard
    file_type: file
  register: dashboard_artifacts
  become: true

- name: Fetch dashboard artifacts
  fetch:
    src: "{{ item.path }}"
    dest: "./evidence/gestion-seguridad/{{ inventory_hostname }}/"
    flat: true
  loop: "{{ dashboard_artifacts.files }}"
  become: true
  ignore_errors: true
  when: dashboard_artifacts.files is defined

- name: Show summary
  debug:
    msg:
      - "Evidencias descargadas en evidence/gestion-seguridad/{{ inventory_hostname }}"
      - "Incluye SEGURIDAD_DASHBOARD.md y archivos fuente"
      - "Dashboard visual en puerto 8080"
