# Linux workflow for user-security-dashboard
- name: Ensure remote dashboard directory exists
  file:
    path: /tmp/user_security_dashboard
    state: directory
    mode: '0750'
  become: yes

- name: Capture local users with login shell
  shell: |
    {
      echo "# Usuarios con shell v√°lido";
      printf "%-18s %-6s %-6s %-25s %-20s\n" "USUARIO" "UID" "GID" "DIRECTORIO" "SHELL";
      getent passwd | awk -F: '$7 ~ /(bash|sh|zsh)$/{printf "%-18s %-6s %-6s %-25s %-20s\n", $1, $3, $4, $6, $7}' | sort;
    } > /tmp/user_security_dashboard/01_usuarios.txt
  become: yes

- name: Capture key groups
  shell: |
    {
      echo "# Grupos cr√≠ticos";
      getent group alumnos profesores lab-admins operator sudo 2>/dev/null;
    } > /tmp/user_security_dashboard/02_grupos.txt
  failed_when: false
  become: yes

- name: Capture password policy details
  shell: |
    {
      echo "# Pol√≠tica de contrase√±as";
      for usr in academico operator admin {{ vault_ansible_user | default('ansible') }}; do
        chage -l "$usr" 2>/dev/null && echo "";
      done;
      echo "# /etc/login.defs";
      egrep 'PASS_(MIN|MAX|WARN)' /etc/login.defs;
    } > /tmp/user_security_dashboard/03_politica_contrasenas.txt
  failed_when: false
  become: yes

- name: Capture sudo policies
  shell: |
    {
      echo "# sudoers.d";
      ls /etc/sudoers.d 2>/dev/null || true;
      echo "";
      for file in /etc/sudoers.d/*; do
        [ -e "$file" ] || continue;
        echo "## $file";
        cat "$file";
        echo "";
      done;
    } > /tmp/user_security_dashboard/04_sudo_policies.txt
  become: yes

- name: Capture ACLs for evidence repository
  shell: |
    getfacl -p /srv/evidence 2>/dev/null > /tmp/user_security_dashboard/05_acl_evidence.txt || true
  failed_when: false
  become: yes

- name: Capture audit rules related to identity
  shell: |
    auditctl -l 2>/dev/null | egrep '(identity|sudo|sshd)' > /tmp/user_security_dashboard/06_audit_rules.txt || true
  failed_when: false
  become: yes

- name: Build markdown dashboard
  shell: |
    cat <<EOF > /tmp/user_security_dashboard/SEGURIDAD_DASHBOARD.md
    # Dashboard de Seguridad por Usuario

    ## 1. Usuarios con Shell Activo
    
    ```text
    $(cat /tmp/user_security_dashboard/01_usuarios.txt)
    ```
    
    ## 2. Grupos Cr√≠ticos
    
    ```text
    $(cat /tmp/user_security_dashboard/02_grupos.txt)
    ```
    
    ## 3. Pol√≠ticas de Contrase√±a
    
    ```text
    $(cat /tmp/user_security_dashboard/03_politica_contrasenas.txt)
    ```
    
    ## 4. Reglas sudoers Delegadas
    
    ```text
    $(cat /tmp/user_security_dashboard/04_sudo_policies.txt)
    ```
    
    ## 5. Permisos y ACLs sobre Evidencias
    
    ```text
    $(cat /tmp/user_security_dashboard/05_acl_evidence.txt)
    ```
    
    ## 6. Auditor√≠a Activa
    
    ```text
    $(cat /tmp/user_security_dashboard/06_audit_rules.txt)
    ```
    EOF
  become: yes

- name: Load usuarios section
  slurp:
    src: /tmp/user_security_dashboard/01_usuarios.txt
  register: usuarios_raw
  become: yes

- name: Load grupos section
  slurp:
    src: /tmp/user_security_dashboard/02_grupos.txt
  register: grupos_raw
  become: yes

- name: Load contrase√±as section
  slurp:
    src: /tmp/user_security_dashboard/03_politica_contrasenas.txt
  register: contrasenas_raw
  become: yes

- name: Load sudo section
  slurp:
    src: /tmp/user_security_dashboard/04_sudo_policies.txt
  register: sudo_raw
  become: yes

- name: Load ACL section
  slurp:
    src: /tmp/user_security_dashboard/05_acl_evidence.txt
  register: acl_raw
  become: yes

- name: Load audit section
  slurp:
    src: /tmp/user_security_dashboard/06_audit_rules.txt
  register: audit_raw
  become: yes

- name: Ensure dashboard web root exists
  file:
    path: "{{ security_dashboard_site_dir }}"
    state: directory
    mode: '0755'
  become: yes

- name: Publish HTML dashboard
  template:
    src: security_dashboard.html.j2
    dest: "{{ security_dashboard_site_dir }}/index.html"
    mode: '0644'
  become: yes

- name: Install systemd service for dashboard
  template:
    src: security-dashboard.service.j2
    dest: "/etc/systemd/system/{{ security_dashboard_service_name }}.service"
    mode: '0644'
  become: yes

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes

- name: Ensure dashboard service is running
  systemd:
    name: "{{ security_dashboard_service_name }}"
    state: restarted
    enabled: yes
  become: yes

- name: Check nftables table for dashboard
  command:
    argv:
      - nft
      - list
      - table
      - inet
      - ansible
  register: user_dash_nft_table
  failed_when: false
  changed_when: false
  become: yes

- name: Create nftables table for dashboard when missing
  command:
    argv:
      - nft
      - add
      - table
      - inet
      - ansible
  when: user_dash_nft_table.rc != 0
  become: yes

- name: Check nftables chain for dashboard
  command:
    argv:
      - nft
      - list
      - chain
      - inet
      - ansible
      - input
  register: user_dash_nft_chain
  failed_when: false
  changed_when: false
  become: yes

- name: Create nftables chain for dashboard when missing
  command:
    argv:
      - nft
      - add
      - chain
      - inet
      - ansible
      - input
      - '{ type filter hook input priority 0; policy drop; }'
  when: user_dash_nft_chain.rc != 0
  become: yes

- name: Check firewall rule for dashboard port
  shell: "nft list chain inet ansible input | grep -q 'tcp dport {{ security_dashboard_port }}'"
  register: user_dash_rule
  failed_when: false
  changed_when: false
  become: yes

- name: Add firewall rule for dashboard port
  command:
    argv:
      - nft
      - add
      - rule
      - inet
      - ansible
      - input
      - tcp
      - dport
      - "{{ security_dashboard_port }}"
      - counter
      - accept
  when: user_dash_rule.rc != 0
  become: yes

- name: Enumerate dashboard artifacts
  find:
    paths: /tmp/user_security_dashboard
    file_type: file
  register: dashboard_artifacts
  become: yes

- name: Fetch dashboard artifacts
  fetch:
    src: "{{ item.path }}"
    dest: "{{ (playbook_dir | dirname) + '/evidence/gestion-seguridad/' + inventory_hostname + '/' }}"
    flat: yes
  loop: "{{ dashboard_artifacts.files }}"
  become: yes

- name: Show summary
  debug:
    msg:
      - "üìÅ Evidencias descargadas en evidence/gestion-seguridad/{{ inventory_hostname }}"
      - "Incluye SEGURIDAD_DASHBOARD.md y archivos fuente (users, groups, sudo, ACL, audit)"
      - "üåê Dashboard visual: http://{{ ansible_host | default(inventory_hostname) }}:{{ security_dashboard_port }}"
