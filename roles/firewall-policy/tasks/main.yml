---
# Role: firewall-policy
# Descripción: Configuración de firewall asimétrico con firewalld
# Reglas: 2025:db8:100::/64 → 2025:db8:101::/64 ✅ | 2025:db8:101::/64 → 2025:db8:100::/64 ❌

- name: Instalar firewalld
  package:
    name: firewalld
    state: present
  become: yes

- name: Habilitar y iniciar firewalld
  systemd:
    name: firewalld
    enabled: yes
    state: started
  become: yes

- name: Configurar zona internal (Red Fernandez - 2025:db8:101::/64)
  firewalld:
    zone: internal
    source: "2025:db8:101::/64"
    permanent: yes
    immediate: yes
    state: enabled
  become: yes
  notify: reload firewalld

- name: Configurar zona external (Red Laboratorio - 2025:db8:100::/64)
  firewalld:
    zone: external
    source: "2025:db8:100::/64"
    permanent: yes
    immediate: yes
    state: enabled
  become: yes
  notify: reload firewalld

- name: Permitir servicios básicos en zona internal
  firewalld:
    zone: internal
    service: "{{ item }}"
    permanent: yes
    immediate: yes
    state: enabled
  loop:
    - ssh
    - http
    - https
    - ftp
    - dhcpv6-client
    - dhcpv6
  become: yes
  notify: reload firewalld

- name: Permitir servicios limitados en zona external
  firewalld:
    zone: external
    service: "{{ item }}"
    permanent: yes
    immediate: yes
    state: enabled
  loop:
    - ssh
    - dhcpv6-client
  become: yes
  notify: reload firewalld

- name: Configurar regla asimétrica - Permitir external → internal
  firewalld:
    zone: internal
    rich_rule: 'rule family="ipv6" source address="2025:db8:100::/64" accept'
    permanent: yes
    immediate: yes
    state: enabled
  become: yes
  notify: reload firewalld

- name: Configurar regla asimétrica - Bloquear internal → external (nuevas conexiones)
  firewalld:
    zone: external
    rich_rule: 'rule family="ipv6" source address="2025:db8:101::/64" drop'
    permanent: yes
    immediate: yes
    state: enabled
  become: yes
  notify: reload firewalld

- name: Permitir tráfico establecido y relacionado
  firewalld:
    zone: external
    rich_rule: 'rule family="ipv6" source address="2025:db8:101::/64" connection-tracking state="established,related" accept'
    permanent: yes
    immediate: yes
    state: enabled
  become: yes
  notify: reload firewalld

- name: Configurar interfaz LAN en zona internal
  firewalld:
    zone: internal
    interface: "{{ lan_interface }}"
    permanent: yes
    immediate: yes
    state: enabled
  become: yes
  notify: reload firewalld

- name: Configurar interfaz WAN en zona external
  firewalld:
    zone: external
    interface: "{{ wan_interface }}"
    permanent: yes
    immediate: yes
    state: enabled
  become: yes
  notify: reload firewalld
  when: wan_interface is defined

- name: Habilitar IPv6 forwarding en firewalld
  firewalld:
    permanent: yes
    immediate: yes
    state: enabled
    ipv6_forwarding: yes
  become: yes
  notify: reload firewalld

- name: Verificar estado del firewall
  command: firewall-cmd --state
  register: firewall_state
  changed_when: false

- name: Mostrar zonas activas
  command: firewall-cmd --get-active-zones
  register: active_zones
  changed_when: false

- name: Mostrar reglas de zona internal
  command: firewall-cmd --zone=internal --list-all
  register: internal_rules
  changed_when: false

- name: Mostrar reglas de zona external
  command: firewall-cmd --zone=external --list-all
  register: external_rules
  changed_when: false

- name: Resumen de configuración de firewall
  debug:
    msg:
      - "=========================================="
      - "✅ Firewall configurado con reglas asimétricas"
      - "Estado: {{ firewall_state.stdout }}"
      - ""
      - "Zonas activas:"
      - "{{ active_zones.stdout }}"
      - ""
      - "Reglas aplicadas:"
      - "✅ 2025:db8:100::/64 → 2025:db8:101::/64 (PERMITIDO)"
      - "❌ 2025:db8:101::/64 → 2025:db8:100::/64 (BLOQUEADO - nuevas conexiones)"
      - "✅ Respuestas establecidas/relacionadas (PERMITIDO)"
      - "=========================================="

- name: Guardar configuración de firewall
  shell: |
    echo "=== Firewall State ===" > /tmp/firewall_config.txt
    firewall-cmd --state >> /tmp/firewall_config.txt
    echo "" >> /tmp/firewall_config.txt
    echo "=== Active Zones ===" >> /tmp/firewall_config.txt
    firewall-cmd --get-active-zones >> /tmp/firewall_config.txt
    echo "" >> /tmp/firewall_config.txt
    echo "=== Internal Zone Rules ===" >> /tmp/firewall_config.txt
    firewall-cmd --zone=internal --list-all >> /tmp/firewall_config.txt
    echo "" >> /tmp/firewall_config.txt
    echo "=== External Zone Rules ===" >> /tmp/firewall_config.txt
    firewall-cmd --zone=external --list-all >> /tmp/firewall_config.txt
  register: firewall_config
  changed_when: false

- name: Copiar configuración de firewall a evidencias
  fetch:
    src: /tmp/firewall_config.txt
    dest: "evidence/configs/{{ inventory_hostname }}_firewall_config.txt"
    flat: yes