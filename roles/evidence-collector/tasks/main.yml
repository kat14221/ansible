---
# Role: evidence-collector
# Descripción: Recolecta evidencias de configuración y estado de todos los hosts

- name: Crear directorios de evidencias
  file:
    path: "evidence/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - configs
    - pings
    - pcaps
    - services
    - reports
    - logs
    - technical_reports
  delegate_to: localhost
  run_once: true

- name: Recolectar información de red (Linux)
  block:
    - name: Obtener configuración IPv6
      shell: |
        echo "=== IPv6 Addresses ===" > /tmp/network_info.txt
        ip -6 addr show >> /tmp/network_info.txt
        echo "" >> /tmp/network_info.txt
        echo "=== IPv6 Routes ===" >> /tmp/network_info.txt
        ip -6 route show >> /tmp/network_info.txt
        echo "" >> /tmp/network_info.txt
        echo "=== Network Interfaces ===" >> /tmp/network_info.txt
        ip link show >> /tmp/network_info.txt
        echo "" >> /tmp/network_info.txt
        echo "=== Routing Table ===" >> /tmp/network_info.txt
        route -n >> /tmp/network_info.txt 2>/dev/null || ip route show >> /tmp/network_info.txt
      register: network_info
      changed_when: false

    - name: Obtener estado de servicios
      shell: |
        echo "=== Systemd Services ===" > /tmp/services_info.txt
        systemctl list-units --type=service --state=running >> /tmp/services_info.txt
        echo "" >> /tmp/services_info.txt
        echo "=== Network Services ===" >> /tmp/services_info.txt
        for service in radvd isc-dhcp-server apache2 vsftpd dnsmasq; do
          echo "--- $service ---" >> /tmp/services_info.txt
          systemctl status $service --no-pager -l >> /tmp/services_info.txt 2>/dev/null || echo "Service $service not found" >> /tmp/services_info.txt
          echo "" >> /tmp/services_info.txt
        done
      register: services_info
      changed_when: false

    - name: Copiar información de red
      fetch:
        src: /tmp/network_info.txt
        dest: "evidence/configs/{{ inventory_hostname }}_network_info.txt"
        flat: yes

    - name: Copiar información de servicios
      fetch:
        src: /tmp/services_info.txt
        dest: "evidence/services/{{ inventory_hostname }}_services_info.txt"
        flat: yes

  when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"

- name: Recolectar información de red (Cisco IOS)
  block:
    - name: Obtener running-config
      cisco.ios.ios_command:
        commands: show running-config
      register: running_config

    - name: Obtener información IPv6
      cisco.ios.ios_command:
        commands:
          - show ipv6 interface brief
          - show ipv6 route
          - show interface status
          - show version
      register: ipv6_info

    - name: Guardar running-config
      copy:
        content: "{{ running_config.stdout[0] }}"
        dest: "evidence/configs/{{ inventory_hostname }}_running_config.txt"
      delegate_to: localhost

    - name: Guardar información IPv6
      copy:
        content: |
          === IPv6 Interfaces ===
          {{ ipv6_info.stdout[0] }}

          === IPv6 Routes ===
          {{ ipv6_info.stdout[1] }}

          === Interface Status ===
          {{ ipv6_info.stdout[2] }}

          === Version ===
          {{ ipv6_info.stdout[3] }}
        dest: "evidence/configs/{{ inventory_hostname }}_ipv6_info.txt"
      delegate_to: localhost

  when: ansible_network_os is defined and ansible_network_os == "ios"

- name: Recolectar información de Windows
  block:
    - name: Obtener configuración de red IPv6
      win_shell: |
        Write-Output "=== IPv6 Configuration ==="
        Get-NetIPAddress -AddressFamily IPv6 | Format-Table -AutoSize
        Write-Output ""
        Write-Output "=== IPv6 Routes ==="
        Get-NetRoute -AddressFamily IPv6 | Format-Table -AutoSize
        Write-Output ""
        Write-Output "=== Network Adapters ==="
        Get-NetAdapter | Format-Table -AutoSize
      register: windows_network_info

    - name: Guardar información de red Windows
      copy:
        content: "{{ windows_network_info.stdout }}"
        dest: "evidence/configs/{{ inventory_hostname }}_network_info.txt"
      delegate_to: localhost

  when: ansible_os_family == "Windows"

- name: Generar reporte JSON por host
  copy:
    content: |
      {
        "hostname": "{{ inventory_hostname }}",
        "ansible_host": "{{ ansible_host | default('N/A') }}",
        "os_family": "{{ ansible_os_family | default('Unknown') }}",
        "architecture": "{{ ansible_architecture | default('Unknown') }}",
        "distribution": "{{ ansible_distribution | default('N/A') }}",
        "distribution_version": "{{ ansible_distribution_version | default('N/A') }}",
        "kernel": "{{ ansible_kernel | default('N/A') }}",
        "python_version": "{{ ansible_python_version | default('N/A') }}",
        "ipv4_addresses": {{ ansible_all_ipv4_addresses | default([]) | to_json }},
        "ipv6_addresses": {{ ansible_all_ipv6_addresses | default([]) | to_json }},
        "interfaces": {{ ansible_interfaces | default([]) | to_json }},
        "memory_mb": {{ ansible_memtotal_mb | default(0) }},
        "processor_cores": {{ ansible_processor_cores | default(0) }},
        "timestamp": "{{ ansible_date_time.iso8601 }}",
        "evidence_collected": true
      }
    dest: "evidence/reports/{{ inventory_hostname }}_report.json"
  delegate_to: localhost

- name: Limpiar archivos temporales
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/network_info.txt
    - /tmp/services_info.txt
  when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"
  ignore_errors: yes