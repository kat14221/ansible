---
# Role: ios-basic-config
# Descripci√≥n: Configuraci√≥n TEMPORAL de routers Cisco IOS con IPv6
# IMPORTANTE: NO guarda cambios permanentes (router acad√©mico compartido)

- name: Verificar configuraci√≥n actual (sin guardar)
  debug:
    msg: "Aplicando configuraci√≥n temporal - NO se guardar√°n cambios permanentes"

- name: Configurar hostname (temporal)
  cisco.ios.ios_config:
    lines:
      - "hostname {{ hostname }}"
    save_when: never
  when: hostname is defined

- name: Configurar banner (temporal)
  cisco.ios.ios_config:
    lines:
      - "banner motd # Red Academica IPv6 - VMWARE-101001 - TEMPORAL #"
    save_when: never

- name: Configurar credenciales de usuario (temporal)
  cisco.ios.ios_config:
    lines:
      - username cisco privilege 15 secret cisco123
      - username ansible privilege 15 secret Ansible123!
    save_when: never

- name: Configurar l√≠nea de consola (temporal)
  cisco.ios.ios_config:
    lines:
      - login local
    parents: line console 0
    save_when: never

- name: Configurar l√≠neas VTY (temporal)
  cisco.ios.ios_config:
    lines:
      - login local
      - transport input ssh
    parents: line vty 0 4
    save_when: never

- name: Configurar dominio (omitido - ya configurado)
  debug:
    msg: "Dominio ya configurado en el router"

- name: Generar llaves RSA para SSH (omitido - ya configurado)
  debug:
    msg: "SSH ya configurado en el router"

- name: Habilitar IPv6 unicast routing (temporal)
  cisco.ios.ios_config:
    lines:
      - ipv6 unicast-routing
    save_when: never
  ignore_errors: yes

- name: Configurar interfaces de router (temporal)
  cisco.ios.ios_config:
    lines:
      - "description {{ item.value.description }}"
      - "ipv6 address {{ item.value.ipv6_address }}/{{ item.value.ipv6_prefix }}"
      - ipv6 enable
      - no shutdown
    parents: "interface {{ item.key }}"
    save_when: never
  loop: "{{ physical_router_interfaces | dict2items }}"
  when: physical_router_interfaces is defined

- name: Configuraci√≥n de switch omitida (solo para routers)
  debug:
    msg: "Configuraci√≥n de switch no aplicable para router f√≠sico"
  when: inventory_hostname == "physical-router"

- name: Configuraci√≥n NO guardada (router acad√©mico compartido)
  debug:
    msg: "IMPORTANTE: Configuraci√≥n temporal aplicada - NO se guardan cambios permanentes"

- name: Obtener configuraci√≥n running
  cisco.ios.ios_command:
    commands: show running-config
  register: running_config

- name: Crear directorio de evidencias
  file:
    path: "{{ playbook_dir }}/evidence/configs"
    state: directory
    mode: '0755'
  delegate_to: localhost
  run_once: true
  become: no

- name: Guardar running-config (evidencia acad√©mica)
  copy:
    content: "{{ running_config.stdout[0] }}"
    dest: "{{ playbook_dir }}/evidence/configs/{{ inventory_hostname }}_running_config.txt"
    mode: '0644'
  delegate_to: localhost
  when: running_config is defined and running_config.stdout is defined
  become: no

- name: Obtener informaci√≥n de interfaces IPv6
  cisco.ios.ios_command:
    commands:
      - show ipv6 interface brief
      - show ipv6 route
  register: ipv6_info

- name: Guardar informaci√≥n IPv6 (evidencia acad√©mica)
  copy:
    content: |
      === IPv6 Interfaces ===
      {{ ipv6_info.stdout[0] if ipv6_info.stdout is defined and ipv6_info.stdout|length > 0 else 'No disponible' }}

      === IPv6 Routes ===
      {{ ipv6_info.stdout[1] if ipv6_info.stdout is defined and ipv6_info.stdout|length > 1 else 'No disponible' }}
    dest: "{{ playbook_dir }}/evidence/configs/{{ inventory_hostname }}_ipv6_info.txt"
    mode: '0644'
  delegate_to: localhost
  when: ipv6_info is defined
  become: no

- name: Mostrar resumen
  debug:
    msg:
      - "=========================================="
      - "‚úÖ Configuraci√≥n TEMPORAL aplicada a {{ hostname if hostname is defined else inventory_hostname }}"
      - "‚ö†Ô∏è  IMPORTANTE: Cambios NO guardados permanentemente"
      - "‚ö†Ô∏è  Router acad√©mico compartido - configuraci√≥n temporal"
      - "‚úÖ IPv6 unicast routing: habilitado temporalmente"
      - "‚úÖ Interfaces IPv6: configuradas temporalmente"
      - "üìÅ Evidencias guardadas en: evidence/configs/"
      - "=========================================="