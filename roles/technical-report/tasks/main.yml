---
# Role: technical-report
# Descripción: Genera informes técnicos HTML detallados

- name: Crear directorio de informes técnicos
  file:
    path: "evidence/technical_reports"
    state: directory
    mode: '0755'
  delegate_to: localhost
  run_once: true

- name: Generar informe técnico por host
  template:
    src: technical_report.html.j2
    dest: "evidence/technical_reports/{{ inventory_hostname }}_technical_report.html"
    mode: '0644'
  delegate_to: localhost

- name: Recopilar información del sistema (Linux)
  block:
    - name: Obtener información detallada del sistema
      setup:
        gather_subset: all

    - name: Obtener información de procesos
      shell: |
        ps aux --sort=-%cpu | head -20 > /tmp/top_processes.txt
        df -h > /tmp/disk_usage.txt
        free -h > /tmp/memory_usage.txt
        uptime > /tmp/uptime.txt
        who > /tmp/logged_users.txt
        last -n 10 > /tmp/last_logins.txt
      register: system_info
      changed_when: false

    - name: Obtener información de red detallada
      shell: |
        ss -tuln > /tmp/listening_ports.txt
        netstat -rn > /tmp/routing_table.txt 2>/dev/null || ip route show > /tmp/routing_table.txt
        iptables -L -n > /tmp/iptables_rules.txt 2>/dev/null || echo "iptables not available" > /tmp/iptables_rules.txt
      register: network_info
      changed_when: false

    - name: Obtener logs del sistema
      shell: |
        journalctl --since "1 hour ago" --no-pager | tail -50 > /tmp/recent_logs.txt
        dmesg | tail -20 > /tmp/kernel_messages.txt
      register: logs_info
      changed_when: false
      ignore_errors: yes

  when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"

- name: Recopilar información de Cisco IOS
  block:
    - name: Obtener información detallada del dispositivo
      cisco.ios.ios_command:
        commands:
          - show version
          - show interfaces
          - show ip interface brief
          - show ipv6 interface brief
          - show running-config
          - show processes cpu
          - show memory
          - show environment
      register: ios_detailed_info

    - name: Guardar información detallada de IOS
      copy:
        content: |
          === SHOW VERSION ===
          {{ ios_detailed_info.stdout[0] }}

          === SHOW INTERFACES ===
          {{ ios_detailed_info.stdout[1] }}

          === SHOW IP INTERFACE BRIEF ===
          {{ ios_detailed_info.stdout[2] }}

          === SHOW IPV6 INTERFACE BRIEF ===
          {{ ios_detailed_info.stdout[3] }}

          === SHOW PROCESSES CPU ===
          {{ ios_detailed_info.stdout[5] }}

          === SHOW MEMORY ===
          {{ ios_detailed_info.stdout[6] }}

          === SHOW ENVIRONMENT ===
          {{ ios_detailed_info.stdout[7] }}
        dest: "/tmp/ios_detailed_info.txt"
      delegate_to: localhost

  when: ansible_network_os is defined and ansible_network_os == "ios"

- name: Generar índice de informes
  template:
    src: index.html.j2
    dest: "evidence/technical_reports/index.html"
    mode: '0644'
  delegate_to: localhost
  run_once: true

- name: Generar informe consolidado
  template:
    src: consolidated_report.html.j2
    dest: "evidence/technical_reports/consolidated_report.html"
    mode: '0644'
  delegate_to: localhost
  run_once: true

- name: Mostrar ubicación de informes
  debug:
    msg:
      - "=========================================="
      - "✅ Informes técnicos generados"
      - ""
      - "Ubicación: evidence/technical_reports/"
      - "  • {{ inventory_hostname }}_technical_report.html"
      - "  • index.html (índice principal)"
      - "  • consolidated_report.html (informe consolidado)"
      - ""
      - "Abrir con:"
      - "  firefox evidence/technical_reports/index.html"
      - "  xdg-open evidence/technical_reports/index.html"
      - "=========================================="
  run_once: true