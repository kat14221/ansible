---
# Role: shared-folders
# Descripci√≥n: Configuraci√≥n de carpetas compartidas con Samba

- name: Instalar Samba
  package:
    name:
      - samba
      - samba-common-bin
    state: present
  become: yes

- name: Crear directorio de carpetas compartidas
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ vault_ansible_user }}"
    group: "{{ vault_ansible_user }}"
  loop:
    - /srv/samba/reports
    - /srv/samba/evidence
    - /srv/samba/public
  become: yes

- name: Copiar evidencias a carpeta compartida
  shell: |
    cp -r evidence/* /srv/samba/evidence/ 2>/dev/null || true
    cp -r evidence/technical_reports/* /srv/samba/reports/ 2>/dev/null || true
    chown -R {{ vault_ansible_user }}:{{ vault_ansible_user }} /srv/samba/
  become: yes
  ignore_errors: yes

- name: Configurar Samba
  copy:
    dest: /etc/samba/smb.conf
    mode: '0644'
    content: |
      [global]
      workgroup = WORKGROUP
      server string = {{ inventory_hostname }} - VMWARE-101001
      netbios name = {{ inventory_hostname | upper }}
      security = user
      map to guest = bad user
      dns proxy = no
      
      # IPv6 support
      bind interfaces only = yes
      interfaces = lo {{ lan_interface | default('eth0') }}
      
      # Logging
      log file = /var/log/samba/log.%m
      max log size = 1000
      
      # Performance
      socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=131072 SO_SNDBUF=131072
      
      [reports]
      comment = Technical Reports - VMWARE-101001
      path = /srv/samba/reports
      browseable = yes
      read only = yes
      guest ok = yes
      create mask = 0644
      directory mask = 0755
      
      [evidence]
      comment = Evidence Files - VMWARE-101001
      path = /srv/samba/evidence
      browseable = yes
      read only = yes
      guest ok = yes
      create mask = 0644
      directory mask = 0755
      
      [public]
      comment = Public Share - VMWARE-101001
      path = /srv/samba/public
      browseable = yes
      read only = no
      guest ok = yes
      create mask = 0664
      directory mask = 0775
  become: yes
  notify: restart samba

- name: Crear usuario Samba
  shell: |
    (echo "{{ vault_ftp_password }}"; echo "{{ vault_ftp_password }}") | smbpasswd -a {{ vault_ansible_user }}
    smbpasswd -e {{ vault_ansible_user }}
  become: yes
  ignore_errors: yes

- name: Habilitar y iniciar servicios Samba
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - smbd
    - nmbd
  become: yes

- name: Configurar firewall para Samba
  firewalld:
    service: samba
    permanent: yes
    immediate: yes
    state: enabled
    zone: internal
  become: yes
  ignore_errors: yes

- name: Verificar estado de Samba
  command: systemctl status smbd --no-pager
  register: samba_status
  changed_when: false

- name: Mostrar informaci√≥n de carpetas compartidas
  debug:
    msg:
      - "=========================================="
      - "‚úÖ Carpetas compartidas configuradas"
      - "Estado Samba: {{ 'OK' if samba_status.rc == 0 else 'Verificar manualmente' }}"
      - ""
      - "Acceso desde Windows:"
      - "  \\\\{{ ansible_host }}\\reports"
      - "  \\\\{{ ansible_host }}\\evidence"
      - "  \\\\{{ ansible_host }}\\public"
      - ""
      - "Acceso desde Linux:"
      - "  smb://{{ ansible_host }}/reports"
      - "  smb://{{ ansible_host }}/evidence"
      - "  smb://{{ ansible_host }}/public"
      - ""
      - "Usuario: {{ vault_ansible_user }}"
      - "Contrase√±a: (configurada en vault)"
      - "=========================================="

- name: Crear archivo de informaci√≥n de acceso
  copy:
    dest: /srv/samba/public/ACCESO_CARPETAS_COMPARTIDAS.txt
    mode: '0644'
    content: |
      ================================================================================
                          CARPETAS COMPARTIDAS - VMWARE-101001
      ================================================================================
      
      Host: {{ inventory_hostname }}
      IP: {{ ansible_host }}
      Fecha: {{ ansible_date_time.iso8601 }}
      
      CARPETAS DISPONIBLES:
      
      üìä /reports - Informes T√©cnicos
         Contiene: Informes HTML generados autom√°ticamente
         Acceso: Solo lectura, sin autenticaci√≥n
         
      üìÅ /evidence - Evidencias del Proyecto  
         Contiene: Configuraciones, logs, capturas de tr√°fico
         Acceso: Solo lectura, sin autenticaci√≥n
         
      üìÇ /public - Carpeta P√∫blica
         Contiene: Archivos compartidos
         Acceso: Lectura/escritura, sin autenticaci√≥n
      
      ACCESO DESDE WINDOWS:
         \\{{ ansible_host }}\reports
         \\{{ ansible_host }}\evidence  
         \\{{ ansible_host }}\public
      
      ACCESO DESDE LINUX:
         smb://{{ ansible_host }}/reports
         smb://{{ ansible_host }}/evidence
         smb://{{ ansible_host }}/public
      
      NAVEGADOR WEB (para informes):
         http://{{ ansible_host }}/reports/
         
      ================================================================================
    owner: "{{ vault_ansible_user }}"
    group: "{{ vault_ansible_user }}"
  become: yes