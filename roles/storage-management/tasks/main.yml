---
# Role: storage-management
# Descripción: Gestión avanzada de almacenamiento y sistemas de archivos

- name: Instalar herramientas de gestión de almacenamiento
  package:
    name:
      - quota
      - fdupes
      - ncdu
      - tree
    state: present
  become: yes

# ========================================
# ESTRUCTURA DE DIRECTORIOS
# ========================================
- name: Crear estructura de directorios organizada
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
  loop:
    - { path: '/backup', mode: '0755', owner: 'root', group: 'root' }
    - { path: '/backup/configs', mode: '0755', owner: 'root', group: 'root' }
    - { path: '/srv/ftp', mode: '0755', owner: 'ftp', group: 'ftp' }
    - { path: '/srv/www', mode: '0755', owner: 'www-data', group: 'www-data' }
    - { path: '/srv/alumnos', mode: '0770', owner: 'root', group: 'alumnos' }
    - { path: '/srv/profesores', mode: '0770', owner: 'root', group: 'profesores' }
    - { path: '/var/log/storage', mode: '0755', owner: 'root', group: 'root' }
  become: yes

# ========================================
# OPTIMIZACIÓN DE FSTAB
# ========================================
- name: Verificar opciones de montaje en fstab
  shell: grep -E "noatime|relatime" /etc/fstab || echo "No optimizado"
  register: fstab_check
  changed_when: false

- name: Informar sobre optimización de fstab
  debug:
    msg:
      - "Verificar /etc/fstab manualmente para agregar 'noatime' si no está presente"
      - "Esto reduce escrituras innecesarias y mejora rendimiento"
  when: "'No optimizado' in fstab_check.stdout"

# ========================================
# CUOTAS DE DISCO
# ========================================
# ========================================
# CONFIGURACIÓN DE CUOTAS DE DISCO
# ========================================
- name: Verificar si cuotas están habilitadas en fstab
  shell: grep -E "usrquota|grpquota" /etc/fstab || echo "No configurado"
  register: fstab_quota_check
  changed_when: false

- name: Obtener dispositivo raíz
  shell: df / | tail -1 | awk '{print $1}'
  register: root_device
  changed_when: false

- name: Configurar cuotas en fstab si no están configuradas
  shell: |
    # Hacer backup de fstab
    cp /etc/fstab /etc/fstab.backup.$(date +%Y%m%d_%H%M%S)
    
    # Agregar opciones de cuota a la partición raíz
    sed -i 's|\({{ root_device.stdout }}.*defaults\)|\1,usrquota,grpquota|' /etc/fstab
  become: yes
  when: "'No configurado' in fstab_quota_check.stdout"

- name: Remontar sistema de archivos con cuotas
  shell: mount -o remount /
  become: yes
  when: "'No configurado' in fstab_quota_check.stdout"
  ignore_errors: yes

- name: Crear archivos de base de datos de cuotas
  shell: |
    quotaoff -a
    quotacheck -cugm /
    quotaon -a
  become: yes
  ignore_errors: yes

- name: Verificar si cuotas están activas
  shell: quotaon -p / 2>&1
  register: quota_status
  changed_when: false
  ignore_errors: yes

- name: Configurar cuotas para alumnos
  shell: |
    if id {{ item }} &>/dev/null; then
      setquota -u {{ item }} 512000 614400 0 0 -a 2>/dev/null || true
    fi
  loop:
    - alumno1
    - alumno2
    - alumno3
  become: yes
  when: "'is on' in quota_status.stdout or 'user quota turned on' in quota_status.stdout"
  ignore_errors: yes

- name: Configurar cuotas para profesores
  shell: |
    if id {{ item }} &>/dev/null; then
      setquota -u {{ item }} 1024000 1228800 0 0 -a 2>/dev/null || true
    fi
  loop:
    - profesor1
    - profesor2
  become: yes
  when: "'is on' in quota_status.stdout or 'user quota turned on' in quota_status.stdout"
  ignore_errors: yes

- name: Configurar cuotas por grupo
  shell: |
    if getent group alumnos &>/dev/null; then
      setquota -g alumnos 2048000 2560000 0 0 -a 2>/dev/null || true
    fi
    if getent group profesores &>/dev/null; then
      setquota -g profesores 5120000 6144000 0 0 -a 2>/dev/null || true
    fi
  become: yes
  when: "'is on' in quota_status.stdout or 'user quota turned on' in quota_status.stdout"
  ignore_errors: yes

- name: Mostrar estado de cuotas
  debug:
    msg:
      - "Estado de cuotas: {{ quota_status.stdout }}"
      - "Si las cuotas no están activas, puede ser necesario reiniciar el sistema"
      - "Comando para verificar: sudo repquota -a"

# ========================================
# SCRIPT DE MONITOREO DE ESPACIO
# ========================================
- name: Crear script de monitoreo de espacio
  copy:
    dest: /usr/local/bin/monitor_disk_space.sh
    mode: '0755'
    content: |
      #!/bin/bash
      # Script de monitoreo de espacio en disco
      # Proyecto: VMWARE-101001
      
      LOG_FILE="/var/log/storage/disk_monitor.log"
      THRESHOLD=80
      
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] Disk usage check started" >> $LOG_FILE
      
      # Verificar uso de cada partición
      df -h | grep "^/dev" | while read line; do
        PARTITION=$(echo $line | awk '{print $1}')
        MOUNTPOINT=$(echo $line | awk '{print $6}')
        USAGE=$(echo $line | awk '{print $5}' | sed 's/%//')
        
        if [ $USAGE -ge $THRESHOLD ]; then
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] WARNING: $MOUNTPOINT is ${USAGE}% full" >> $LOG_FILE
        else
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] $MOUNTPOINT: ${USAGE}% used (OK)" >> $LOG_FILE
        fi
      done
      
      # Identificar archivos grandes
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] Largest files:" >> $LOG_FILE
      find / -type f -size +100M 2>/dev/null | head -10 | while read file; do
        SIZE=$(du -h "$file" | cut -f1)
        echo "[$(date '+%Y-%m-%d %H:%M:%S')]   $SIZE $file" >> $LOG_FILE
      done
      
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] Disk usage check completed" >> $LOG_FILE
      echo "" >> $LOG_FILE
  become: yes

# ========================================
# SCRIPT DE LIMPIEZA DE TEMPORALES
# ========================================
- name: Crear script de limpieza de temporales
  copy:
    dest: /usr/local/bin/cleanup_temp.sh
    mode: '0755'
    content: |
      #!/bin/bash
      # Script de limpieza de archivos temporales
      # Proyecto: VMWARE-101001
      
      LOG_FILE="/var/log/storage/cleanup.log"
      
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] Cleanup started" >> $LOG_FILE
      
      # Limpiar /tmp
      TEMP_COUNT=$(find /tmp -type f -mtime +7 2>/dev/null | wc -l)
      find /tmp -type f -mtime +7 -delete 2>/dev/null
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] Removed $TEMP_COUNT files from /tmp" >> $LOG_FILE
      
      # Limpiar cache de paquetes
      if command -v apt-get &> /dev/null; then
        CACHE_BEFORE=$(du -sm /var/cache/apt/archives | cut -f1)
        apt-get clean >> $LOG_FILE 2>&1
        CACHE_AFTER=$(du -sm /var/cache/apt/archives | cut -f1)
        CACHE_FREED=$((CACHE_BEFORE - CACHE_AFTER))
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Freed ${CACHE_FREED}MB from package cache" >> $LOG_FILE
      fi
      
      # Comprimir logs antiguos
      LOG_COUNT=$(find /var/log -name "*.log" -mtime +7 ! -name "*.gz" 2>/dev/null | wc -l)
      find /var/log -name "*.log" -mtime +7 ! -name "*.gz" -exec gzip {} \; 2>/dev/null
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] Compressed $LOG_COUNT old log files" >> $LOG_FILE
      
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] Cleanup completed" >> $LOG_FILE
      echo "" >> $LOG_FILE
  become: yes

# ========================================
# SCRIPT DE ANÁLISIS DE ESPACIO
# ========================================
- name: Crear script de análisis de espacio
  copy:
    dest: /usr/local/bin/analyze_disk_usage.sh
    mode: '0755'
    content: |
      #!/bin/bash
      # Script de análisis de uso de espacio
      # Proyecto: VMWARE-101001
      
      echo "╔════════════════════════════════════════════════════════════╗"
      echo "║          ANÁLISIS DE USO DE ALMACENAMIENTO                 ║"
      echo "╚════════════════════════════════════════════════════════════╝"
      echo ""
      
      echo "=== USO POR PARTICIÓN ==="
      df -h | grep "^/dev"
      echo ""
      
      echo "=== USO DE INODOS ==="
      df -i | grep "^/dev"
      echo ""
      
      echo "=== TOP 10 DIRECTORIOS MÁS GRANDES ==="
      du -sh /* 2>/dev/null | sort -h | tail -10
      echo ""
      
      echo "=== CUOTAS DE USUARIOS ==="
      repquota -a 2>/dev/null || echo "Cuotas no habilitadas"
      echo ""
      
      echo "=== ARCHIVOS GRANDES (>100MB) ==="
      find / -type f -size +100M -exec du -h {} \; 2>/dev/null | sort -h | tail -10
      echo ""
  become: yes

# ========================================
# CONFIGURAR TAREAS CRON
# ========================================
- name: Configurar tarea cron - Monitoreo de espacio
  cron:
    name: "Monitoreo de espacio en disco"
    minute: "0"
    hour: "*"
    job: "/usr/local/bin/monitor_disk_space.sh"
    user: root
  become: yes

- name: Configurar tarea cron - Limpieza de temporales
  cron:
    name: "Limpieza de archivos temporales"
    minute: "0"
    hour: "3"
    weekday: "0"
    job: "/usr/local/bin/cleanup_temp.sh"
    user: root
  become: yes

# ========================================
# VALIDACIÓN
# ========================================
- name: Recopilar información de almacenamiento
  shell: |
    echo "=== Particiones ===" > /tmp/storage_info.txt
    lsblk -f >> /tmp/storage_info.txt
    echo "" >> /tmp/storage_info.txt
    echo "=== Uso de espacio ===" >> /tmp/storage_info.txt
    df -h >> /tmp/storage_info.txt
    echo "" >> /tmp/storage_info.txt
    echo "=== Uso de inodos ===" >> /tmp/storage_info.txt
    df -i >> /tmp/storage_info.txt
    echo "" >> /tmp/storage_info.txt
    echo "=== Puntos de montaje ===" >> /tmp/storage_info.txt
    mount | grep "^/dev" >> /tmp/storage_info.txt
  register: storage_info
  changed_when: false

- name: Mostrar resumen de gestión de almacenamiento
  debug:
    msg:
      - "=========================================="
      - "✅ Gestión de almacenamiento configurada"
      - ""
      - "Estructura de directorios:"
      - "  • /backup/configs - Backups"
      - "  • /srv/ftp - Archivos FTP"
      - "  • /srv/www - Archivos web"
      - "  • /srv/alumnos - Espacio alumnos"
      - "  • /srv/profesores - Espacio profesores"
      - ""
      - "Cuotas configuradas:"
      - "  • Alumnos: 500MB soft, 600MB hard"
      - "  • Profesores: 1GB soft, 1.2GB hard"
      - "  • Grupo alumnos: 2GB soft, 2.5GB hard"
      - "  • Grupo profesores: 5GB soft, 6GB hard"
      - ""
      - "Scripts creados:"
      - "  • /usr/local/bin/monitor_disk_space.sh"
      - "  • /usr/local/bin/cleanup_temp.sh"
      - "  • /usr/local/bin/analyze_disk_usage.sh"
      - ""
      - "Tareas cron:"
      - "  • Monitoreo cada hora"
      - "  • Limpieza semanal (domingos 3:00 AM)"
      - ""
      - "Logs en: /var/log/storage/"
      - "=========================================="
