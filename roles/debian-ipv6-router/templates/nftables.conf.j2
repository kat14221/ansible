#!/usr/sbin/nft -f

# flush ruleset
flush ruleset

# ==============================================================================
# Tabla NAT para enmascarar tráfico desde la red LAN hacia internet (WAN).
# Esto permite que los clientes de la red interna (Red Fernandez) accedan
# a internet a través del debian-router como gateway.
# ==============================================================================
table inet nat {
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        
        # NAT para tráfico desde LAN hacia WAN (acceso a internet)
        oifname "{{ wan_interface }}" masquerade
        
        # NAT para tráfico desde LAN hacia LAN (interno)
        oifname "{{ lan_interface }}" masquerade
    }
    
    chain prerouting {
        type nat hook prerouting priority -100; policy accept;
    }
}

# ==============================================================================
# Tabla principal de filtrado (Firewall)
# ==============================================================================
table inet ansible {
    # --- CADENAS (Chains) ---
    # INPUT: Tráfico destinado al propio router.
    # FORWARD: Tráfico que atraviesa el router (de una red a otra).
    # OUTPUT: Tráfico originado por el propio router.

    chain input {
        type filter hook input priority 0; policy drop;

        # --- Reglas de Aceptación (INPUT) ---
        # 1. Permitir tráfico de conexiones ya establecidas o relacionadas.
        ct state {established, related} accept

        # 2. Permitir tráfico de la interfaz loopback (localhost).
        iifname "lo" accept

        # 3. Permitir ICMPv6 (necesario para el funcionamiento de IPv6, como NDP).
        ip6 nexthdr icmpv6 accept

        # 4. Permitir SSH (puerto 22) para administración.
        tcp dport 22 accept

        # 5. Permitir DHCPv6 (el router es cliente y servidor).
        udp dport {546, 547} accept

        # 6. Permitir FTP (puerto 21) y HTTP (puerto 80) para servicios del laboratorio.
        tcp dport {21, 80} accept

        # 7. Ancla para que otros roles (como network-monitor) puedan añadir reglas aquí.
        # MONITOR-APP-ANCHOR
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        # --- Reglas de Aceptación (FORWARD) ---
        # 1. Permitir tráfico de conexiones ya establecidas o relacionadas.
        ct state {established, related} accept

        # 2. Permitir el reenvío de tráfico desde la LAN hacia la WAN (salida a internet).
        iifname "{{ lan_interface }}" oifname "{{ wan_interface }}" accept

        # 3. Permitir el reenvío desde la WAN a la LAN (respuestas, etc.).
        iifname "{{ wan_interface }}" oifname "{{ lan_interface }}" ct state {established, related} accept

        # 4. Permitir ICMPv6 entre redes (necesario para IPv6).
        ip6 nexthdr icmpv6 accept
        
        # 5. Permitir ICMPv4 (ping, etc.)
        ip protocol icmp accept
    }

    chain output {
        type filter hook output priority 0; policy accept;
        # Por defecto, se permite todo el tráfico saliente originado por el router.
    }
}
