#!/usr/sbin/nftables -f
# Firewall básico para Debian Router IPv6
# Red: 2025:DB8:101::/64

flush ruleset

table ip6 filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Aceptar loopback
        iif lo accept

        # Aceptar conexiones establecidas
        ct state {established, related} accept

        # ICMPv6 (necesario para IPv6)
        # Permitir tipos esenciales (destination-unreachable, packet-too-big, time-exceeded, parameter-problem)
        # eco request/reply y Neighbor Discovery / Router Advertisement (133-136)
        icmpv6 type { 1, 2, 3, 4, 128, 129, 133, 134, 135, 136 } accept

        # Aceptar paquetes destinados a multicast (necesario para ND/RA)
        ip6 daddr ff00::/8 accept

        # SSH
        tcp dport 22 accept

        # HTTP
        tcp dport 80 accept

        # FTP
        tcp dport {20, 21} accept

        # DHCPv6
        udp dport 547 accept

        # DNS
        udp dport 53 accept
        tcp dport 53 accept

        # Log dropped packets
        log prefix "INPUT-DROP: " drop
    }

    chain forward {
        type filter hook forward priority 0; policy accept;
        ct state {established, related} accept
        # Permitir ICMPv6 de reenvío explícitamente
        icmpv6 type { 128, 129, 133, 134, 135, 136 } accept

        # Aceptar tráfico entre WAN y LAN interfaces (explicitar para evitar bloqueos accidentales)
        {% if wan_interface is defined and lan_interface is defined %}
        iifname "{{ lan_interface }}" oifname "{{ wan_interface }}" accept
        iifname "{{ wan_interface }}" oifname "{{ lan_interface }}" accept
        {% endif %}
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}