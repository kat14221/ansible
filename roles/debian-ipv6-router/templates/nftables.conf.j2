#!/usr/sbin/nftables -f
# Firewall básico para Debian Router IPv6
# Red: 2025:DB8:101::/64

flush ruleset

table ip6 filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Aceptar loopback
        iif lo accept

        # Aceptar conexiones establecidas
        ct state {established, related} accept

        # ICMPv6 (necesario para IPv6)
        # Permitir tipos esenciales (destination-unreachable, packet-too-big, time-exceeded, parameter-problem)
        # eco request/reply y Neighbor Discovery / Router Advertisement (133-136)
        icmpv6 type { 1, 2, 3, 4, 128, 129, 133, 134, 135, 136 } accept

        # Aceptar paquetes destinados a multicast (necesario para ND/RA)
        ip6 daddr ff00::/8 accept

        # SSH
        tcp dport 22 accept

        # HTTP
        tcp dport 80 accept

        # FTP
        tcp dport {20, 21} accept

        # DHCPv6
        udp dport 547 accept

        # DNS
        udp dport 53 accept
        tcp dport 53 accept

        # Log dropped packets
        log prefix "INPUT-DROP: " drop
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
        ct state {established, related} accept
        # Permitir ICMPv6 de reenvío explícitamente
        icmpv6 type { 128, 129, 133, 134, 135, 136 } accept

        # Permitir que la red LAN (Fernandez) salga a la WAN (hacia internet/lab)
        {% if wan_interface is defined and lan_interface is defined %}
        iifname "{{ lan_interface }}" oifname "{{ wan_interface }}" accept

        # Permitir que la red WAN (Laboratorio) entre a la LAN (Fernandez) para juegos P2P
        iifname "{{ wan_interface }}" oifname "{{ lan_interface }}" ip6 saddr 2025:db8:100::/64 ip6 daddr 2025:db8:101::/64 accept
        {% endif %}

        log prefix "FORWARD-DROP: " drop
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# =================================================
# Tabla NAT para dar internet a la red interna
# =================================================
table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;

        # "Disfrazar" todo el tráfico que sale por la interfaz WAN
        # para que parezca que viene del propio router.
        {% if wan_interface is defined %}
        oifname "{{ wan_interface }}" masquerade
        {% endif %}
    }
}