---
# Role: debian-ipv6-router
# Descripción: Configurar Debian como router IPv6 para red 2025:DB8:101::/64
# Gateway central de toda la topología

# ============================================
# LIMPIEZA DE LOCKS APT (por si hay procesos bloqueados)
# ============================================

- name: Verificar si hay procesos apt/dpkg corriendo
  shell: ps aux | grep -E '[a]pt|[d]pkg' | grep -v grep
  register: apt_processes
  changed_when: false
  failed_when: false

- name: Matar procesos apt/dpkg bloqueados
  shell: |
    pkill -9 apt || true
    pkill -9 apt-get || true
    pkill -9 dpkg || true
  when: apt_processes.rc == 0
  ignore_errors: yes

- name: Esperar a que terminen procesos apt
  pause:
    seconds: 3
  when: apt_processes.rc == 0

- name: Eliminar locks de apt
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/apt/lists/lock
    - /var/cache/apt/archives/lock
    - /var/lib/dpkg/lock
    - /var/lib/dpkg/lock-frontend
  ignore_errors: yes

- name: Reconfigurar paquetes dpkg
  command: dpkg --configure -a
  changed_when: false
  ignore_errors: yes

# ============================================
# CONFIGURACIÓN DE REPOSITORIOS
# ============================================

- name: Deshabilitar repositorio CD-ROM
  lineinfile:
    path: /etc/apt/sources.list
    regexp: '^deb cdrom:'
    state: absent
  ignore_errors: yes

- name: Configurar repositorios de Debian (red)
  copy:
    dest: /etc/apt/sources.list
    content: |
      # Repositorios de Debian 12 (Bookworm) por red
      deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
      deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
      deb http://security.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware
    owner: root
    group: root
    mode: '0644'
    backup: yes

- name: Actualizar cache de paquetes
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Instalar paquetes necesarios para IPv6 routing y servicios
  apt:
    name:
      - radvd
      - isc-dhcp-server
      - nftables
      - tcpdump
      - tshark
      - net-tools
      - iproute2
      - resolvconf           # DNS permanente
      - apache2              # Servicio HTTP
      - dnsmasq              # Servicio DNS
      - vsftpd               # Servicio FTP
      - bind9-dnsutils       # Herramientas DNS (dig, nslookup)
      - curl                 # Testing HTTP
      - ftp                  # Cliente FTP para pruebas
    state: present

- name: Habilitar IPv6 forwarding permanentemente
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    state: present
    reload: yes
  register: ipv6_forwarding

- name: Habilitar IPv6 forwarding en interfaz específica
  sysctl:
    name: "net.ipv6.conf.{{ interface }}.forwarding"
    value: '1'
    state: present
    reload: yes

- name: Deshabilitar RA acceptance (somos el router)
  sysctl:
    name: "net.ipv6.conf.{{ interface }}.accept_ra"
    value: '0'
    state: present
    reload: yes

- name: Configurar interfaces de red (gestión + proyecto)
  template:
    src: interfaces.j2
    dest: "/etc/network/interfaces"
    owner: root
    group: root
    mode: '0644'
    backup: yes
  # NO reiniciar networking automáticamente para evitar cortar SSH

- name: Verificar si interfaz IPv6 tiene IP configurada
  shell: ip -6 addr show {{ interface }} | grep -q {{ ipv6_address }}
  register: ipv6_configured
  changed_when: false
  failed_when: false

- name: Configurar IPv6 en interfaz (sin reiniciar networking)
  shell: |
    ip addr add {{ ipv6_address }}/{{ ipv6_prefix }} dev {{ interface }} || true
    ip link set {{ interface }} up
  when: ipv6_configured.rc != 0

- name: Configurar radvd (Router Advertisement)
  template:
    src: radvd.conf.j2
    dest: /etc/radvd.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart radvd

- name: Configurar DHCPv6 server
  template:
    src: dhcpd6.conf.j2
    dest: /etc/dhcp/dhcpd6.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart isc-dhcp-server6

- name: Configurar interfaz para DHCPv6 server
  lineinfile:
    path: /etc/default/isc-dhcp-server
    regexp: '^INTERFACESv6='
    line: 'INTERFACESv6="{{ interface }}"'
    create: yes
  notify: restart isc-dhcp-server6

- name: Habilitar e iniciar radvd
  systemd:
    name: radvd
    enabled: yes
    state: started

- name: Habilitar e iniciar isc-dhcp-server6
  systemd:
    name: isc-dhcp-server6
    enabled: yes
    state: started
  ignore_errors: yes

- name: Configurar firewall básico con nftables
  template:
    src: nftables.conf.j2
    dest: /etc/nftables.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart nftables

- name: Habilitar nftables
  systemd:
    name: nftables
    enabled: yes
    state: started

- name: Verificar configuración IPv6
  command: ip -6 addr show {{ interface }}
  register: ipv6_config
  changed_when: false

- name: Verificar estado de radvd
  command: systemctl status radvd --no-pager
  register: radvd_status
  changed_when: false
  failed_when: false

- name: Verificar estado de DHCPv6
  command: systemctl status isc-dhcp-server6 --no-pager
  register: dhcpv6_status
  changed_when: false
  failed_when: false

- name: Mostrar configuración completa
  debug:
    msg:
      - "=================================================="
      - "  ✓ Debian Router IPv6 Configurado"
      - "=================================================="
      - ""
      - "Red: 2025:DB8:101::/64"
      - "Gateway: {{ ipv6_address }}/{{ ipv6_prefix }}"
      - "Interface: {{ interface }}"
      - ""
      - "Servicios:"
      - "  • radvd: {{ 'ACTIVO ✓' if radvd_status.rc == 0 else 'INACTIVO ✗' }}"
      - "  • DHCPv6: {{ 'ACTIVO ✓' if dhcpv6_status.rc == 0 else 'INACTIVO ✗' }}"
      - "  • IPv6 Forwarding: HABILITADO ✓"
      - ""
      - "DHCPv6 Pool: {{ dhcpv6_range_start }} - {{ dhcpv6_range_end }}"
      - "DNS: {{ dhcpv6_dns_servers | join(', ') }}"
      - "=================================================="
