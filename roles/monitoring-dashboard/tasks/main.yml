---
# Role: monitoring-dashboard
# Instala y expone el dashboard de Netdata para observabilidad en tiempo real.

- name: "NETDATA | Instalar dependencias del instalador"
  apt:
    name:
      - curl
      - git
      - gcc
      - make
      - autoconf
      - automake
      - pkg-config
      - zlib1g-dev
      - uuid-dev
    state: present
    update_cache: yes
  become: yes

- name: "NETDATA | Descargar script oficial"
  get_url:
    url: "https://my-netdata.io/kickstart.sh"
    dest: "/tmp/kickstart.sh"
    mode: '0755'
  become: yes

- name: "NETDATA | Ejecutar instalador en modo no interactivo"
  shell: /tmp/kickstart.sh --dont-wait --disable-telemetry
  args:
    creates: /etc/netdata/netdata.conf
  become: yes
  changed_when: true

- name: "NETDATA | Verificar si existe regla para el puerto 19999"
  shell: nft list ruleset | grep -q 'tcp dport 19999 accept'
  register: netdata_rule_check
  failed_when: false
  changed_when: false
  become: yes

- name: "NETDATA | Agregar regla nftables para el puerto 19999"
  command: nft add rule inet ansible input tcp dport 19999 accept comment "Allow Netdata Dashboard"
  become: yes
  when: netdata_rule_check.rc != 0

- name: "NETDATA | Mostrar URL de acceso"
  debug:
    msg:
      - "==================================================================="
      - "âœ… Dashboard Netdata desplegado"
      - "==================================================================="
      - "Accede desde tu navegador a:"
      - "   http://{{ ansible_host | default(inventory_hostname) }}:19999"
      - "   http://[2025:db8:101::1]:19999"
      - "==================================================================="
  run_once: true
