---
# Role: debian-services
# Descripción: Desplegar servicios de aplicación en el router Debian

- name: Instalar servidores web y FTP
  apt:
    name:
      - apache2
      - vsftpd
    state: present
    update_cache: yes

- name: Detener Apache para configuración
  systemd:
    name: apache2
    state: stopped
  ignore_errors: yes

- name: Verificar que Apache esté correctamente instalado
  command: dpkg -l apache2
  register: apache_installed
  failed_when: false
  changed_when: false

- name: Reinstalar Apache si es necesario
  apt:
    name: apache2
    state: present
    force: yes
  when: apache_installed.rc != 0

- name: Crear página de prueba
  template:
    src: index.html.j2
    dest: /var/www/html/index.html
    mode: '0644'

- name: Verificar sintaxis de Apache antes de iniciar
  command: apache2ctl configtest
  register: apache_configtest
  failed_when: false
  changed_when: false

- name: Mostrar resultado de verificación de configuración
  debug:
    msg: "{{ apache_configtest.stderr_lines }}"
  when: apache_configtest.rc != 0

- name: Obtener logs de Apache antes de intentar iniciar
  shell: journalctl -u apache2 -n 50 --no-pager
  register: apache_logs_before
  failed_when: false
  changed_when: false

- name: Mostrar logs previos de Apache
  debug:
    msg: "{{ apache_logs_before.stdout_lines[-20:] }}"

- name: Intentar iniciar Apache
  systemd:
    name: apache2
    state: started
    enabled: yes
  register: apache_start
  failed_when: false

- name: Obtener logs de Apache después del intento
  shell: journalctl -u apache2 -n 100 --no-pager
  register: apache_logs_after
  failed_when: false
  changed_when: false
  when: apache_start.failed | default(false)

- name: Mostrar logs detallados si falló
  debug:
    msg: "{{ apache_logs_after.stdout_lines[-30:] }}"
  when: apache_start.failed | default(false)

- name: Verificar estado final de Apache
  command: systemctl status apache2 --no-pager
  register: apache_final_status
  failed_when: false
  changed_when: false

- name: Mostrar estado final
  debug:
    msg: "{{ apache_final_status.stdout_lines }}"

- name: Fallar si Apache no está corriendo
  fail:
    msg: "Apache2 no pudo iniciarse. Revisa los logs arriba."
  when: apache_start.failed | default(false)

- name: Verificar estado de Apache
  command: systemctl status apache2 --no-pager
  register: apache_status
  failed_when: false

- name: Verificar que Apache escucha en IPv6
  command: netstat -tlnp | grep :80
  register: apache_listening
  failed_when: false

- name: Probar el servidor HTTP desde localhost
  uri:
    url: "http://{{ ansible_host }}"
    method: GET
  register: http_test
  ignore_errors: yes

- name: Guardar información del servicio HTTP
  copy:
    content: |
      === Servicio HTTP - Apache ===
      Fecha: {{ ansible_date_time.iso8601 }}
      
      Estado del servicio: {{ 'running' if apache_status.rc == 0 else 'failed' }}
      
      Puertos en escucha:
      {{ apache_listening.stdout | default('No se pudo obtener información') }}
      
      Prueba HTTP:
      Status: {{ 'OK' if http_test.status | default(0) == 200 else 'FAIL' }}
      URL: http://{{ ansible_host }}
    dest: "evidence/services/{{ inventory_hostname }}_http_service.txt"
  delegate_to: localhost

- name: Configurar vsftpd para IPv6
  copy:
    content: |
      # Configuración vsftpd para IPv6
      listen=NO
      listen_ipv6=YES
      anonymous_enable=NO
      local_enable=YES
      write_enable=YES
      local_umask=022
      dirmessage_enable=YES
      use_localtime=YES
      xferlog_enable=YES
      connect_from_port_20=YES
      secure_chroot_dir=/var/run/vsftpd/empty
      pam_service_name=vsftpd
      ssl_enable=NO
      pasv_enable=YES
      pasv_min_port=10000
      pasv_max_port=10100
      allow_writeable_chroot=YES
      ftpd_banner=VMWARE-101001 FTP Server IPv6
    dest: /etc/vsftpd.conf
    backup: yes

- name: Crear usuario FTP de prueba
  user:
    name: ftpuser
    password: "{{ 'ftppass123' | password_hash('sha512') }}"
    shell: /bin/bash
    home: /home/ftpuser
    state: present

- name: Crear directorio FTP público
  file:
    path: /home/ftpuser/public
    state: directory
    owner: ftpuser
    group: ftpuser
    mode: '0755'

- name: Crear archivo de prueba FTP
  copy:
    content: |
      ================================================
      VMWARE-101001 - Red Académica IPv6
      Servidor FTP funcionando correctamente
      ================================================
      
      Información del Sistema:
      - IPv6 LAN: {{ lan_ipv6_address }}/{{ lan_ipv6_prefix }}
      - Subred LAN (radvd): {{ radvd_prefix }}
      
      Acceso FTP:
      - Usuario: ftpuser
      - Password: ftppass123
      - Desde LAN: ftp://[{{ lan_ipv6_address }}]
      
      Configurado con Ansible - {{ ansible_date_time.iso8601 }}
    dest: /home/ftpuser/public/README.txt
    owner: ftpuser
    group: ftpuser
    mode: '0644'

- name: Iniciar y habilitar vsftpd
  systemd:
    name: vsftpd
    state: started
    enabled: yes

- name: Verificar estado de vsftpd
  command: systemctl status vsftpd --no-pager
  register: vsftpd_status
  failed_when: false

- name: Verificar que vsftpd escucha en IPv6
  command: netstat -tlnp | grep :21
  register: vsftpd_listening
  failed_when: false

- name: Guardar información del servicio FTP
  copy:
    content: |
      === Servicio FTP - vsftpd ===
      Fecha: {{ ansible_date_time.iso8601 }}
      
      Estado del servicio: {{ 'running' if vsftpd_status.rc == 0 else 'failed' }}
      
      Puertos en escucha:
      {{ vsftpd_listening.stdout | default('No se pudo obtener información') }}
      
      Configuración:
      - Usuario: ftpuser
      - Password: ftppass123
      - Directorio: /home/ftpuser/public/
      - IPv6: Habilitado
      - Modo Pasivo: Puertos 10000-10100
      
      Acceso:
      - Desde LAN: ftp://[{{ lan_ipv6_address }}]
    dest: "evidence/services/{{ inventory_hostname }}_ftp_service.txt"
  delegate_to: localhost

- name: Mostrar resumen del servicio
  debug:
    msg:
      - "=== Servicios Desplegados ==="
      - "HTTP Estado: {{ 'Running' if apache_status.rc == 0 else 'Failed' }}"
      - "FTP Estado: {{ 'Running' if vsftpd_status.rc == 0 else 'Failed' }}"
      - "HTTP Acceso (LAN): http://[{{ lan_ipv6_address }}]"
      - "FTP Acceso (LAN): ftp://[{{ lan_ipv6_address }}]"
      - "FTP Usuario: ftpuser / ftppass123"