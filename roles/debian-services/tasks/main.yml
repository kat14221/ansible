---
# Role: debian-services
# Descripción: Desplegar servicios de aplicación en el router Debian

- name: Instalar servidores web y FTP
  apt:
    name:
      - apache2
      - vsftpd
    state: present
    update_cache: yes

- name: Detener Apache para configuración
  systemd:
    name: apache2
    state: stopped
  ignore_errors: yes

- name: Crear página de prueba
  template:
    src: index.html.j2
    dest: /var/www/html/index.html
    mode: '0644'

- name: Verificar configuración actual de Apache
  command: grep -E "^Listen" /etc/apache2/ports.conf
  register: apache_ports_before
  ignore_errors: yes
  changed_when: false

- name: Limpiar configuración de puertos de Apache
  lineinfile:
    path: /etc/apache2/ports.conf
    regexp: '^Listen'
    state: absent

- name: Configurar Apache para escuchar en IPv4 e IPv6
  blockinfile:
    path: /etc/apache2/ports.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK - IPv6"
    insertafter: EOF
    block: |
      Listen 80
      <IfModule ssl_module>
              Listen 443
      </IfModule>
      <IfModule mod_gnutls.c>
              Listen 443
      </IfModule>

- name: Verificar sintaxis de Apache
  command: apache2ctl configtest
  register: apache_configtest
  failed_when: false
  changed_when: false

- name: Mostrar resultado de verificación
  debug:
    msg: "Apache config test: {{ apache_configtest.stdout_lines }}"

- name: Iniciar y habilitar Apache
  systemd:
    name: apache2
    state: started
    enabled: yes

- name: Verificar estado de Apache
  command: systemctl status apache2 --no-pager
  register: apache_status
  failed_when: false

- name: Verificar que Apache escucha en IPv6
  command: netstat -tlnp | grep :80
  register: apache_listening
  failed_when: false

- name: Probar el servidor HTTP desde localhost
  uri:
    url: "http://{{ ansible_host }}"
    method: GET
  register: http_test
  ignore_errors: yes

- name: Guardar información del servicio HTTP
  copy:
    content: |
      === Servicio HTTP - Apache ===
      Fecha: {{ ansible_date_time.iso8601 }}
      
      Estado del servicio: {{ 'running' if apache_status.rc == 0 else 'failed' }}
      
      Puertos en escucha:
      {{ apache_listening.stdout | default('No se pudo obtener información') }}
      
      Prueba HTTP:
      Status: {{ 'OK' if http_test.status | default(0) == 200 else 'FAIL' }}
      URL: http://{{ ansible_host }}
    dest: "evidence/services/{{ inventory_hostname }}_http_service.txt"
  delegate_to: localhost

- name: Configurar vsftpd para IPv6
  copy:
    content: |
      # Configuración vsftpd para IPv6
      listen=NO
      listen_ipv6=YES
      anonymous_enable=NO
      local_enable=YES
      write_enable=YES
      local_umask=022
      dirmessage_enable=YES
      use_localtime=YES
      xferlog_enable=YES
      connect_from_port_20=YES
      secure_chroot_dir=/var/run/vsftpd/empty
      pam_service_name=vsftpd
      ssl_enable=NO
      pasv_enable=YES
      pasv_min_port=10000
      pasv_max_port=10100
      allow_writeable_chroot=YES
      ftpd_banner=VMWARE-101001 FTP Server IPv6
    dest: /etc/vsftpd.conf
    backup: yes

- name: Crear usuario FTP de prueba
  user:
    name: ftpuser
    password: "{{ 'ftppass123' | password_hash('sha512') }}"
    shell: /bin/bash
    home: /home/ftpuser
    state: present

- name: Crear directorio FTP público
  file:
    path: /home/ftpuser/public
    state: directory
    owner: ftpuser
    group: ftpuser
    mode: '0755'

- name: Crear archivo de prueba FTP
  copy:
    content: |
      ================================================
      VMWARE-101001 - Red Académica IPv6
      Servidor FTP funcionando correctamente
      ================================================
      
      Información del Sistema:
      - IPv6 LAN: {{ lan_ipv6_address }}/{{ lan_ipv6_prefix }}
      - Subred LAN (radvd): {{ radvd_prefix }}
      
      Acceso FTP:
      - Usuario: ftpuser
      - Password: ftppass123
      - Desde LAN: ftp://[{{ lan_ipv6_address }}]
      
      Configurado con Ansible - {{ ansible_date_time.iso8601 }}
    dest: /home/ftpuser/public/README.txt
    owner: ftpuser
    group: ftpuser
    mode: '0644'

- name: Iniciar y habilitar vsftpd
  systemd:
    name: vsftpd
    state: started
    enabled: yes

- name: Verificar estado de vsftpd
  command: systemctl status vsftpd --no-pager
  register: vsftpd_status
  failed_when: false

- name: Verificar que vsftpd escucha en IPv6
  command: netstat -tlnp | grep :21
  register: vsftpd_listening
  failed_when: false

- name: Guardar información del servicio FTP
  copy:
    content: |
      === Servicio FTP - vsftpd ===
      Fecha: {{ ansible_date_time.iso8601 }}
      
      Estado del servicio: {{ 'running' if vsftpd_status.rc == 0 else 'failed' }}
      
      Puertos en escucha:
      {{ vsftpd_listening.stdout | default('No se pudo obtener información') }}
      
      Configuración:
      - Usuario: ftpuser
      - Password: ftppass123
      - Directorio: /home/ftpuser/public/
      - IPv6: Habilitado
      - Modo Pasivo: Puertos 10000-10100
      
      Acceso:
      - Desde LAN: ftp://[{{ lan_ipv6_address }}]
    dest: "evidence/services/{{ inventory_hostname }}_ftp_service.txt"
  delegate_to: localhost

- name: Mostrar resumen del servicio
  debug:
    msg:
      - "=== Servicios Desplegados ==="
      - "HTTP Estado: {{ 'Running' if apache_status.rc == 0 else 'Failed' }}"
      - "FTP Estado: {{ 'Running' if vsftpd_status.rc == 0 else 'Failed' }}"
      - "HTTP Acceso (LAN): http://[{{ lan_ipv6_address }}]"
      - "FTP Acceso (LAN): ftp://[{{ lan_ipv6_address }}]"
      - "FTP Usuario: ftpuser / ftppass123"