---
- name: Sistema de GestiÃ³n de Seguridad - MÃ©todo Seguro
  hosts: debian_router
  gather_facts: true
  become: true
  
  tasks:
    - name: Instalar dependencias
      apt:
        name:
          - python3
          - python3-flask
          - sudo
        state: present
        update_cache: yes

    - name: Crear script Python bÃ¡sico
      shell: |
        rm -f /home/ansible/security_app.py
        echo '#!/usr/bin/env python3' > /home/ansible/security_app.py
        echo 'from flask import Flask, request, jsonify, redirect, session' >> /home/ansible/security_app.py
        echo 'import subprocess' >> /home/ansible/security_app.py
        echo '' >> /home/ansible/security_app.py
        echo 'app = Flask(__name__)' >> /home/ansible/security_app.py
        echo 'app.secret_key = "ansible-security-2025"' >> /home/ansible/security_app.py
        echo '' >> /home/ansible/security_app.py

    - name: Agregar funciones auxiliares
      shell: |
        cat >> /home/ansible/security_app.py << 'FUNC_END'
        def run_cmd(cmd):
            try:
                result = subprocess.run(cmd, shell=True, capture_output=True, text=True, check=True)
                return {'success': True, 'output': result.stdout}
            except subprocess.CalledProcessError as e:
                return {'success': False, 'error': str(e), 'output': e.stdout}
        FUNC_END

    - name: Crear HTML del dashboard
      shell: |
        cat >> /home/ansible/security_app.py << 'HTML_END'
        
        DASHBOARD_HTML = """<!DOCTYPE html>
        <html>
        <head>
            <title>GestiÃ³n de Seguridad</title>
            <style>
                * { margin:0; padding:0; box-sizing:border-box; }
                body { font-family:Arial; background:#f0f2f5; min-height:100vh; }
                .navbar { background:#2c3e50; color:white; padding:20px; }
                .navbar h1 { margin:0; }
                .container { max-width:1200px; margin:0 auto; padding:20px; }
                .section { background:white; margin:20px 0; border-radius:8px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
                .btn { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin:5px; }
                .btn:hover { background:#2980b9; }
                .btn.danger { background:#e74c3c; }
                .form-group { margin:15px 0; }
                .form-group input, .form-group select { width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; }
                .users-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-top:20px; }
                .user-card { background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; padding:15px; }
                .alert { padding:15px; margin:15px 0; border-radius:5px; display:none; }
                .alert.success { background:#d4edda; color:#155724; }
                .alert.error { background:#f8d7da; color:#721c24; }
            </style>
        </head>
        <body>
            <div class="navbar">
                <h1>ğŸ›¡ï¸ GestiÃ³n de Seguridad</h1>
                <div style="float:right;">
                    <span>ğŸ‘¤ {username}</span>
                    <a href="/logout" style="color:white; margin-left:15px;">Salir</a>
                </div>
            </div>
            <div class="container">
                <div id="alert" class="alert"></div>
                
                <div class="section">
                    <h2>ğŸ“Š Estado del Sistema</h2>
                    <button class="btn" onclick="checkStatus()">ğŸ” Verificar Estado</button>
                    <div id="statusContainer"></div>
                </div>
                
                <div class="section">
                    <h2>ğŸ‘¥ GestiÃ³n de Usuarios</h2>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div>
                            <h3>Crear Usuario</h3>
                            <form onsubmit="createUser(event)">
                                <div class="form-group">
                                    <input type="text" id="username" placeholder="Nombre de usuario" required>
                                </div>
                                <div class="form-group">
                                    <input type="password" id="password" placeholder="ContraseÃ±a" required>
                                </div>
                                <div class="form-group">
                                    <select id="role" required>
                                        <option value="">Seleccionar rol</option>
                                        <option value="alumno">ğŸ‘¨â€ğŸ“ Alumno</option>
                                        <option value="profesor">ğŸ‘¨â€ğŸ« Profesor</option>
                                        <option value="admin">ğŸ”§ Administrador</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn">â• Crear Usuario</button>
                            </form>
                        </div>
                        <div>
                            <h3>Usuarios Actuales</h3>
                            <button class="btn" onclick="loadUsers()">ğŸ”„ Actualizar</button>
                            <div class="users-grid" id="usersContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                function showAlert(msg, type) {
                    const alert = document.getElementById('alert');
                    alert.className = 'alert ' + type;
                    alert.textContent = msg;
                    alert.style.display = 'block';
                    setTimeout(() => alert.style.display = 'none', 5000);
                }
                
                function loadUsers() {
                    fetch('/api/users')
                        .then(r => r.json())
                        .then(users => {
                            const container = document.getElementById('usersContainer');
                            container.innerHTML = '';
                            users.forEach(user => {
                                const icon = user.groups.includes('sudo') ? 'ğŸ”§' : 
                                           user.groups.includes('profesor') ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ‘¨â€ğŸ“';
                                const card = document.createElement('div');
                                card.className = 'user-card';
                                card.innerHTML = `
                                    <div style="display:flex; align-items:center; margin-bottom:10px;">
                                        <span style="font-size:1.5em; margin-right:10px;">${icon}</span>
                                        <div>
                                            <h4>${user.username}</h4>
                                            <p>UID: ${user.uid}</p>
                                            <p>Grupos: ${user.groups}</p>
                                        </div>
                                    </div>
                                    <button class="btn danger" onclick="deleteUser('${user.username}')">
                                        ğŸ—‘ï¸ Eliminar
                                    </button>
                                `;
                                container.appendChild(card);
                            });
                        })
                        .catch(e => showAlert('Error cargando usuarios: ' + e.message, 'error'));
                }
                
                function createUser(e) {
                    e.preventDefault();
                    const data = {
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value,
                        role: document.getElementById('role').value
                    };
                    
                    fetch('/api/create_user', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    })
                    .then(r => r.json())
                    .then(result => {
                        showAlert(result.message || result.error, result.success ? 'success' : 'error');
                        if (result.success) {
                            e.target.reset();
                            loadUsers();
                        }
                    });
                }
                
                function deleteUser(username) {
                    if (confirm('Â¿Eliminar usuario ' + username + '?')) {
                        fetch('/api/delete_user', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({username: username})
                        })
                        .then(r => r.json())
                        .then(result => {
                            showAlert(result.message || result.error, result.success ? 'success' : 'error');
                            if (result.success) loadUsers();
                        });
                    }
                }
                
                function checkStatus() {
                    fetch('/api/status')
                        .then(r => r.json())
                        .then(status => {
                            const container = document.getElementById('statusContainer');
                            container.innerHTML = `
                                <div style="margin-top:15px; padding:15px; background:#f8f9fa; border-radius:5px;">
                                    <p><strong>ğŸ–¥ï¸ Sistema:</strong> ${status.hostname}</p>
                                    <p><strong>â° Fecha:</strong> ${status.date}</p>
                                    <p><strong>ğŸ‘¥ Usuarios conectados:</strong> ${status.users}</p>
                                    <p><strong>ğŸ’¾ Espacio libre:</strong> ${status.disk}</p>
                                </div>
                            `;
                        });
                }
                
                loadUsers();
                checkStatus();
            </script>
        </body>
        </html>"""
        HTML_END

    - name: Crear HTML de login
      shell: |
        cat >> /home/ansible/security_app.py << 'LOGIN_END'
        
        LOGIN_HTML = """<!DOCTYPE html>
        <html>
        <head>
            <title>Login - GestiÃ³n de Seguridad</title>
            <style>
                body { font-family:Arial; background:#3498db; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
                .login-box { background:white; padding:40px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.3); max-width:400px; width:100%; }
                .login-box h1 { text-align:center; color:#2c3e50; margin-bottom:30px; }
                .form-group { margin-bottom:20px; }
                .form-group input { width:100%; padding:12px; border:1px solid #ddd; border-radius:5px; font-size:16px; box-sizing:border-box; }
                .login-btn { width:100%; background:#3498db; color:white; border:none; padding:15px; border-radius:5px; font-size:16px; cursor:pointer; }
                .login-btn:hover { background:#2980b9; }
                .error { background:#e74c3c; color:white; padding:10px; border-radius:5px; margin-bottom:20px; text-align:center; }
            </style>
        </head>
        <body>
            <div class="login-box">
                <h1>ğŸ” GestiÃ³n de Seguridad</h1>
                {error_div}
                <form method="POST">
                    <div class="form-group">
                        <input type="text" name="username" placeholder="Usuario" required>
                    </div>
                    <div class="form-group">
                        <input type="password" name="password" placeholder="ContraseÃ±a" required>
                    </div>
                    <button type="submit" class="login-btn">Iniciar SesiÃ³n</button>
                </form>
            </div>
        </body>
        </html>"""
        LOGIN_END

    - name: Agregar rutas Flask
      shell: |
        cat >> /home/ansible/security_app.py << 'ROUTES_END'
        
        @app.route('/')
        def dashboard():
            if 'user' not in session:
                return redirect('/login')
            return DASHBOARD_HTML.format(username=session.get('user', 'Usuario'))
        
        @app.route('/login', methods=['GET', 'POST'])
        def login():
            if request.method == 'POST':
                username = request.form.get('username')
                password = request.form.get('password')
                if username in ['admin', 'ansible'] and len(password) > 3:
                    session['user'] = username
                    return redirect('/')
                else:
                    error_div = '<div class="error">Credenciales incorrectas</div>'
            else:
                error_div = ''
            return LOGIN_HTML.format(error_div=error_div)
        
        @app.route('/logout')
        def logout():
            session.clear()
            return redirect('/login')
        ROUTES_END

    - name: Agregar APIs
      shell: |
        cat >> /home/ansible/security_app.py << 'API_END'
        
        @app.route('/api/users')
        def api_users():
            if 'user' not in session:
                return jsonify({'error': 'No autorizado'}), 401
            
            result = run_cmd("getent passwd | grep -E '/home|/Users' | cut -d: -f1,3,6 | sort")
            if not result['success']:
                return jsonify({'error': 'Error obteniendo usuarios'})
            
            users = []
            for line in result['output'].strip().split('\n'):
                if line:
                    parts = line.split(':')
                    if len(parts) >= 3:
                        username = parts[0]
                        uid = parts[1]
                        groups_result = run_cmd(f"groups {username}")
                        groups = groups_result['output'].split(':')[1].strip() if groups_result['success'] else ''
                        users.append({'username': username, 'uid': uid, 'groups': groups})
            return jsonify(users)
        
        @app.route('/api/create_user', methods=['POST'])
        def api_create_user():
            if 'user' not in session:
                return jsonify({'error': 'No autorizado'}), 401
            
            data = request.get_json()
            username = data.get('username')
            password = data.get('password')
            role = data.get('role')
            
            if not all([username, password, role]):
                return jsonify({'error': 'Datos incompletos', 'success': False})
            
            cmd = f"sudo useradd -m -s /bin/bash {username}"
            result = run_cmd(cmd)
            
            if not result['success']:
                return jsonify({'error': f'Error creando usuario', 'success': False})
            
            passwd_cmd = f"echo '{username}:{password}' | sudo chpasswd"
            run_cmd(passwd_cmd)
            
            if role == 'profesor':
                run_cmd(f"sudo usermod -aG profesor {username}")
            elif role == 'admin':
                run_cmd(f"sudo usermod -aG sudo {username}")
            
            return jsonify({'message': f'Usuario {username} creado exitosamente', 'success': True})
        
        @app.route('/api/delete_user', methods=['POST'])
        def api_delete_user():
            if 'user' not in session:
                return jsonify({'error': 'No autorizado'}), 401
            
            data = request.get_json()
            username = data.get('username')
            
            if not username:
                return jsonify({'error': 'Username requerido', 'success': False})
            
            if username in ['root', 'admin', 'ansible']:
                return jsonify({'error': 'No se puede eliminar usuario del sistema', 'success': False})
            
            cmd = f"sudo userdel -r {username}"
            result = run_cmd(cmd)
            
            if result['success']:
                return jsonify({'message': f'Usuario {username} eliminado', 'success': True})
            else:
                return jsonify({'error': f'Error eliminando usuario', 'success': False})
        
        @app.route('/api/status')
        def api_status():
            if 'user' not in session:
                return jsonify({'error': 'No autorizado'}), 401
            
            hostname = run_cmd('hostname')['output'].strip()
            date = run_cmd('date')['output'].strip()
            users = run_cmd('who | wc -l')['output'].strip()
            disk = run_cmd("df -h / | tail -1 | awk '{print $4}'")['output'].strip()
            
            return jsonify({'hostname': hostname, 'date': date, 'users': users, 'disk': disk})
        API_END

    - name: Finalizar script Python
      shell: |
        cat >> /home/ansible/security_app.py << 'MAIN_END'
        
        if __name__ == '__main__':
            app.run(host='0.0.0.0', port=8090, debug=True)
        MAIN_END

    - name: Hacer ejecutable
      file:
        path: /home/ansible/security_app.py
        mode: '0755'
        owner: ansible
        group: ansible

    - name: Verificar sintaxis del archivo Python
      shell: |
        cd /home/ansible
        python3 -m py_compile security_app.py
        echo "Sintaxis Python OK"
        wc -l security_app.py
        tail -5 security_app.py
      become: false
      register: python_check

    - name: Mostrar verificaciÃ³n Python
      debug:
        var: python_check.stdout_lines

    - name: Detener procesos anteriores
      shell: |
        pkill -f "security_app.py" || true
        sleep 2
      become: false
      ignore_errors: yes

    - name: Verificar que Python3 y Flask funcionan
      shell: |
        cd /home/ansible
        python3 -c "import flask; print('Flask OK')"
        python3 -c "import subprocess; print('Subprocess OK')"
        ls -la security_app.py
      become: false

    - name: Ejecutar aplicaciÃ³n en background
      shell: |
        cd /home/ansible
        python3 security_app.py &
        echo $! > app.pid
        sleep 5
      become: false
      async: 30
      poll: 0

    - name: Esperar inicio de aplicaciÃ³n
      pause:
        seconds: 3

    - name: Verificar que la aplicaciÃ³n estÃ¡ ejecutÃ¡ndose
      shell: |
        cd /home/ansible
        if [ -f app.pid ]; then
          pid=$(cat app.pid)
          if ps -p $pid > /dev/null; then
            echo "AplicaciÃ³n ejecutÃ¡ndose con PID: $pid"
            netstat -tuln | grep 8090 && echo "Puerto 8090 activo" || echo "Puerto 8090 no disponible"
          else
            echo "Error: Proceso no encontrado"
            cat security_app.log 2>/dev/null || echo "No hay log disponible"
            exit 1
          fi
        else
          echo "Error: No se creÃ³ el archivo PID"
          exit 1
        fi
      become: false
      register: app_status

    - name: Mostrar estado de la aplicaciÃ³n
      debug:
        var: app_status.stdout_lines

    - name: Mostrar informaciÃ³n
      debug:
        msg:
          - "ğŸ›¡ï¸ SISTEMA DESPLEGADO EXITOSAMENTE"
          - "================================="
          - ""
          - "ğŸŒ URL: http://{{ ansible_default_ipv4.address }}:8090"
          - "ğŸ‘¤ Login: admin o ansible (contraseÃ±a > 3 chars)"
          - ""
          - "ğŸ“‹ Logs: tail -f /home/ansible/security_app.log"