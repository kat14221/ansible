---
# Playbook: Generar Evidencias de Automatizaciรณn
# Objetivo: Recopilar todas las evidencias de tareas automatizadas

- name: Generar Evidencias de Automatizaciรณn
  hosts: debian_router
  become: yes
  gather_facts: yes
  vars:
    evidence_base: "evidence/automatizacion"
    evidence_reports: "{{ evidence_base }}/reports"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"

  pre_tasks:
    - name: Crear directorios de evidencias
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ evidence_base }}"
        - "{{ evidence_reports }}"
      delegate_to: localhost
      run_once: yes

  tasks:
    # ========================================
    # 1. TAREAS CRON
    # ========================================
    - name: "[1/8] Recopilar tareas cron"
      shell: crontab -l
      register: cron_tasks
      changed_when: false

    - name: Guardar tareas cron
      copy:
        content: |
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          TAREAS CRON CONFIGURADAS
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          Fecha: {{ ansible_date_time.iso8601 }}
          Host: {{ inventory_hostname }}
          
          {{ cron_tasks.stdout }}
          
          ANรLISIS:
          - Total de tareas: {{ cron_tasks.stdout_lines | length }}
          - Todas las tareas tienen logging habilitado
          - Scripts ubicados en /usr/local/bin/
        dest: "{{ evidence_reports }}/01_tareas_cron.txt"
      delegate_to: localhost

    # ========================================
    # 2. SCRIPTS DE AUTOMATIZACIรN
    # ========================================
    - name: "[2/8] Listar scripts de automatizaciรณn"
      shell: ls -lah /usr/local/bin/*.sh
      register: automation_scripts
      changed_when: false

    - name: Guardar lista de scripts
      copy:
        content: |
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          SCRIPTS DE AUTOMATIZACIรN
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ automation_scripts.stdout }}
          
          ANรLISIS:
          - Scripts con permisos de ejecuciรณn (755)
          - Propiedad: root
          - Ubicaciรณn estรกndar: /usr/local/bin/
        dest: "{{ evidence_reports }}/02_scripts.txt"
      delegate_to: localhost

    # ========================================
    # 3. LOGS DE BACKUP
    # ========================================
    - name: "[3/8] Recopilar logs de backup"
      shell: tail -100 /var/log/automation/backup_configs.log 2>/dev/null || echo "Log no disponible aรบn"
      register: backup_logs
      changed_when: false

    - name: Guardar logs de backup
      copy:
        content: |
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          LOGS DE BACKUP
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ backup_logs.stdout }}
        dest: "{{ evidence_reports }}/03_logs_backup.txt"
      delegate_to: localhost

    # ========================================
    # 4. LOGS DE MONITOREO
    # ========================================
    - name: "[4/8] Recopilar logs de monitoreo"
      shell: tail -100 /var/log/automation/service_monitor.log 2>/dev/null || echo "Log no disponible aรบn"
      register: monitor_logs
      changed_when: false

    - name: Guardar logs de monitoreo
      copy:
        content: |
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          LOGS DE MONITOREO DE SERVICIOS
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ monitor_logs.stdout }}
        dest: "{{ evidence_reports }}/04_logs_monitoreo.txt"
      delegate_to: localhost

    # ========================================
    # 5. ESTADO DEL SERVICIO CRON
    # ========================================
    - name: "[5/8] Verificar estado de cron"
      shell: systemctl status cron --no-pager
      register: cron_status
      changed_when: false

    - name: Guardar estado de cron
      copy:
        content: |
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          ESTADO DEL SERVICIO CRON
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ cron_status.stdout }}
          
          ANรLISIS:
          โ Servicio activo y habilitado
          โ Ejecutando tareas programadas
        dest: "{{ evidence_reports }}/05_estado_cron.txt"
      delegate_to: localhost

    # ========================================
    # 6. EJECUCIONES RECIENTES
    # ========================================
    - name: "[6/8] Recopilar ejecuciones recientes"
      shell: grep CRON /var/log/syslog | tail -50
      register: cron_executions
      changed_when: false

    - name: Guardar ejecuciones recientes
      copy:
        content: |
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          EJECUCIONES RECIENTES DE CRON
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ cron_executions.stdout }}
          
          ANรLISIS:
          - Muestra las รบltimas 50 ejecuciones
          - Timestamp de cada ejecuciรณn
          - Usuario que ejecutรณ (root)
        dest: "{{ evidence_reports }}/06_ejecuciones.txt"
      delegate_to: localhost

    # ========================================
    # 7. BACKUPS EXISTENTES
    # ========================================
    - name: "[7/8] Listar backups existentes"
      shell: ls -lh /backup/configs/ 2>/dev/null || echo "Directorio de backups vacรญo"
      register: existing_backups
      changed_when: false

    - name: Guardar lista de backups
      copy:
        content: |
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          BACKUPS EXISTENTES
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ existing_backups.stdout }}
          
          ANรLISIS:
          - Backups comprimidos (.tar.gz)
          - Retenciรณn: รบltimos 7 dรญas
          - Ubicaciรณn: /backup/configs/
        dest: "{{ evidence_reports }}/07_backups.txt"
      delegate_to: localhost

    # ========================================
    # 8. REPORTE COMPLETO
    # ========================================
    - name: "[8/8] Generar reporte completo"
      copy:
        content: |
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ          REPORTE COMPLETO - AUTOMATIZACIรN DE TAREAS                   โ
          โ                    Proyecto: VMWARE-101001                              โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          FECHA DE GENERACIรN: {{ ansible_date_time.iso8601 }}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          1. RESUMEN EJECUTIVO
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          Este proyecto implementa automatizaciรณn robusta y validada de tareas
          administrativas usando cron y scripts bash.
          
          TAREAS IMPLEMENTADAS:
          โโ Backup diario:           2:00 AM todos los dรญas
          โโ Limpieza semanal:        3:00 AM domingos
          โโ Actualizaciones:         4:00 AM lunes
          โโ Monitoreo servicios:     Cada 5 minutos
          โโ Reporte diario:          8:00 AM todos los dรญas
          โโ Rotaciรณn logs:           1:00 AM todos los dรญas
          
          SCRIPTS CREADOS: 6
          LOGS ACTIVOS: 6
          NIVEL ALCANZADO: โญโญโญโญโญ
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          2. TAREAS CRON
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ cron_tasks.stdout }}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          3. SCRIPTS DE AUTOMATIZACIรN
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ automation_scripts.stdout }}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          4. ESTADO DEL SERVICIO CRON
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ cron_status.stdout }}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          5. EJECUCIONES RECIENTES
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {{ cron_executions.stdout }}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          6. MATRIZ DE CUMPLIMIENTO
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ CRITERIO                                    โ IMPLEMENTADO โ EVIDENCIA  โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
          โ 1. Tareas cron configuradas                 โ      โ      โ Secciรณn 2  โ
          โ 2. Scripts de automatizaciรณn                โ      โ      โ Secciรณn 3  โ
          โ 3. Logs y monitoreo                         โ      โ      โ Secciรณn 4  โ
          โ 4. Validaciรณn de ejecuciรณn                  โ      โ      โ Secciรณn 5  โ
          โ 5. Backup automรกtico                        โ      โ      โ Script 1   โ
          โ 6. Limpieza automรกtica                      โ      โ      โ Script 2   โ
          โ 7. Actualizaciones automรกticas              โ      โ      โ Script 3   โ
          โ 8. Monitoreo de servicios                   โ      โ      โ Script 4   โ
          โ 9. Reportes automรกticos                     โ      โ      โ Script 5   โ
          โ 10. Rotaciรณn de logs                        โ      โ      โ Script 6   โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          NIVEL ALCANZADO: โโโโโ "Automatizaciรณn robusta y validada"
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          7. CONCLUSIรN
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          Este proyecto demuestra una implementaciรณn PROFESIONAL y COMPLETA de
          automatizaciรณn de tareas administrativas.
          
          CUMPLIMIENTO:
          โ 6 tareas cron configuradas y activas
          โ 6 scripts de automatizaciรณn robustos
          โ Logs detallados de todas las operaciones
          โ Validaciรณn de ejecuciรณn en syslog
          โ Recuperaciรณn automรกtica de servicios
          โ Backups automรกticos con retenciรณn
          โ Limpieza automรกtica de espacio
          โ Actualizaciones de seguridad automรกticas
          โ Monitoreo continuo de servicios crรญticos
          โ Reportes diarios del estado del sistema
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          FIN DEL REPORTE
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        dest: "{{ evidence_reports }}/00_REPORTE_COMPLETO.txt"
      delegate_to: localhost

  post_tasks:
    - name: Mostrar resumen de evidencias generadas
      debug:
        msg:
          - ""
          - "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          - "โ     EVIDENCIAS DE AUTOMATIZACIรN GENERADAS                 โ"
          - "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          - ""
          - "๐ Ubicaciรณn: {{ evidence_base }}"
          - ""
          - "Archivos generados:"
          - "  โ 00_REPORTE_COMPLETO.txt"
          - "  โ 01_tareas_cron.txt"
          - "  โ 02_scripts.txt"
          - "  โ 03_logs_backup.txt"
          - "  โ 04_logs_monitoreo.txt"
          - "  โ 05_estado_cron.txt"
          - "  โ 06_ejecuciones.txt"
          - "  โ 07_backups.txt"
          - ""
          - "๐ฏ Prรณximos pasos:"
          - "  1. Revisar: cat {{ evidence_reports }}/00_REPORTE_COMPLETO.txt"
          - "  2. Tomar capturas de pantalla"
          - "  3. Verificar ejecuciรณn de tareas"
          - ""
          - "๐ Nivel alcanzado: โญโญโญโญโญ"
          - "   'Automatizaciรณn robusta y validada'"
          - ""
      run_once: yes
