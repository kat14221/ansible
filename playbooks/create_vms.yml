---
# Playbook unificado para crear todas las VMs en ESXi
# Basado en los playbooks individuales existentes
# Uso: ansible-playbook playbooks/create_vms.yml -vvv

- name: Crear VM Debian Router
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Verificar conectividad con ESXi
      uri:
        url: "https://172.17.25.1/ui/"
        method: GET
        validate_certs: no
        timeout: 10
      register: esxi_check
      failed_when: false

    - name: Verificar si VM Router ya existe (m√©todo alternativo)
      community.vmware.vmware_vm_info:
        hostname: "172.17.25.1"
        username: "root"
        password: "qwe123$"
        validate_certs: no
        vm_name: "vm-debian-router"
      register: router_vm_info
      failed_when: false
      ignore_errors: yes

    - name: Crear VM Debian Router (si no existe)
      community.vmware.vmware_guest:
        hostname: "172.17.25.1"
        username: "root"
        password: "qwe123$"
        validate_certs: no
        datacenter: ha-datacenter
        folder: /vm
        name: vm-debian-router
        state: poweredon
        guest_id: debian11_64Guest
        disk:
          - size_gb: 20
            type: thin
            datastore: datastore1
        hardware:
          memory_mb: 2048
          num_cpus: 2
          scsi: paravirtual
        networks:
          - name: VM Network
            device_type: vmxnet3
          - name: Red Fernandez
            device_type: vmxnet3
        cdrom:
          - controller_number: 0
            unit_number: 0
            state: present
            type: iso
            iso_path: "[datastore1] debian/debian-13.1.0-amd64-netinst.iso"
        wait_for_ip_address: no
        force: no
      when: router_vm_info.virtual_machines is not defined or router_vm_info.virtual_machines | length == 0
      register: router_result



    - name: Mostrar resultado VM Router
      debug:
        msg:
          - "=========================================="
          - "‚úÖ VM Debian Router: {{ 'CREADA' if router_result.changed | default(false) else 'YA EXIST√çA' }}"
          - "Nombre: vm-debian-router"
          - "Estado: Encendida (creada con state=poweredon)"
          - "Memoria: 2048 MB"
          - "CPUs: 2"
          - "Disco: 20 GB"
          - "Redes: VM Network, Red Fernandez"
          - "ISO: debian-12.12.0-amd64-netinst.iso"
          - "Verificaci√≥n: {{ 'VM encontrada' if router_vm_info.virtual_machines is defined and router_vm_info.virtual_machines | length > 0 else 'VM nueva' }}"
          - "=========================================="

- name: Crear VM Ubuntu PC
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Verificar si VM Ubuntu ya existe
      community.vmware.vmware_vm_info:
        hostname: "172.17.25.1"
        username: "root"
        password: "qwe123$"
        validate_certs: no
        vm_name: "vm-ubuntu-pc"
      register: ubuntu_vm_info
      failed_when: false
      ignore_errors: yes

    - name: Crear VM Ubuntu PC (si no existe)
      community.vmware.vmware_guest:
        hostname: "172.17.25.1"
        username: "root"
        password: "qwe123$"
        validate_certs: no
        datacenter: ha-datacenter
        folder: /vm
        name: vm-ubuntu-pc
        state: poweredon
        guest_id: ubuntu64Guest
        disk:
          - size_gb: 25
            type: thin
            datastore: datastore1
        hardware:
          memory_mb: 4096
          num_cpus: 2
          scsi: paravirtual
        networks:
          - name: Red Fernandez
            device_type: vmxnet3
        cdrom:
          - controller_number: 0
            unit_number: 0
            state: present
            type: iso
            iso_path: "[datastore1] ubuntu/ubuntu-24.04.2-desktop-amd64.iso"
        wait_for_ip_address: no
        force: no
      when: ubuntu_vm_info.virtual_machines is not defined or ubuntu_vm_info.virtual_machines | length == 0
      register: ubuntu_result



    - name: Mostrar resultado VM Ubuntu
      debug:
        msg:
          - "=========================================="
          - "‚úÖ VM Ubuntu PC: {{ 'CREADA' if ubuntu_result.changed | default(false) else 'YA EXIST√çA' }}"
          - "Nombre: vm-ubuntu-pc"
          - "Estado: Encendida (creada con state=poweredon)"
          - "Memoria: 4096 MB"
          - "CPUs: 2"
          - "Disco: 25 GB"
          - "Red: Red Fernandez"
          - "ISO: ubuntu-24.04.2-desktop-amd64.iso"
          - "Verificaci√≥n: {{ 'VM encontrada' if ubuntu_vm_info.virtual_machines is defined and ubuntu_vm_info.virtual_machines | length > 0 else 'VM nueva' }}"
          - "=========================================="

- name: Crear VM Windows PC
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Verificar si VM Windows ya existe
      community.vmware.vmware_vm_info:
        hostname: "172.17.25.1"
        username: "root"
        password: "qwe123$"
        validate_certs: no
        vm_name: "vm-windows-pc"
      register: windows_vm_info
      failed_when: false
      ignore_errors: yes

    - name: Crear VM Windows PC (si no existe)
      community.vmware.vmware_guest:
        hostname: "172.17.25.1"
        username: "root"
        password: "qwe123$"
        validate_certs: no
        datacenter: ha-datacenter
        folder: /vm
        name: vm-windows-pc
        state: poweredon
        guest_id: windows9Server64Guest
        disk:
          - size_gb: 40
            type: thin
            datastore: datastore1
        hardware:
          memory_mb: 4096
          num_cpus: 2
          scsi: paravirtual
          boot_firmware: efi
          version: 14
        networks:
          - name: Red Fernandez
            device_type: vmxnet3
        cdrom:
          - controller_number: 0
            unit_number: 0
            state: present
            type: iso
            iso_path: "[datastore1] W-11/Win11_25H2_Spanish_x64.iso"
        wait_for_ip_address: no
        force: no
      when: windows_vm_info.virtual_machines is not defined or windows_vm_info.virtual_machines | length == 0
      register: windows_result



    - name: Mostrar resultado VM Windows
      debug:
        msg:
          - "=========================================="
          - "‚úÖ VM Windows PC: {{ 'CREADA' if windows_result.changed | default(false) else 'YA EXIST√çA' }}"
          - "Nombre: vm-windows-pc"
          - "Estado: Encendida (creada con state=poweredon)"
          - "Memoria: 4096 MB"
          - "CPUs: 2"
          - "Disco: 40 GB"
          - "Red: Red Fernandez"
          - "ISO: Win11_25H2_Spanish_x64.iso"
          - "Firmware: EFI (compatible con Windows 11)"
          - "Nota: TPM se omite para evitar requisitos de virtualizaci√≥n anidada"
          - "Verificaci√≥n: {{ 'VM encontrada' if windows_vm_info.virtual_machines is defined and windows_vm_info.virtual_machines | length > 0 else 'VM nueva' }}"
          - "=========================================="

- name: Resumen Final de Creaci√≥n
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Mostrar resumen completo
      debug:
        msg:
          - "================================================"
          - "üéâ CREACI√ìN DE VMs COMPLETADA"
          - "================================================"
          - ""
          - "‚úÖ VMs creadas y encendidas:"
          - "   ‚Ä¢ vm-debian-router (Debian 12) - 2GB RAM, 20GB disk"
          - "   ‚Ä¢ vm-ubuntu-pc (Ubuntu 24.04) - 4GB RAM, 25GB disk"
          - "   ‚Ä¢ vm-windows-pc (Windows 11) - 4GB RAM, 40GB disk"
          - ""
          - "üåê Todas conectadas a 'Red Fernandez'"
          - "üìÄ ISOs montadas autom√°ticamente"
          - "‚ö° VMs encendidas y listas para instalaci√≥n"
          - ""
          - "üìã PR√ìXIMOS PASOS MANUALES:"
          - "================================================"
          - ""
          - "1. üñ•Ô∏è  ACCEDER A ESXi:"
          - "   URL: https://172.17.25.1/ui/"
          - "   Usuario: root"
          - "   Contrase√±a: qwe123$"
          - ""
          - "2. üíø INSTALAR SISTEMAS OPERATIVOS (MANUAL):"
          - "   ‚ö†Ô∏è  IMPORTANTE: Consultar INSTALACION_VMS.md para configuraci√≥n detallada"
          - ""
          - "   üìÄ vm-debian-router (Debian 12):"
          - "   ‚Ä¢ Hostname: debian-router"
          - "   ‚Ä¢ Usuario: ansible / Password: Ansible123!"
          - "   ‚Ä¢ Particiones: /boot(512MB), swap(2GB), /(15GB), /home(2.5GB)"
          - "   ‚Ä¢ IP est√°tica: 172.17.25.126/24"
          - "   ‚Ä¢ SSH server + utilidades est√°ndar"
          - ""
          - "   üìÄ vm-ubuntu-pc (Ubuntu 24.04):"
          - "   ‚Ä¢ Hostname: ubuntu-pc"
          - "   ‚Ä¢ Usuario: ansible / Password: Ansible123!"
          - "   ‚Ä¢ Particiones: /boot/efi(1GB), swap(2GB), /(20GB), /home(2GB)"
          - "   ‚Ä¢ OpenSSH server"
          - ""
          - "   üìÄ vm-windows-pc (Windows 11):"
          - "   ‚Ä¢ Hostname: windows-pc"
          - "   ‚Ä¢ Usuario: ansible / Password: Ansible123!"
          - "   ‚Ä¢ Particionamiento autom√°tico (40GB)"
          - "   ‚Ä¢ Configurar WinRM para Ansible"
          - ""
          - "3. ‚öôÔ∏è  POST-INSTALACI√ìN (DESPU√âS del SO):"
          - "   Solo en VMs Linux (Debian y Ubuntu):"
          - ""
          - "   ‚Ä¢ Crear usuario ansible:"
          - "     sudo adduser ansible"
          - "     sudo usermod -aG sudo ansible"
          - ""
          - "   ‚Ä¢ Configurar sudo sin contrase√±a:"
          - "     echo 'ansible ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/ansible"
          - ""
          - "   ‚Ä¢ Verificar SSH:"
          - "     sudo systemctl status ssh"
          - "     sudo systemctl enable ssh"
          - ""
          - "4. üåê CONFIGURAR RED EN vm-debian-router (POST-INSTALACI√ìN):"
          - "   Editar /etc/network/interfaces:"
          - ""
          - "   # Interfaz de gesti√≥n"
          - "   auto ens160"
          - "   iface ens160 inet static"
          - "   address 172.17.25.126"
          - "   netmask 255.255.255.0"
          - "   gateway 172.17.25.1"
          - ""
          - "   # Interfaz del proyecto (se configurar√° con Ansible)"
          - "   auto ens192"
          - "   iface ens192 inet6 static"
          - "   address 2025:db8:101::1"
          - "   netmask 64"
          - ""
          - "5. üîë COPIAR CLAVES SSH (cuando VMs est√©n listas):"
          - "   ./scripts/copy_ssh_keys.sh"
          - ""
          - "6. üöÄ CONTINUAR CON CONFIGURACI√ìN AUTOM√ÅTICA:"
          - "   ansible-playbook playbooks/site.yml --tags debian,services -vvv"
          - ""
          - "================================================"
          - "üìñ GU√çA DETALLADA: Ver archivo INSTALACION_VMS.md"
          - "‚è±Ô∏è  Tiempo estimado de instalaci√≥n manual: 60-90 min"
          - "üéØ Despu√©s de esto, todo ser√° autom√°tico con Ansible"
          - "================================================"