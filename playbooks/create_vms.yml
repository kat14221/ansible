---
# Playbook unificado para crear todas las VMs en ESXi
# Uso: ansible-playbook playbooks/create_vms.yml -vvv

- name: Definir y Crear VMs en ESXi
  hosts: localhost
  gather_facts: no
  vars:
    esxi_hostname: "172.17.25.1"
    esxi_username: "root"
    esxi_password: "qwe123$"
    vms_to_create:
      - name: "vm-debian-router"
        guest_id: "otherLinux64Guest"
        disk_gb: 20
        disk_type: "thin"
        memory_mb: 2048
        num_cpus: 2
        scsi: "paravirtual"
        networks:
          - { name: "VM Network", device_type: "vmxnet3" }
          - { name: "Red Fernandez", device_type: "vmxnet3" }
        iso_path: "[datastore1] debian/debian-13.1.0-amd64-netinst.iso"
      - name: "vm-ubuntu-pc"
        guest_id: "ubuntu64Guest"
        disk_gb: 25
        disk_type: "thin"
        memory_mb: 4096
        num_cpus: 2
        scsi: "paravirtual"
        networks:
          - { name: "Red Fernandez", device_type: "vmxnet3" }
        iso_path: "[datastore1] ubuntu/ubuntu-24.04.2-desktop-amd64.iso"
      - name: "vm-windows-pc"
        guest_id: "windows11_64Guest"
        disk_gb: 40
        disk_type: "thick"
        memory_mb: 8192
        num_cpus: 4
        scsi: "lsilogicsas"
        boot_firmware: "efi"
        networks:
          - { name: "VM Network", device_type: "e1000e" }
          - { name: "Red Fernandez", device_type: "e1000e" }
        iso_path: "[datastore1] W-11/Win11_25H2_Spanish_x64.iso"

  tasks:
    - name: Verificar conectividad con ESXi
      uri:
        url: "https://172.17.25.1/ui/"
        method: GET
        validate_certs: no
        timeout: 10
      register: esxi_check
      failed_when: false

    - name: Obtener informaci√≥n de todas las VMs existentes
      community.vmware.vmware_vm_info:
        hostname: "{{ esxi_hostname }}"
        username: "{{ esxi_username }}"
        password: "{{ esxi_password }}"
        validate_certs: no
      register: existing_vms_info

    - name: Crear VMs si no existen
      community.vmware.vmware_guest:
        hostname: "{{ esxi_hostname }}"
        username: "{{ esxi_username }}"
        password: "{{ esxi_password }}"
        validate_certs: no
        datacenter: ha-datacenter
        folder: /vm
        name: "{{ item.name }}"
        state: poweredon
        guest_id: "{{ item.guest_id }}"
        disk:
          - size_gb: "{{ item.disk_gb }}"
            type: "{{ item.disk_type }}"
            datastore: datastore1
        hardware:
          memory_mb: "{{ item.memory_mb }}"
          num_cpus: "{{ item.num_cpus }}"
          scsi: "{{ item.scsi }}"
          boot_firmware: "{{ item.boot_firmware | default(omit) }}"
        networks: "{{ item.networks }}"
        cdrom:
          - controller_number: 0
            unit_number: 0
            state: present
            type: iso
            iso_path: "{{ item.iso_path }}"
        wait_for_ip_address: no
        force: no
      loop: "{{ vms_to_create }}"
      when: "item.name not in existing_vms_info.virtual_machines"
      register: vm_creation_results

    - name: Mostrar resultado VM Router
      debug:
        msg: "‚úÖ VM {{ item.item.name }}: {{ 'CREADA' if item.changed else 'YA EXIST√çA' }}"
      loop: "{{ vm_creation_results.results }}"
      when: item.skipped is not defined or not item.skipped

- name: Resumen Final de Creaci√≥n
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Mostrar resumen completo
      debug:
        msg:
          - "================================================"
          - "üéâ CREACI√ìN DE VMs COMPLETADA"
          - "================================================"
          - ""
          - "‚úÖ VMs creadas y encendidas:"
          - "   ‚Ä¢ vm-debian-router (Debian 12) - 2GB RAM, 20GB disk"
          - "   ‚Ä¢ vm-ubuntu-pc (Ubuntu 24.04) - 4GB RAM, 25GB disk"
          - "   ‚Ä¢ vm-windows-pc (Windows 11) - 8GB RAM, 40GB disk"
          - ""
          - "üåê Todas conectadas a 'Red Fernandez'"
          - "üìÄ ISOs montadas autom√°ticamente"
          - "‚ö° VMs encendidas y listas para instalaci√≥n"
          - ""
          - "üìã PR√ìXIMOS PASOS MANUALES:"
          - "================================================"
          - ""
          - "1. üñ•Ô∏è  ACCEDER A ESXi:"
          - "   URL: https://172.17.25.1/ui/"
          - "   Usuario: root"
          - "   Contrase√±a: qwe123$"
          - ""
          - "2. üíø INSTALAR SISTEMAS OPERATIVOS (MANUAL):"
          - "   ‚ö†Ô∏è  IMPORTANTE: Consultar INSTALACION_VMS.md para configuraci√≥n detallada"
          - ""
          - "   üìÄ vm-debian-router (Debian 12):"
          - "   ‚Ä¢ Hostname: debian-router"
          - "   ‚Ä¢ Usuario: ansible / Password: Ansible123!"
          - "   ‚Ä¢ Particiones: /boot(512MB), swap(2GB), /(15GB), /home(2.5GB)"
          - "   ‚Ä¢ IP est√°tica: 172.17.25.126/24"
          - "   ‚Ä¢ SSH server + utilidades est√°ndar"
          - ""
          - "   üìÄ vm-ubuntu-pc (Ubuntu 24.04):"
          - "   ‚Ä¢ Hostname: ubuntu-pc"
          - "   ‚Ä¢ Usuario: ansible / Password: Ansible123!"
          - "   ‚Ä¢ Particiones: /boot/efi(1GB), swap(2GB), /(20GB), /home(2GB)"
          - "   ‚Ä¢ OpenSSH server"
          - ""
          - "   üìÄ vm-windows-pc (Windows 11):"
          - "   ‚Ä¢ Hostname: windows-pc"
          - "   ‚Ä¢ Usuario: ansible / Password: Ansible123!"
          - "   ‚Ä¢ Particionamiento autom√°tico (40GB)"
          - "   ‚Ä¢ Configurar WinRM para Ansible"
          - ""
          - "3. ‚öôÔ∏è  POST-INSTALACI√ìN (DESPU√âS del SO):"
          - "   Solo en VMs Linux (Debian y Ubuntu):"
          - ""
          - "   ‚Ä¢ Crear usuario ansible:"
          - "     sudo adduser ansible"
          - "     sudo usermod -aG sudo ansible"
          - ""
          - "   ‚Ä¢ Configurar sudo sin contrase√±a:"
          - "     echo 'ansible ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/ansible"
          - ""
          - "   ‚Ä¢ Verificar SSH:"
          - "     sudo systemctl status ssh"
          - "     sudo systemctl enable ssh"
          - ""
          - "4. üåê CONFIGURAR RED EN vm-debian-router (POST-INSTALACI√ìN):"
          - "   Editar /etc/network/interfaces:"
          - ""
          - "   # Interfaz de gesti√≥n"
          - "   auto ens160"
          - "   iface ens160 inet static"
          - "   address 172.17.25.126"
          - "   netmask 255.255.255.0"
          - "   gateway 172.17.25.1"
          - ""
          - "   # Interfaz del proyecto (se configurar√° con Ansible)"
          - "   auto ens192"
          - "   iface ens192 inet6 static"
          - "   address 2025:db8:101::1"
          - "   netmask 64"
          - ""
          - "5. üîë COPIAR CLAVES SSH (cuando VMs est√©n listas):"
          - "   ./scripts/copy_ssh_keys.sh"
          - ""
          - "6. üöÄ CONTINUAR CON CONFIGURACI√ìN AUTOM√ÅTICA:"
          - "   ansible-playbook playbooks/site.yml --tags debian,services -vvv"
          - ""
          - "================================================"
          - "üìñ GU√çA DETALLADA: Ver archivo INSTALACION_VMS.md"
          - "‚è±Ô∏è  Tiempo estimado de instalaci√≥n manual: 60-90 min"
          - "üéØ Despu√©s de esto, todo ser√° autom√°tico con Ansible"
          - "================================================"