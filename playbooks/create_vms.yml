---
# Playbook espec√≠fico para crear VMs en ESXi
# Uso: ansible-playbook playbooks/create_vms.yml -vvv

- name: Crear VM Debian Router
  hosts: localhost
  gather_facts: no
  vars:
    esxi_host: "{{ hostvars['esxi-vmware-host'] }}"
    router_config: "{{ hostvars['debian-router'] }}"
  tasks:
    - name: Debug - Mostrar configuraci√≥n
      debug:
        msg:
          - "ESXi Host: {{ esxi_host.vcenter_hostname }}"
          - "VM Name: {{ router_config.vm_name }}"
          - "ISO: {{ router_config.cdrom }}"

    - name: Verificar si VM Router ya existe
      community.vmware.vmware_guest_info:
        hostname: "{{ esxi_host.vcenter_hostname }}"
        username: "{{ esxi_host.vcenter_username }}"
        password: "{{ esxi_host.vcenter_password }}"
        validate_certs: "{{ esxi_host.vcenter_validate_certs }}"
        datacenter: "{{ esxi_host.datacenter }}"
        name: "{{ router_config.vm_name }}"
      register: router_vm_info
      failed_when: false

    - name: Crear VM Debian Router si no existe
      community.vmware.vmware_guest:
        hostname: "{{ esxi_host.vcenter_hostname }}"
        username: "{{ esxi_host.vcenter_username }}"
        password: "{{ esxi_host.vcenter_password }}"
        validate_certs: "{{ esxi_host.vcenter_validate_certs }}"
        datacenter: "{{ esxi_host.datacenter }}"
        name: "{{ router_config.vm_name }}"
        state: present
        folder: "{{ router_config.vm_folder }}"
        datastore: "{{ esxi_host.datastore }}"
        guest_id: debian11_64Guest
        hardware:
          memory_mb: 2048
          num_cpus: 2
          scsi: paravirtual
        disk:
          - size_gb: 20
            type: thin
        cdrom:
          - controller_number: 0
            controller_type: ide
            type: iso
            iso_path: "{{ router_config.cdrom }}"
            state: present
            unit_number: 0
        networks:
          - name: "{{ router_config.networks[0].name }}"
            device_type: vmxnet3
          - name: "{{ router_config.networks[1].name }}"
            device_type: vmxnet3
        force: yes
      when: router_vm_info.instance is not defined
      register: router_creation

    - name: Encender VM Router
      community.vmware.vmware_guest:
        hostname: "{{ esxi_host.vcenter_hostname }}"
        username: "{{ esxi_host.vcenter_username }}"
        password: "{{ esxi_host.vcenter_password }}"
        validate_certs: "{{ esxi_host.vcenter_validate_certs }}"
        name: "{{ router_config.vm_name }}"
        state: poweredon

    - name: Mostrar resultado
      debug:
        msg:
          - "================================================"
          - "VM Debian Router: {{ 'CREADA' if router_vm_info.instance is not defined else 'YA EXIST√çA' }}"
          - "Nombre: {{ router_config.vm_name }}"
          - "Estado: Encendida"
          - "ISO montada: {{ router_config.cdrom }}"
          - "Redes: {{ router_config.networks[0].name }}, {{ router_config.networks[1].name }}"
          - ""
          - "‚ö†Ô∏è  SIGUIENTE PASO MANUAL:"
          - "1. Conectar a ESXi Web UI"
          - "2. Abrir consola de la VM"
          - "3. Instalar Debian 12 desde ISO"
          - "4. Configurar usuario 'ansible' con sudo"
          - "5. Configurar SSH"
          - "6. Configurar red de gesti√≥n (172.17.25.126)"
          - "================================================"

- name: Crear VMs de Usuario
  hosts: localhost
  gather_facts: no
  vars:
    esxi_host: "{{ hostvars['esxi-vmware-host'] }}"
    ubuntu_config: "{{ hostvars['ubuntu-pc'] }}"
    windows_config: "{{ hostvars['windows-pc'] }}"
  tasks:
    - name: Crear VM Ubuntu PC
      community.vmware.vmware_guest:
        hostname: "{{ esxi_host.vcenter_hostname }}"
        username: "{{ esxi_host.vcenter_username }}"
        password: "{{ esxi_host.vcenter_password }}"
        validate_certs: "{{ esxi_host.vcenter_validate_certs }}"
        datacenter: "{{ esxi_host.datacenter }}"
        name: "{{ ubuntu_config.vm_name }}"
        state: present
        folder: "{{ ubuntu_config.vm_folder }}"
        datastore: "{{ esxi_host.datastore }}"
        guest_id: ubuntu64Guest
        hardware:
          memory_mb: 2048
          num_cpus: 2
          scsi: paravirtual
        disk:
          - size_gb: 25
            type: thin
        cdrom:
          - controller_number: 0
            controller_type: ide
            type: iso
            iso_path: "{{ ubuntu_config.cdrom }}"
            state: present
            unit_number: 0
        networks:
          - name: "{{ ubuntu_config.networks[0].name }}"
            device_type: vmxnet3
        force: yes

    - name: Crear VM Windows PC
      community.vmware.vmware_guest:
        hostname: "{{ esxi_host.vcenter_hostname }}"
        username: "{{ esxi_host.vcenter_username }}"
        password: "{{ esxi_host.vcenter_password }}"
        validate_certs: "{{ esxi_host.vcenter_validate_certs }}"
        datacenter: "{{ esxi_host.datacenter }}"
        name: "{{ windows_config.vm_name }}"
        state: present
        folder: "{{ windows_config.vm_folder }}"
        datastore: "{{ esxi_host.datastore }}"
        guest_id: windows11_64Guest
        hardware:
          memory_mb: 4096
          num_cpus: 2
          scsi: paravirtual
        disk:
          - size_gb: 40
            type: thin
        cdrom:
          - controller_number: 0
            controller_type: ide
            type: iso
            iso_path: "{{ windows_config.cdrom }}"
            state: present
            unit_number: 0
        networks:
          - name: "{{ windows_config.networks[0].name }}"
            device_type: vmxnet3
        force: yes

    - name: Mostrar resumen final
      debug:
        msg:
          - "================================================"
          - "‚úÖ CREACI√ìN DE VMs COMPLETADA"
          - "================================================"
          - ""
          - "VMs creadas:"
          - "  ‚Ä¢ {{ ubuntu_config.vm_name }} (Ubuntu)"
          - "  ‚Ä¢ {{ windows_config.vm_name }} (Windows)"
          - "  ‚Ä¢ {{ hostvars['debian-router'].vm_name }} (Debian Router)"
          - ""
          - "üìã Pr√≥ximos pasos manuales:"
          - "1. Instalar SO en cada VM desde consola ESXi"
          - "2. Configurar usuario 'ansible' en VMs Linux"
          - "3. Configurar SSH en VMs Linux"
          - "4. Configurar IPs de gesti√≥n"
          - "5. Copiar claves SSH: ./scripts/copy_ssh_keys.sh"
          - "6. Continuar con: ansible-playbook playbooks/site.yml --tags debian,services"
          - "================================================"