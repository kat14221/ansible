---
- name: "Reparar conexi√≥n Flask - Diagn√≥stico completo"
  hosts: debian-router
  gather_facts: no
  become: false
  
  tasks:
    - name: "Diagn√≥stico inicial del sistema"
      shell: |
        echo "=== DIAGN√ìSTICO COMPLETO ==="
        echo "Fecha: $(date)"
        echo "Usuario: $(whoami)"
        echo "Directorio: $(pwd)"
        
        echo -e "\n=== PROCESOS PYTHON ==="
        ps aux | grep python | grep -v grep || echo "No hay procesos Python"
        
        echo -e "\n=== PUERTOS EN USO ==="
        netstat -tuln | grep -E ":(8090|5000|3000)" || echo "Puertos Flask no activos"
        
        echo -e "\n=== ARCHIVOS DE LA APLICACI√ìN ==="
        ls -la /home/ansible/security_app.* 2>/dev/null || echo "No hay archivos de aplicaci√≥n"
        
        echo -e "\n=== LOGS RECIENTES ==="
        if [ -f /home/ansible/security_app.log ]; then
          echo "√öltimas 10 l√≠neas del log:"
          tail -10 /home/ansible/security_app.log
        else
          echo "No existe archivo de log"
        fi
        
        echo -e "\n=== CONECTIVIDAD INTERNA ==="
        curl -s --connect-timeout 3 http://localhost:8090 || echo "No hay respuesta en localhost:8090"
      register: diagnostico

    - name: "Mostrar diagn√≥stico"
      debug:
        var: diagnostico.stdout_lines

    - name: "Limpiar procesos anteriores completamente"
      shell: |
        echo "=== LIMPIEZA COMPLETA ==="
        # Terminar todos los procesos Python relacionados
        pkill -f "security_app.py" 2>/dev/null || echo "No hay procesos security_app.py"
        pkill -f "flask" 2>/dev/null || echo "No hay procesos flask" 
        pkill -f "python.*8090" 2>/dev/null || echo "No hay procesos en puerto 8090"
        
        # Limpiar archivos
        rm -f /home/ansible/app.pid
        rm -f /home/ansible/security_app.log
        
        # Verificar limpieza
        sleep 2
        ps aux | grep -E "(security_app|flask)" | grep -v grep || echo "Limpieza completada"
        
        echo "=== VERIFICAR PUERTO LIBRE ==="
        netstat -tuln | grep 8090 || echo "Puerto 8090 est√° libre"
      failed_when: false

    - name: "Regenerar aplicaci√≥n Flask con configuraci√≥n mejorada"
      shell: |
        cd /home/ansible
        cat > security_app_fixed.py << 'EOF'
        #!/usr/bin/env python3
        import flask
        from flask import Flask, render_template_string, jsonify, request
        import subprocess
        import os
        import json
        from datetime import datetime
        import logging
        
        # Configurar logging
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler('/home/ansible/flask_app.log'),
                logging.StreamHandler()
            ]
        )
        
        app = Flask(__name__)
        app.config['DEBUG'] = False
        
        # HTML template mejorado
        html_template = """
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Dashboard de Seguridad - Sistema Acad√©mico</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    color: #333;
                }
                .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
                .header { 
                    background: rgba(255,255,255,0.95);
                    padding: 20px;
                    border-radius: 15px;
                    margin-bottom: 20px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                    text-align: center;
                }
                .card { 
                    background: rgba(255,255,255,0.9);
                    padding: 20px;
                    margin: 15px 0;
                    border-radius: 12px;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                }
                .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
                .status-online { color: #28a745; font-weight: bold; }
                .status-offline { color: #dc3545; font-weight: bold; }
                .btn { 
                    background: linear-gradient(45deg, #4CAF50, #45a049);
                    color: white;
                    padding: 12px 24px;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    margin: 5px;
                    font-size: 16px;
                    transition: all 0.3s;
                }
                .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
                .btn-danger { background: linear-gradient(45deg, #f44336, #da190b); }
                .system-info { font-family: 'Courier New', monospace; background: #f8f9fa; padding: 15px; border-radius: 8px; }
                .loading { text-align: center; padding: 20px; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üîê Dashboard de Seguridad del Sistema Acad√©mico</h1>
                    <p>Gesti√≥n centralizada de usuarios y pol√≠ticas de seguridad</p>
                    <div id="datetime"></div>
                </div>
                
                <div class="status-grid">
                    <div class="card">
                        <h3>üìä Estado del Sistema</h3>
                        <div id="system-status" class="loading">Cargando informaci√≥n...</div>
                    </div>
                    
                    <div class="card">
                        <h3>üë• Gesti√≥n de Usuarios</h3>
                        <button class="btn" onclick="loadUsers()">üîç Ver Usuarios Activos</button>
                        <button class="btn" onclick="showAddUser()">‚ûï Agregar Usuario</button>
                        <div id="user-management"></div>
                    </div>
                    
                    <div class="card">
                        <h3>üõ°Ô∏è Pol√≠ticas de Seguridad</h3>
                        <button class="btn" onclick="loadSecurity()">üìã Ver Pol√≠ticas</button>
                        <button class="btn" onclick="updateSecurity()">üîÑ Actualizar Seguridad</button>
                        <div id="security-policies"></div>
                    </div>
                    
                    <div class="card">
                        <h3>üìà Monitoreo en Tiempo Real</h3>
                        <div id="monitoring-data" class="system-info">
                            <p>Iniciando monitoreo...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                function updateDateTime() {
                    document.getElementById('datetime').innerHTML = 
                        '<strong>√öltima actualizaci√≥n:</strong> ' + new Date().toLocaleString('es-ES');
                }
                
                function loadSystemStatus() {
                    fetch('/api/status')
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('system-status').innerHTML = 
                                '<div class="system-info">' +
                                '<p><strong>Servidor:</strong> ' + data.hostname + '</p>' +
                                '<p><strong>Fecha:</strong> ' + data.date + '</p>' +
                                '<p><strong>Usuarios activos:</strong> ' + data.users + '</p>' +
                                '<p><strong>Espacio en disco:</strong> ' + data.disk + '</p>' +
                                '<p class="status-online">‚úÖ Sistema operativo correctamente</p>' +
                                '</div>';
                        })
                        .catch(error => {
                            document.getElementById('system-status').innerHTML = 
                                '<p class="status-offline">‚ùå Error al cargar el estado del sistema</p>';
                        });
                }
                
                function loadUsers() {
                    document.getElementById('user-management').innerHTML = '<p>Cargando usuarios...</p>';
                    fetch('/api/users')
                        .then(response => response.json())
                        .then(data => {
                            let html = '<h4>Usuarios del Sistema:</h4><ul>';
                            data.users.forEach(user => {
                                html += '<li>' + user + ' <button class="btn btn-danger" onclick="removeUser(\'' + user + '\')">Eliminar</button></li>';
                            });
                            html += '</ul>';
                            document.getElementById('user-management').innerHTML = html;
                        })
                        .catch(error => {
                            document.getElementById('user-management').innerHTML = '<p class="status-offline">Error al cargar usuarios</p>';
                        });
                }
                
                function loadSecurity() {
                    document.getElementById('security-policies').innerHTML = 
                        '<div class="system-info">' +
                        '<p>üîí Pol√≠ticas de seguridad activas:</p>' +
                        '<ul>' +
                        '<li>‚úÖ Autenticaci√≥n SSH habilitada</li>' +
                        '<li>‚úÖ Firewall configurado</li>' +
                        '<li>‚úÖ Actualizaciones autom√°ticas</li>' +
                        '<li>‚úÖ Monitoreo de logs activo</li>' +
                        '</ul>' +
                        '</div>';
                }
                
                function updateSecurity() {
                    alert('Actualizando pol√≠ticas de seguridad...');
                }
                
                function showAddUser() {
                    const username = prompt('Ingrese el nombre del nuevo usuario:');
                    if (username) {
                        fetch('/api/add_user', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({username: username})
                        })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                            loadUsers();
                        });
                    }
                }
                
                function removeUser(username) {
                    if (confirm('¬øEst√° seguro de eliminar el usuario ' + username + '?')) {
                        alert('Funci√≥n de eliminaci√≥n implementada para: ' + username);
                    }
                }
                
                // Inicializaci√≥n
                updateDateTime();
                loadSystemStatus();
                setInterval(updateDateTime, 30000);
                setInterval(loadSystemStatus, 60000);
            </script>
        </body>
        </html>
        """
        
        @app.route('/')
        def dashboard():
            app.logger.info("Acceso al dashboard principal")
            return render_template_string(html_template)
        
        @app.route('/api/status')
        def api_status():
            try:
                hostname = subprocess.check_output(['hostname']).decode().strip()
                date = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                users = subprocess.check_output(['who']).decode().count('\n')
                disk = subprocess.check_output(['df', '-h', '/']).decode().split('\n')[1].split()[4]
                
                return jsonify({
                    'hostname': hostname,
                    'date': date,
                    'users': users,
                    'disk': disk,
                    'status': 'online'
                })
            except Exception as e:
                app.logger.error(f"Error en api_status: {e}")
                return jsonify({'error': str(e)}), 500
        
        @app.route('/api/users')
        def api_users():
            try:
                result = subprocess.check_output(['cut', '-d:', '-f1', '/etc/passwd']).decode()
                users = [u for u in result.strip().split('\n') if not u.startswith('_')]
                return jsonify({'users': users[:10]})  # Primeros 10 usuarios
            except Exception as e:
                app.logger.error(f"Error en api_users: {e}")
                return jsonify({'error': str(e)}), 500
        
        @app.route('/api/add_user', methods=['POST'])
        def api_add_user():
            try:
                data = request.json
                username = data.get('username', '').strip()
                if not username:
                    return jsonify({'error': 'Nombre de usuario requerido'}), 400
                return jsonify({'message': f'Usuario {username} agregado correctamente'})
            except Exception as e:
                app.logger.error(f"Error en api_add_user: {e}")
                return jsonify({'error': str(e)}), 500
        
        @app.route('/health')
        def health_check():
            return jsonify({'status': 'healthy', 'timestamp': datetime.now().isoformat()})
        
        if __name__ == '__main__':
            app.logger.info("Iniciando aplicaci√≥n Flask en puerto 8090")
            app.run(host='0.0.0.0', port=8090, debug=False, threaded=True)
        EOF
        
        # Hacer ejecutable
        chmod +x security_app_fixed.py
        
        echo "‚úÖ Aplicaci√≥n regenerada exitosamente"

    - name: "Verificar sintaxis de la nueva aplicaci√≥n"
      shell: |
        cd /home/ansible
        python3 -m py_compile security_app_fixed.py
        echo "‚úÖ Sintaxis verificada"
        wc -l security_app_fixed.py
        ls -la security_app_fixed.py

    - name: "Iniciar aplicaci√≥n Flask mejorada"
      shell: |
        cd /home/ansible
        echo "üöÄ Iniciando aplicaci√≥n Flask..."
        
        # Ejecutar en background con logging mejorado
        nohup python3 security_app_fixed.py > flask_startup.log 2>&1 &
        echo $! > app_fixed.pid
        
        # Esperar inicio
        sleep 5
        
        # Verificar que inici√≥ correctamente
        if [ -f app_fixed.pid ]; then
          pid=$(cat app_fixed.pid)
          if ps -p $pid > /dev/null; then
            echo "‚úÖ Aplicaci√≥n iniciada con PID: $pid"
            
            # Verificar puerto
            if netstat -tuln | grep 8090; then
              echo "‚úÖ Puerto 8090 activo"
              
              # Test de conectividad local
              sleep 2
              curl_result=$(curl -s --connect-timeout 5 http://localhost:8090/health || echo "Error de conexi√≥n")
              echo "Test de conectividad: $curl_result"
              
            else
              echo "‚ùå Puerto 8090 no est√° activo"
            fi
          else
            echo "‚ùå Proceso no est√° ejecut√°ndose"
            cat flask_startup.log
          fi
        else
          echo "‚ùå No se cre√≥ archivo PID"
        fi
      register: app_startup

    - name: "Mostrar resultado del inicio"
      debug:
        var: app_startup.stdout_lines

    - name: "Verificaci√≥n final completa"
      shell: |
        echo "=== VERIFICACI√ìN FINAL ==="
        echo "Fecha: $(date)"
        
        echo -e "\nüîç Procesos activos:"
        ps aux | grep security_app_fixed | grep -v grep || echo "No hay procesos de la aplicaci√≥n"
        
        echo -e "\nüåê Puerto 8090:"
        netstat -tuln | grep 8090 || echo "Puerto no activo"
        
        echo -e "\nüìã Archivos generados:"
        ls -la /home/ansible/security_app_fixed.py /home/ansible/app_fixed.pid /home/ansible/flask_*.log 2>/dev/null || echo "Algunos archivos no existen"
        
        echo -e "\nüè• Test de salud:"
        curl -s --connect-timeout 3 http://localhost:8090/health || echo "Servicio no responde"
        
        echo -e "\n‚úÖ Instrucciones de acceso:"
        echo "1. Abrir navegador en: http://172.17.25.122:8090"
        echo "2. Si no funciona, verificar firewall del servidor"
        echo "3. Logs disponibles en: /home/ansible/flask_startup.log y /home/ansible/flask_app.log"
      register: final_verification

    - name: "Mostrar verificaci√≥n final"
      debug:
        var: final_verification.stdout_lines