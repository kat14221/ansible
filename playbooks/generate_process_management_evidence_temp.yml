---
# Playbook: GeneraciÃ³n de Evidencias - GestiÃ³n de Procesos y Servicios
# PropÃ³sito: Demostrar competencia en control y optimizaciÃ³n de procesos
# Fecha: 2025-11-25

- name: Generar Evidencias de GestiÃ³n de Procesos y Servicios
  hosts: debian_router
  become: yes
  gather_facts: yes
  
  vars:
    evidence_dir: "evidence/gestion_procesos"
    timestamp: "{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}"
  
  tasks:
    # ========================================
    # PREPARACIÃ“N
    # ========================================
    - name: Crear directorio de evidencias local
      file:
        path: "{{ evidence_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: no
      run_once: true

    - name: Crear directorio temporal en servidor remoto
      file:
        path: "/tmp/gestion_procesos"
        state: directory
        mode: '0755'
      become: yes

    - name: Crear archivo de inicio
      copy:
        dest: "/tmp/gestion_procesos/00_INICIO.txt"
        content: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘   EVIDENCIAS: GESTIÃ“N DE PROCESOS Y SERVICIOS                    â•‘
          â•‘   Proyecto: VMWARE-101001 - Red AcadÃ©mica IPv6                   â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Fecha: {{ ansible_date_time.date }}
          Hora: {{ ansible_date_time.time }}
          Host: {{ inventory_hostname }}
          Sistema: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          OBJETIVO:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Demostrar competencia en:
          âœ“ GestiÃ³n de servicios con systemd
          âœ“ Monitoreo de procesos en tiempo real
          âœ“ AnÃ¡lisis de uso de recursos (CPU, Memoria)
          âœ“ Control de prioridades de procesos
          âœ“ OptimizaciÃ³n de servicios crÃ­ticos
          âœ“ ConfiguraciÃ³n de arranque automÃ¡tico
          âœ“ Troubleshooting de servicios
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      become: yes

    - name: Descargar archivo de inicio a local
      fetch:
        src: "/tmp/gestion_procesos/00_INICIO.txt"
        dest: "/tmp/gestion_procesos/00_INICIO.txt"
        flat: yes

    # ========================================
    # 1. INVENTARIO DE SERVICIOS CRÃTICOS
    # ========================================
    - name: "EVIDENCIA 1: Listar todos los servicios systemd"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  1. INVENTARIO COMPLETO DE SERVICIOS SYSTEMD"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Todos los servicios (activos e inactivos) ---"
        systemctl list-units --type=service --all --no-pager
        echo ""
        echo "--- Resumen por estado ---"
        systemctl list-units --type=service --no-pager | tail -1
      register: all_services
      changed_when: false

    - name: Guardar inventario de servicios en servidor
      copy:
        dest: "/tmp/gestion_procesos/01_inventario_servicios.txt"
        content: "{{ all_services.stdout }}"
      become: yes

    - name: Descargar inventario de servicios a local
      fetch:
        src: "/tmp/gestion_procesos/01_inventario_servicios.txt"
        dest: "/tmp/gestion_procesos/01_inventario_servicios.txt"
        flat: yes

    # ========================================
    # 2. ESTADO DE SERVICIOS CRÃTICOS
    # ========================================
    - name: "EVIDENCIA 2: Estado detallado de servicios crÃ­ticos"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  2. ESTADO DE SERVICIOS CRÃTICOS DEL LABORATORIO"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        for service in radvd isc-dhcp-server apache2 vsftpd ssh dnsmasq firewalld; do
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚  SERVICIO: $service"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          systemctl status $service --no-pager -l || echo "Servicio no encontrado o no activo"
          echo ""
          echo "--- ConfiguraciÃ³n de arranque ---"
          systemctl is-enabled $service 2>/dev/null || echo "N/A"
          echo ""
          echo "--- Procesos asociados ---"
          ps aux | grep -i $service | grep -v grep || echo "No hay procesos visibles"
          echo ""
          echo ""
        done
      register: critical_services
      changed_when: false

    - name: Guardar estado de servicios crÃ­ticos
      copy:
        dest: "/tmp/gestion_procesos/02_servicios_criticos.txt"
        content: "{{ critical_services.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 3. ANÃLISIS DE PROCESOS EN TIEMPO REAL
    # ========================================
    - name: "EVIDENCIA 3: Top 20 procesos por uso de CPU"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  3. ANÃLISIS DE PROCESOS - TOP 20 POR CPU"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        ps aux --sort=-%cpu | head -21
        echo ""
        echo "--- EstadÃ­sticas de CPU ---"
        mpstat 1 3 2>/dev/null || echo "mpstat no disponible (instalar sysstat)"
      register: top_cpu
      changed_when: false

    - name: Guardar anÃ¡lisis de CPU
      copy:
        dest: "/tmp/gestion_procesos/03_top_procesos_cpu.txt"
        content: "{{ top_cpu.stdout }}"
      delegate_to: localhost
      become: no

    - name: "EVIDENCIA 4: Top 20 procesos por uso de Memoria"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  4. ANÃLISIS DE PROCESOS - TOP 20 POR MEMORIA"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        ps aux --sort=-%mem | head -21
        echo ""
        echo "--- Resumen de memoria del sistema ---"
        free -h
        echo ""
        echo "--- Memoria por proceso (top 10) ---"
        ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head -11
      register: top_mem
      changed_when: false

    - name: Guardar anÃ¡lisis de memoria
      copy:
        dest: "/tmp/gestion_procesos/04_top_procesos_memoria.txt"
        content: "{{ top_mem.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 5. CONTROL DE SERVICIOS (START/STOP/RESTART)
    # ========================================
    - name: "EVIDENCIA 5: Demostrar control de servicios"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  5. CONTROL Y GESTIÃ“N DE SERVICIOS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Estado ANTES de reiniciar Apache2 ---"
        systemctl status apache2 --no-pager | head -15
        echo ""
        echo "--- REINICIANDO Apache2 ---"
        systemctl restart apache2
        sleep 2
        echo "âœ“ Servicio reiniciado exitosamente"
        echo ""
        echo "--- Estado DESPUÃ‰S de reiniciar Apache2 ---"
        systemctl status apache2 --no-pager | head -15
        echo ""
        echo "--- Tiempo de actividad del servicio ---"
        systemctl show apache2 --property=ActiveEnterTimestamp --no-pager
        echo ""
        echo "--- Logs recientes (Ãºltimas 10 lÃ­neas) ---"
        journalctl -u apache2 -n 10 --no-pager
      register: service_control
      changed_when: false

    - name: Guardar control de servicios
      copy:
        dest: "/tmp/gestion_procesos/05_control_servicios.txt"
        content: "{{ service_control.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 6. CONFIGURACIÃ“N DE ARRANQUE AUTOMÃTICO
    # ========================================
    - name: "EVIDENCIA 6: Verificar arranque automÃ¡tico"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  6. CONFIGURACIÃ“N DE ARRANQUE AUTOMÃTICO"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Servicios habilitados en el arranque ---"
        systemctl list-unit-files --type=service --state=enabled --no-pager
        echo ""
        echo "--- Servicios crÃ­ticos y su estado de arranque ---"
        echo ""
        for service in radvd isc-dhcp-server apache2 vsftpd ssh firewalld; do
          enabled=$(systemctl is-enabled $service 2>/dev/null || echo "N/A")
          echo "  $service: $enabled"
        done
        echo ""
        echo "--- AnÃ¡lisis de tiempos de arranque ---"
        systemd-analyze blame | head -20
      register: boot_config
      changed_when: false

    - name: Guardar configuraciÃ³n de arranque
      copy:
        dest: "/tmp/gestion_procesos/06_arranque_automatico.txt"
        content: "{{ boot_config.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 7. LOGS Y TROUBLESHOOTING
    # ========================================
    - name: "EVIDENCIA 7: AnÃ¡lisis de logs de servicios"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  7. LOGS Y TROUBLESHOOTING DE SERVICIOS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Logs de Apache2 (Ãºltimas 20 lÃ­neas) ---"
        journalctl -u apache2 -n 20 --no-pager
        echo ""
        echo "--- Logs de SSH (Ãºltimas 15 lÃ­neas) ---"
        journalctl -u ssh -n 15 --no-pager
        echo ""
        echo "--- Logs de RADVD (Ãºltimas 15 lÃ­neas) ---"
        journalctl -u radvd -n 15 --no-pager
        echo ""
        echo "--- Errores del sistema (Ãºltimas 10 lÃ­neas) ---"
        journalctl -p err -n 10 --no-pager
        echo ""
        echo "--- TamaÃ±o de archivos de log ---"
        du -sh /var/log/* 2>/dev/null | sort -hr | head -10
      register: service_logs
      changed_when: false

    - name: Guardar anÃ¡lisis de logs
      copy:
        dest: "/tmp/gestion_procesos/07_logs_servicios.txt"
        content: "{{ service_logs.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 8. PRIORIDADES Y NICE VALUES
    # ========================================
    - name: "EVIDENCIA 8: AnÃ¡lisis de prioridades de procesos"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  8. PRIORIDADES DE PROCESOS (NICE VALUES)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Top 20 procesos con sus prioridades ---"
        ps -eo pid,ni,pri,pcpu,pmem,comm --sort=-pcpu | head -21
        echo ""
        echo "--- ExplicaciÃ³n de columnas ---"
        echo "  PID:  Process ID"
        echo "  NI:   Nice value (-20 a 19, menor = mayor prioridad)"
        echo "  PRI:  Priority (kernel)"
        echo "  %CPU: Uso de CPU"
        echo "  %MEM: Uso de memoria"
        echo "  COMMAND: Nombre del proceso"
      register: process_priority
      changed_when: false

    - name: Guardar anÃ¡lisis de prioridades
      copy:
        dest: "/tmp/gestion_procesos/08_prioridades_procesos.txt"
        content: "{{ process_priority.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 9. RECURSOS DEL SISTEMA
    # ========================================
    - name: "EVIDENCIA 9: Monitoreo de recursos del sistema"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  9. RECURSOS DEL SISTEMA"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- InformaciÃ³n de CPU ---"
        lscpu | grep -E "CPU\(s\)|Model name|Thread|Core|Socket"
        echo ""
        echo "--- Uso de CPU por core ---"
        mpstat -P ALL 1 1 2>/dev/null || echo "mpstat no disponible"
        echo ""
        echo "--- Memoria RAM ---"
        free -h
        echo ""
        echo "--- Swap ---"
        swapon --show 2>/dev/null || echo "Sin swap configurado"
        echo ""
        echo "--- Load Average ---"
        uptime
        echo ""
        echo "--- Procesos en ejecuciÃ³n ---"
        echo "Total: $(ps aux | wc -l) procesos"
        echo "Por usuario:"
        ps aux | awk '{print $1}' | sort | uniq -c | sort -rn
        echo ""
        echo "--- Uso de disco ---"
        df -h | grep -v tmpfs
      register: system_resources
      changed_when: false

    - name: Guardar monitoreo de recursos
      copy:
        dest: "/tmp/gestion_procesos/09_recursos_sistema.txt"
        content: "{{ system_resources.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 10. DEPENDENCIAS DE SERVICIOS
    # ========================================
    - name: "EVIDENCIA 10: Ãrbol de dependencias de servicios"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  10. DEPENDENCIAS DE SERVICIOS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Dependencias de Apache2 ---"
        systemctl list-dependencies apache2 --no-pager
        echo ""
        echo "--- Dependencias inversas (quÃ© depende de network.target) ---"
        systemctl list-dependencies network.target --reverse --no-pager | head -30
        echo ""
        echo "--- Servicios fallidos (si hay alguno) ---"
        systemctl --failed --no-pager
      register: service_deps
      changed_when: false

    - name: Guardar dependencias de servicios
      copy:
        dest: "/tmp/gestion_procesos/10_dependencias_servicios.txt"
        content: "{{ service_deps.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # REPORTE FINAL
    # ========================================
    - name: "Generar reporte final consolidado"
      shell: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘   REPORTE FINAL: GESTIÃ“N DE PROCESOS Y SERVICIOS                 â•‘"
        echo "â•‘   Fecha: {{ ansible_date_time.date }} {{ ansible_date_time.time }}                              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  RESUMEN EJECUTIVO"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ“ Sistema: {{ ansible_distribution }} {{ ansible_distribution_version }}"
        echo "âœ“ Kernel: {{ ansible_kernel }}"
        echo "âœ“ Uptime: $(uptime -p)"
        echo "âœ“ Load Average: $(uptime | awk -F'load average:' '{print $2}')"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  SERVICIOS CRÃTICOS VALIDADOS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        for service in radvd isc-dhcp-server apache2 vsftpd ssh firewalld; do
          status=$(systemctl is-active $service 2>/dev/null || echo "inactive")
          enabled=$(systemctl is-enabled $service 2>/dev/null || echo "disabled")
          if [ "$status" = "active" ]; then
            echo "  âœ“ $service: ACTIVO (arranque: $enabled)"
          else
            echo "  âœ— $service: INACTIVO (arranque: $enabled)"
          fi
        done
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  COMPETENCIAS DEMOSTRADAS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "  âœ“ GestiÃ³n de servicios con systemd"
        echo "      - Listado completo de servicios"
        echo "      - Control de estado (start/stop/restart)"
        echo "      - VerificaciÃ³n de servicios activos"
        echo ""
        echo "  âœ“ Monitoreo de procesos"
        echo "      - AnÃ¡lisis de uso de CPU (top 20)"
        echo "      - AnÃ¡lisis de uso de memoria (top 20)"
        echo "      - IdentificaciÃ³n de procesos crÃ­ticos"
        echo ""
        echo "  âœ“ Control de prioridades"
        echo "      - VisualizaciÃ³n de nice values"
        echo "      - AnÃ¡lisis de prioridades de kernel"
        echo ""
        echo "  âœ“ ConfiguraciÃ³n de arranque automÃ¡tico"
        echo "      - Servicios habilitados al boot"
        echo "      - AnÃ¡lisis de tiempos de arranque"
        echo ""
        echo "  âœ“ Troubleshooting"
        echo "      - AnÃ¡lisis de logs con journalctl"
        echo "      - IdentificaciÃ³n de errores"
        echo "      - Dependencias de servicios"
        echo ""
        echo "  âœ“ OptimizaciÃ³n de recursos"
        echo "      - Monitoreo de CPU y memoria"
        echo "      - AnÃ¡lisis de load average"
        echo "      - GestiÃ³n eficiente de procesos"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  EVIDENCIAS GENERADAS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "  ğŸ“ {{ evidence_dir }}/"
        echo "     01_inventario_servicios.txt"
        echo "     02_servicios_criticos.txt"
        echo "     03_top_procesos_cpu.txt"
        echo "     04_top_procesos_memoria.txt"
        echo "     05_control_servicios.txt"
        echo "     06_arranque_automatico.txt"
        echo "     07_logs_servicios.txt"
        echo "     08_prioridades_procesos.txt"
        echo "     09_recursos_sistema.txt"
        echo "     10_dependencias_servicios.txt"
        echo "     REPORTE_FINAL.txt"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  CONCLUSIÃ“N"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "  âœ“ Todos los servicios crÃ­ticos estÃ¡n operativos"
        echo "  âœ“ Sistema optimizado y monitoreado"
        echo "  âœ“ Evidencias completas generadas"
        echo "  âœ“ Competencia demostrada exitosamente"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      register: final_report
      changed_when: false

    - name: Guardar reporte final
      copy:
        dest: "/tmp/gestion_procesos/REPORTE_FINAL.txt"
        content: "{{ final_report.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # MENSAJE FINAL
    # ========================================
    - name: Mostrar resumen de ejecuciÃ³n
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  âœ“ EVIDENCIAS GENERADAS EXITOSAMENTE"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“ UbicaciÃ³n: {{ evidence_dir }}/"
          - ""
          - "ğŸ“„ Archivos generados:"
          - "   âœ“ 00_INICIO.txt - InformaciÃ³n inicial"
          - "   âœ“ 01_inventario_servicios.txt"
          - "   âœ“ 02_servicios_criticos.txt"
          - "   âœ“ 03_top_procesos_cpu.txt"
          - "   âœ“ 04_top_procesos_memoria.txt"
          - "   âœ“ 05_control_servicios.txt"
          - "   âœ“ 06_arranque_automatico.txt"
          - "   âœ“ 07_logs_servicios.txt"
          - "   âœ“ 08_prioridades_procesos.txt"
          - "   âœ“ 09_recursos_sistema.txt"
          - "   âœ“ 10_dependencias_servicios.txt"
          - "   âœ“ REPORTE_FINAL.txt - Resumen consolidado"
          - ""
          - "ğŸ¯ PrÃ³ximo paso:"
          - "   Revisa los archivos en {{ evidence_dir }}/"
          - "   Toma capturas de pantalla segÃºn la guÃ­a"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
