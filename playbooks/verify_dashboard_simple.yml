---
- name: "VERIFICACIÃ“N SIMPLE - La app ya funciona"
  hosts: debian-router
  gather_facts: no
  become: false
  
  tasks:
    - name: "Verificar que todo estÃ© funcionando"
      shell: |
        echo "=== VERIFICACIÃ“N RÃPIDA ==="
        echo "ğŸ“‹ Proceso Flask:"
        ps aux | grep flask_dashboard_final | grep -v grep || echo "âŒ No encontrado"
        
        echo -e "\nğŸŒ Puerto 8090:"
        netstat -tuln | grep 8090 || echo "âŒ Puerto no activo"
        
        echo -e "\nğŸ¥ Test directo:"
        curl -s http://localhost:8090/ | head -5 || echo "âŒ No responde"
        
        echo -e "\nâœ… ACCESO AL DASHBOARD:"
        echo "ğŸŒ Abrir navegador en: http://172.17.25.122:8090"
        echo "ğŸ“± La aplicaciÃ³n deberÃ­a estar funcionando correctamente"
      register: quick_check

    - name: "Mostrar verificaciÃ³n"
      debug:
        var: quick_check.stdout_lines

    - name: "Si no funciona - Reiniciar aplicaciÃ³n"
      shell: |
        echo "ğŸ”„ Reiniciando aplicaciÃ³n Flask..."
        
        # Matar proceso actual
        pkill -f flask_dashboard_final || echo "No hay proceso previo"
        sleep 2
        
        # Iniciar de nuevo
        cd /home/ansible
        nohup python3 flask_dashboard_final.py > dashboard_restart.log 2>&1 &
        echo $! > dashboard_restart.pid
        sleep 3
        
        # Verificar
        if ps -p $(cat dashboard_restart.pid 2>/dev/null) > /dev/null 2>&1; then
          echo "âœ… AplicaciÃ³n reiniciada correctamente"
          echo "ğŸŒ Acceder a: http://172.17.25.122:8090"
        else
          echo "âŒ Error al reiniciar"
          cat dashboard_restart.log
        fi
      when: quick_check.stdout.find('8090') == -1
      register: restart_result

    - name: "Resultado del reinicio"
      debug:
        var: restart_result.stdout_lines
      when: restart_result is defined