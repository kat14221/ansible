---
# Playbook Maestro - Configuraci√≥n Completa de VMWARE-101001
# Red Acad√©mica IPv6 con Ansible
# Backbone: 2025:DB8:101::/64
# LAN: 2025:DB8:220::/64

- name: Configurar Dispositivos de Red (IOS)
  hosts: network_devices
  gather_facts: yes
  roles:
    - ios-basic-config
  tags:
    - ios
    - network
    - ios_config

- name: Crear VM Router Debian en ESXi
  hosts: debian_router
  gather_facts: no
  tasks:
    - name: Crear VM Router Debian
      include_role:
        name: vmware-router
      vars:
        vm_name: "{{ hostvars[inventory_hostname]['vm_name'] }}"
        vm_folder: "{{ hostvars[inventory_hostname]['vm_folder'] }}"
        cdrom: "{{ hostvars[inventory_hostname]['cdrom'] }}"
        networks: "{{ hostvars[inventory_hostname]['networks'] }}"
      delegate_to: localhost
  tags:
    - vm_creation
    - vm_router

- name: Crear VM Ubuntu PC en ESXi
  hosts: vm_hosts
  gather_facts: no
  tasks:
    - name: Crear VM Ubuntu PC
      include_role:
        name: vmware-ubuntu
      vars:
        vm_name: "{{ hostvars[inventory_hostname]['vm_name'] }}"
        vm_folder: "{{ hostvars[inventory_hostname]['vm_folder'] }}"
        cdrom: "{{ hostvars[inventory_hostname]['cdrom'] }}"
        networks: "{{ hostvars[inventory_hostname]['networks'] }}"
      when: inventory_hostname == "ubuntu-pc"
      delegate_to: localhost
      tags:
        - vm_creation
        - vm_ubuntu

    - name: Crear VM Windows PC
      include_role:
        name: vmware-windows
      vars:
        vm_name: "{{ hostvars[inventory_hostname]['vm_name'] }}"
        vm_folder: "{{ hostvars[inventory_hostname]['vm_folder'] }}"
        cdrom: "{{ hostvars[inventory_hostname]['cdrom'] }}"
        networks: "{{ hostvars[inventory_hostname]['networks'] }}"
      when: inventory_hostname == "windows-pc"
      delegate_to: localhost
      tags:
        - vm_creation
        - vm_windows

- name: Configurar Router Debian
  hosts: vm_router
  become: yes
  gather_facts: yes
  roles:
    - debian-ipv6-router
    - debian-services
  tags:
    - debian
    - router
    - services

- name: Tests de Conectividad
  hosts: vm_router
  become: yes
  roles:
    - connectivity-tests
  tags:
    - tests
    - connectivity

- name: Captura de Tr√°fico
  hosts: vm_router
  become: yes
  roles:
    - traffic-capture
  tags:
    - capture
    - traffic

- name: Aplicar Firewall Policy (Reglas Asim√©tricas)
  hosts: vm_router
  become: yes
  gather_facts: yes
  roles:
    - firewall-policy
  tags:
    - firewall
    - security

- name: Hardening de Seguridad SSH (Solo Linux)
  hosts: linux_servers
  become: yes
  gather_facts: yes
  roles:
    - ssh-hardening
  tags:
    - security
    - ssh

- name: Hardening General del Sistema (Solo Linux)
  hosts: linux_servers
  become: yes
  gather_facts: yes
  roles:
    - hardening
  tags:
    - security
    - hardening

- name: Recolectar Evidencias Finales
  hosts: all
  gather_facts: yes
  roles:
    - evidence-collector
  tags:
    - evidence
    - validation

- name: Generar Informes T√©cnicos
  hosts: all
  gather_facts: yes
  roles:
    - technical-report
  tags:
    - reports
    - technical

- name: Configurar Carpetas Compartidas (Samba)
  hosts: linux_servers
  become: yes
  gather_facts: yes
  roles:
    - shared-folders
  tags:
    - shares
    - samba

- name: Resumen Final
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Mostrar resumen de ejecuci√≥n
      debug:
        msg:
          - "================================================"
          - "  Configuraci√≥n Completa - VMWARE-101001"
          - "================================================"
          - ""
          - "‚úÖ Equipos IOS configurados"
          - "‚úÖ VMs creadas en ESXi"
          - "‚úÖ Router Debian configurado con IPv6"
          - "‚úÖ Servicios HTTP desplegados"
          - "‚úÖ Firewall configurado (reglas asim√©tricas)"
          - "‚úÖ Hardening de seguridad aplicado"
          - "‚úÖ Tests de conectividad ejecutados"
          - "‚úÖ Captura de tr√°fico completada"
          - "‚úÖ Evidencias recolectadas"
          - "‚úÖ Informes t√©cnicos generados"
          - "‚úÖ Carpetas compartidas configuradas"
          - ""
          - "üìÅ Evidencias guardadas en: evidence/"
          - "   - Configs: evidence/configs/"
          - "   - Tests: evidence/pings/"
          - "   - Capturas: evidence/pcaps/"
          - "   - Servicios: evidence/services/"
          - "   - Reportes: evidence/reports/"
          - "   - Informes T√©cnicos: evidence/technical_reports/"
          - "   - Logs: evidence/logs/"
          - ""
          - "üìä Ver informes: evidence/technical_reports/index.html"
          - "üìÅ Carpetas compartidas:"
          - "   \\\\172.17.25.126\\reports (debian-router)"
          - "   \\\\2025:db8:101::10\\reports (ubuntu-pc)"
          - ""
          - "üåê Acceso HTTP: http://[2025:db8:220::1]"
          - "üåê Backbone: http://[2025:db8:101::a1]"
          - ""
          - "üîí Firewall: 100::/64 ‚Üí 101::/64 ‚úÖ | 101::/64 ‚Üí 100::/64 ‚ùå"
          - "================================================"
