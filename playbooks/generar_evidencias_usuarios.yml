---
# Playbook: Generar Evidencias de AdministraciÃ³n de Usuarios y Permisos
# Objetivo: Recopilar todas las evidencias necesarias para demostrar cumplimiento

- name: Generar Evidencias de Usuarios, Permisos y PolÃ­ticas
  hosts: debian_router
  become: yes
  gather_facts: yes
  vars:
    evidence_base: "evidence/usuarios_permisos"
    evidence_reports: "{{ evidence_base }}/reports"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"

  pre_tasks:
    - name: Crear directorios de evidencias
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ evidence_base }}"
        - "{{ evidence_reports }}"
      delegate_to: localhost
      run_once: yes

  tasks:
    # ========================================
    # 1. USUARIOS DEL SISTEMA
    # ========================================
    - name: "[1/10] Recopilar usuarios del sistema"
      shell: |
        getent passwd | grep -E "(alumno|profesor|admin|operator|ansible)"
      register: usuarios_sistema
      changed_when: false

    - name: Guardar usuarios del sistema
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          USUARIOS DEL SISTEMA
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          Host: {{ inventory_hostname }}
          
          {{ usuarios_sistema.stdout }}
          
          ANÃLISIS:
          - Total de usuarios acadÃ©micos/tÃ©cnicos: {{ usuarios_sistema.stdout_lines | length }}
          - Cada usuario tiene UID Ãºnico y directorio home
          - SeparaciÃ³n clara de roles
        dest: "{{ evidence_reports }}/01_usuarios_sistema.txt"
      delegate_to: localhost

    # ========================================
    # 2. GRUPOS DEL SISTEMA
    # ========================================
    - name: "[2/10] Recopilar grupos del sistema"
      shell: |
        getent group | grep -E "(alumnos|profesores|sudo)"
      register: grupos_sistema
      changed_when: false

    - name: Guardar grupos del sistema
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          GRUPOS DEL SISTEMA
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          Host: {{ inventory_hostname }}
          
          {{ grupos_sistema.stdout }}
          
          ANÃLISIS:
          - Grupos especÃ­ficos por rol (alumnos, profesores)
          - Grupo sudo para administradores
          - GestiÃ³n de permisos por grupo (no individual)
        dest: "{{ evidence_reports }}/02_grupos_sistema.txt"
      delegate_to: localhost

    # ========================================
    # 3. CONFIGURACIÃ“N SUDOERS
    # ========================================
    - name: "[3/10] Recopilar configuraciÃ³n sudoers operator"
      shell: cat /etc/sudoers.d/operator
      register: sudoers_operator
      changed_when: false
      ignore_errors: yes

    - name: Guardar sudoers operator
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CONFIGURACIÃ“N SUDOERS - OPERATOR
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          Host: {{ inventory_hostname }}
          Archivo: /etc/sudoers.d/operator
          
          {{ sudoers_operator.stdout }}
          
          ANÃLISIS:
          - Permisos granulares y especÃ­ficos
          - Solo comandos necesarios para operaciÃ³n
          - NOPASSWD para comandos de monitoreo
          - NO puede instalar software ni modificar configuraciÃ³n
        dest: "{{ evidence_reports }}/03_sudoers_operator.txt"
      delegate_to: localhost
      when: sudoers_operator.rc == 0

    - name: Recopilar configuraciÃ³n sudoers ansible
      shell: cat /etc/sudoers.d/ansible
      register: sudoers_ansible
      changed_when: false
      ignore_errors: yes

    - name: Guardar sudoers ansible
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CONFIGURACIÃ“N SUDOERS - ANSIBLE
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          Host: {{ inventory_hostname }}
          Archivo: /etc/sudoers.d/ansible
          
          {{ sudoers_ansible.stdout }}
          
          ANÃLISIS:
          - Acceso completo sin password (NOPASSWD: ALL)
          - Necesario para automatizaciÃ³n con Ansible
          - Usuario dedicado para IaC
        dest: "{{ evidence_reports }}/03_sudoers_ansible.txt"
      delegate_to: localhost
      when: sudoers_ansible.rc == 0


    # ========================================
    # 4. CONFIGURACIÃ“N SSH
    # ========================================
    - name: "[4/10] Recopilar configuraciÃ³n SSH"
      shell: |
        grep -E "^(PermitRootLogin|PasswordAuthentication|MaxAuthTries|AllowUsers|Protocol|LogLevel|ClientAliveInterval|MaxSessions)" /etc/ssh/sshd_config
      register: ssh_config
      changed_when: false

    - name: Guardar configuraciÃ³n SSH
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CONFIGURACIÃ“N SSH
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          Host: {{ inventory_hostname }}
          Archivo: /etc/ssh/sshd_config
          
          {{ ssh_config.stdout }}
          
          ANÃLISIS:
          âœ… PermitRootLogin: no (root NO puede hacer SSH)
          âœ… PasswordAuthentication: no (solo autenticaciÃ³n por clave)
          âœ… MaxAuthTries: 3 (mÃ¡ximo 3 intentos)
          âœ… Protocol: 2 (solo SSH v2)
          âœ… LogLevel: VERBOSE (logging detallado)
        dest: "{{ evidence_reports }}/04_ssh_config.txt"
      delegate_to: localhost

    - name: Recopilar algoritmos de cifrado SSH
      shell: |
        grep -A 5 "ANSIBLE MANAGED SSH HARDENING" /etc/ssh/sshd_config
      register: ssh_algorithms
      changed_when: false

    - name: Guardar algoritmos SSH
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ALGORITMOS DE CIFRADO SSH
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          {{ ssh_algorithms.stdout }}
          
          ANÃLISIS:
          âœ… Solo algoritmos modernos y seguros
          âœ… Ciphers: chacha20-poly1305, aes256-gcm
          âœ… MACs: hmac-sha2-256-etm, hmac-sha2-512-etm
          âœ… KexAlgorithms: curve25519-sha256, diffie-hellman-group16-sha512
        dest: "{{ evidence_reports }}/04_ssh_algorithms.txt"
      delegate_to: localhost

    # ========================================
    # 5. FAIL2BAN
    # ========================================
    - name: "[5/10] Recopilar estado de fail2ban"
      shell: systemctl status fail2ban --no-pager
      register: fail2ban_status
      changed_when: false
      ignore_errors: yes

    - name: Recopilar estadÃ­sticas fail2ban SSH
      shell: fail2ban-client status sshd
      register: fail2ban_sshd
      changed_when: false
      ignore_errors: yes

    - name: Guardar fail2ban
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          FAIL2BAN - PROTECCIÃ“N CONTRA ATAQUES
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          
          Estado del servicio:
          {{ fail2ban_status.stdout }}
          
          EstadÃ­sticas SSH:
          {{ fail2ban_sshd.stdout }}
          
          ANÃLISIS:
          âœ… ProtecciÃ³n automÃ¡tica contra fuerza bruta
          âœ… Ban despuÃ©s de 3 intentos fallidos
          âœ… Tiempo de ban: 3600 segundos (1 hora)
          âœ… Monitorea: /var/log/auth.log
        dest: "{{ evidence_reports }}/05_fail2ban.txt"
      delegate_to: localhost
      when: fail2ban_status.rc == 0

    # ========================================
    # 6. FIREWALL
    # ========================================
    - name: "[6/10] Recopilar configuraciÃ³n de firewall"
      shell: |
        echo "=== Estado del Firewall ==="
        firewall-cmd --state
        echo ""
        echo "=== Zonas Activas ==="
        firewall-cmd --get-active-zones
        echo ""
        echo "=== Zona INTERNAL ==="
        firewall-cmd --zone=internal --list-all
        echo ""
        echo "=== Zona EXTERNAL ==="
        firewall-cmd --zone=external --list-all
      register: firewall_config
      changed_when: false

    - name: Guardar configuraciÃ³n firewall
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CONFIGURACIÃ“N DE FIREWALL
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          
          {{ firewall_config.stdout }}
          
          ANÃLISIS:
          âœ… Firewall activo y configurado
          âœ… SegmentaciÃ³n por zonas (internal/external)
          âœ… Reglas asimÃ©tricas:
             - 100::/64 â†’ 101::/64: PERMITIDO
             - 101::/64 â†’ 100::/64: BLOQUEADO (nuevas conexiones)
          âœ… Stateful inspection (respuestas permitidas)
        dest: "{{ evidence_reports }}/06_firewall.txt"
      delegate_to: localhost

    # ========================================
    # 7. HARDENING KERNEL
    # ========================================
    - name: "[7/10] Recopilar parÃ¡metros de hardening"
      shell: |
        sysctl -a | grep -E "(ip_forward|accept_redirects|send_redirects|log_martians|syncookies|dmesg_restrict|kptr_restrict|ptrace_scope|protected_hardlinks|protected_symlinks)"
      register: kernel_hardening
      changed_when: false

    - name: Guardar hardening kernel
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          HARDENING DEL KERNEL
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          
          {{ kernel_hardening.stdout }}
          
          ANÃLISIS:
          âœ… ProtecciÃ³n contra IP spoofing (accept_redirects = 0)
          âœ… ProtecciÃ³n contra ICMP redirects
          âœ… Logging de paquetes sospechosos (log_martians = 1)
          âœ… ProtecciÃ³n SYN flood (syncookies = 1)
          âœ… ProtecciÃ³n de memoria (dmesg_restrict, kptr_restrict)
          âœ… ProtecciÃ³n de archivos (protected_hardlinks, protected_symlinks)
        dest: "{{ evidence_reports }}/07_kernel_hardening.txt"
      delegate_to: localhost

    # ========================================
    # 8. LÃMITES DE RECURSOS
    # ========================================
    - name: "[8/10] Recopilar lÃ­mites de recursos"
      shell: cat /etc/security/limits.d/99-hardening.conf
      register: resource_limits
      changed_when: false

    - name: Guardar lÃ­mites de recursos
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          LÃMITES DE RECURSOS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          Archivo: /etc/security/limits.d/99-hardening.conf
          
          {{ resource_limits.stdout }}
          
          ANÃLISIS:
          âœ… Previene fork bombs (lÃ­mite de procesos)
          âœ… Previene agotamiento de descriptores (lÃ­mite de archivos)
          âœ… Sin core dumps (no expone informaciÃ³n sensible)
          âœ… Operator tiene lÃ­mites mÃ¡s restrictivos
        dest: "{{ evidence_reports }}/08_resource_limits.txt"
      delegate_to: localhost

    # ========================================
    # 9. AUDITORÃA
    # ========================================
    - name: "[9/10] Recopilar configuraciÃ³n de auditorÃ­a"
      shell: |
        echo "=== Estado de Auditd ==="
        systemctl status auditd --no-pager
        echo ""
        echo "=== Reglas de AuditorÃ­a ==="
        cat /etc/audit/rules.d/99-hardening.rules
      register: auditoria
      changed_when: false
      ignore_errors: yes

    - name: Guardar auditorÃ­a
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          AUDITORÃA Y MONITOREO
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Fecha: {{ ansible_date_time.iso8601 }}
          
          {{ auditoria.stdout }}
          
          ANÃLISIS:
          âœ… Auditd activo y monitoreando
          âœ… Archivos crÃ­ticos monitoreados:
             - /etc/passwd, /etc/group, /etc/shadow
             - /etc/sudoers
             - /etc/ssh/sshd_config
             - /var/log/auth.log
          âœ… Permite investigaciÃ³n forense
          âœ… Cumplimiento de normativas
        dest: "{{ evidence_reports }}/09_auditoria.txt"
      delegate_to: localhost
      when: auditoria.rc == 0

    # ========================================
    # 10. REPORTE COMPLETO
    # ========================================
    - name: "[10/10] Generar reporte completo consolidado"
      template:
        src: ../templates/reporte_usuarios_completo.j2
        dest: "{{ evidence_reports }}/00_REPORTE_COMPLETO.txt"
      delegate_to: localhost
      vars:
        fecha_generacion: "{{ ansible_date_time.iso8601 }}"

  post_tasks:
    - name: Mostrar resumen de evidencias generadas
      debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘     EVIDENCIAS GENERADAS EXITOSAMENTE                      â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“ UbicaciÃ³n: {{ evidence_base }}"
          - ""
          - "Archivos generados:"
          - "  âœ… 01_usuarios_sistema.txt"
          - "  âœ… 02_grupos_sistema.txt"
          - "  âœ… 03_sudoers_operator.txt"
          - "  âœ… 03_sudoers_ansible.txt"
          - "  âœ… 04_ssh_config.txt"
          - "  âœ… 04_ssh_algorithms.txt"
          - "  âœ… 05_fail2ban.txt"
          - "  âœ… 06_firewall.txt"
          - "  âœ… 07_kernel_hardening.txt"
          - "  âœ… 08_resource_limits.txt"
          - "  âœ… 09_auditoria.txt"
          - "  âœ… 00_REPORTE_COMPLETO.txt"
          - ""
          - "ğŸ¯ PrÃ³ximos pasos:"
          - "  1. Revisar: cat {{ evidence_reports }}/00_REPORTE_COMPLETO.txt"
          - "  2. Tomar capturas de pantalla segÃºn la guÃ­a"
          - "  3. Organizar capturas en {{ evidence_base }}/screenshots/"
          - ""
          - "ğŸ† Nivel alcanzado: â­â­â­â­â­"
          - "   'Define polÃ­ticas seguras con restricciones claras'"
          - ""
      run_once: yes
