---
- name: "Evidencia - Sistema de Backup y Recuperaci√≥n Acad√©mica"
  hosts: debian-router
  gather_facts: no
  become: true
  
  tasks:
    - name: "Configurar sistema de backup acad√©mico"
      shell: |
        echo "=== CONFIGURANDO BACKUP ACAD√âMICO ==="
        
        # Directorio de backups
        mkdir -p /backup/academico/{usuarios,configuracion,logs}
        mkdir -p /backup/restore
        
        # Configurar permisos
        chown -R root:administradores /backup
        chmod -R 750 /backup
        
        echo "‚úÖ Estructura de backup creada"

    - name: "Script automatizado de backup"
      copy:
        content: |
          #!/bin/bash
          # Sistema de Backup Acad√©mico Autom√°tico
          
          BACKUP_DIR="/backup/academico"
          FECHA=$(date +%Y%m%d_%H%M%S)
          LOG_FILE="/var/log/academico/backup_$FECHA.log"
          
          echo "=== BACKUP ACAD√âMICO - $(date) ===" | tee $LOG_FILE
          
          # Funci√≥n de logging
          log_backup() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }
          
          # Backup de usuarios acad√©micos
          backup_usuarios() {
            log_backup "üè´ Iniciando backup de usuarios acad√©micos..."
            
            # Backup de /etc/passwd y /etc/group
            cp /etc/passwd $BACKUP_DIR/usuarios/passwd_$FECHA
            cp /etc/group $BACKUP_DIR/usuarios/group_$FECHA
            cp /etc/shadow $BACKUP_DIR/usuarios/shadow_$FECHA
            
            # Crear lista de usuarios acad√©micos
            cat > $BACKUP_DIR/usuarios/usuarios_academicos_$FECHA.txt << EOF
          === USUARIOS ACAD√âMICOS - $FECHA ===
          
          ESTUDIANTES:
          $(getent group estudiantes | cut -d: -f4 | tr ',' '\n')
          
          PROFESORES:
          $(getent group profesores | cut -d: -f4 | tr ',' '\n')
          
          ADMINISTRADORES:
          $(getent group administradores | cut -d: -f4 | tr ',' '\n')
          EOF
          
            # Backup de directorios home acad√©micos
            if [ -d "/home/academico" ]; then
              tar -czf $BACKUP_DIR/usuarios/homes_academicos_$FECHA.tar.gz /home/academico
              log_backup "‚úÖ Backup de directorios home completado"
            fi
            
            log_backup "‚úÖ Backup de usuarios completado"
          }
          
          # Backup de configuraciones
          backup_configuracion() {
            log_backup "‚öôÔ∏è Iniciando backup de configuraci√≥n..."
            
            # SSH configuration
            cp -r /etc/ssh $BACKUP_DIR/configuracion/ssh_$FECHA
            
            # Sudoers
            cp /etc/sudoers $BACKUP_DIR/configuracion/sudoers_$FECHA
            
            # Configuraci√≥n de grupos y permisos
            cat > $BACKUP_DIR/configuracion/permisos_$FECHA.txt << EOF
          === CONFIGURACI√ìN DE PERMISOS - $FECHA ===
          
          GRUPOS DEL SISTEMA:
          $(cat /etc/group | grep -E "(estudiantes|profesores|administradores|laboratorio)")
          
          PERMISOS DIRECTORIOS ACAD√âMICOS:
          $(ls -la /home/academico/ 2>/dev/null || echo "Directorio no existe")
          
          SUDOERS ACAD√âMICOS:
          $(cat /etc/sudoers | grep -E "(estudiantes|profesores|administradores)" 2>/dev/null || echo "Sin configuraci√≥n sudo")
          EOF
          
            log_backup "‚úÖ Backup de configuraci√≥n completado"
          }
          
          # Backup de logs acad√©micos
          backup_logs() {
            log_backup "üìã Iniciando backup de logs acad√©micos..."
            
            if [ -d "/var/log/academico" ]; then
              tar -czf $BACKUP_DIR/logs/logs_academicos_$FECHA.tar.gz /var/log/academico
              log_backup "‚úÖ Backup de logs completado"
            fi
          }
          
          # Verificar integridad
          verificar_backup() {
            log_backup "üîç Verificando integridad del backup..."
            
            # Verificar archivos cr√≠ticos
            archivos_criticos=(
              "$BACKUP_DIR/usuarios/passwd_$FECHA"
              "$BACKUP_DIR/usuarios/group_$FECHA"
              "$BACKUP_DIR/configuracion/permisos_$FECHA.txt"
            )
            
            for archivo in "${archivos_criticos[@]}"; do
              if [ -f "$archivo" ]; then
                tama√±o=$(stat -f%z "$archivo" 2>/dev/null || stat -c%s "$archivo" 2>/dev/null)
                log_backup "‚úÖ $archivo - Tama√±o: $tama√±o bytes"
              else
                log_backup "‚ùå FALTA: $archivo"
              fi
            done
            
            # Generar checksum
            find $BACKUP_DIR -type f -name "*_$FECHA*" -exec md5sum {} \; > $BACKUP_DIR/checksums_$FECHA.md5
            log_backup "‚úÖ Checksums generados"
          }
          
          # Limpiar backups antiguos (mantener √∫ltimos 7 d√≠as)
          limpiar_antiguos() {
            log_backup "üßπ Limpiando backups antiguos..."
            find $BACKUP_DIR -type f -mtime +7 -name "*_*" -delete
            log_backup "‚úÖ Limpieza completada"
          }
          
          # Ejecutar backup completo
          main() {
            case "$1" in
              "completo")
                backup_usuarios
                backup_configuracion  
                backup_logs
                verificar_backup
                limpiar_antiguos
                log_backup "üéâ BACKUP COMPLETO FINALIZADO"
                ;;
              "usuarios")
                backup_usuarios
                ;;
              "config")
                backup_configuracion
                ;;
              "verificar")
                verificar_backup
                ;;
              *)
                echo "Uso: $0 {completo|usuarios|config|verificar}"
                exit 1
                ;;
            esac
          }
          
          main "$@"
        dest: /usr/local/bin/backup_academico.sh
        mode: '0755'

    - name: "Script de recuperaci√≥n"
      copy:
        content: |
          #!/bin/bash
          # Sistema de Recuperaci√≥n Acad√©mica
          
          BACKUP_DIR="/backup/academico"
          RESTORE_DIR="/backup/restore"
          
          echo "=== SISTEMA DE RECUPERACI√ìN ACAD√âMICA ==="
          
          # Listar backups disponibles
          listar_backups() {
            echo "üìã BACKUPS DISPONIBLES:"
            echo ""
            
            echo "USUARIOS:"
            ls -la $BACKUP_DIR/usuarios/ | grep passwd_ | awk '{print $9, $5, $6, $7, $8}'
            
            echo ""
            echo "CONFIGURACI√ìN:"
            ls -la $BACKUP_DIR/configuracion/ | grep permisos_ | awk '{print $9, $5, $6, $7, $8}'
            
            echo ""
            echo "LOGS:"
            ls -la $BACKUP_DIR/logs/ | grep logs_ | awk '{print $9, $5, $6, $7, $8}'
          }
          
          # Restaurar usuarios desde backup
          restaurar_usuarios() {
            local fecha_backup=$1
            
            if [ -z "$fecha_backup" ]; then
              echo "‚ùå Debe especificar fecha del backup (YYYYMMDD_HHMMSS)"
              return 1
            fi
            
            echo "‚ö†Ô∏è ADVERTENCIA: Esta operaci√≥n restaurar√° usuarios y grupos acad√©micos"
            echo "¬øContinuar? (s/N):"
            read -r respuesta
            
            if [[ $respuesta =~ ^[Ss]$ ]]; then
              # Crear backup de seguridad actual
              cp /etc/passwd /etc/passwd.pre-restore
              cp /etc/group /etc/group.pre-restore
              
              # Restaurar archivos
              if [ -f "$BACKUP_DIR/usuarios/passwd_$fecha_backup" ]; then
                cp "$BACKUP_DIR/usuarios/passwd_$fecha_backup" /etc/passwd
                cp "$BACKUP_DIR/usuarios/group_$fecha_backup" /etc/group
                echo "‚úÖ Usuarios restaurados desde $fecha_backup"
              else
                echo "‚ùå Backup no encontrado: $fecha_backup"
              fi
            fi
          }
          
          # Mostrar estad√≠sticas de backup
          estadisticas_backup() {
            echo "üìä ESTAD√çSTICAS DE BACKUP:"
            echo ""
            
            echo "Espacio usado por backups:"
            du -sh $BACKUP_DIR
            
            echo ""
            echo "√öltimo backup:"
            find $BACKUP_DIR -name "*_*" -type f | sort | tail -1 | xargs ls -la
            
            echo ""
            echo "Cantidad de backups por tipo:"
            echo "- Usuarios: $(ls $BACKUP_DIR/usuarios/ | wc -l)"
            echo "- Configuraci√≥n: $(ls $BACKUP_DIR/configuracion/ | wc -l)"
            echo "- Logs: $(ls $BACKUP_DIR/logs/ | wc -l)"
          }
          
          case "$1" in
            "listar")
              listar_backups
              ;;
            "restaurar")
              restaurar_usuarios "$2"
              ;;
            "stats")
              estadisticas_backup
              ;;
            *)
              echo "Uso: $0 {listar|restaurar FECHA|stats}"
              echo ""
              echo "Ejemplos:"
              echo "  $0 listar"
              echo "  $0 restaurar 20241201_143000"
              echo "  $0 stats"
              exit 1
              ;;
          esac
        dest: /usr/local/bin/restore_academico.sh
        mode: '0755'

    - name: "Configurar cron para backup autom√°tico"
      cron:
        name: "Backup acad√©mico diario"
        minute: "0"
        hour: "2"
        job: "/usr/local/bin/backup_academico.sh completo"
        user: root

    - name: "Crear informe inicial de backup"
      shell: |
        echo "=== CONFIGURACI√ìN DE BACKUP COMPLETADA ==="
        echo ""
        echo "üìÅ Directorios creados:"
        ls -la /backup/
        echo ""
        echo "‚è∞ Backup autom√°tico configurado: Diario a las 02:00"
        echo ""
        echo "üõ†Ô∏è Comandos disponibles:"
        echo "- backup_academico.sh completo    # Backup completo"
        echo "- restore_academico.sh listar     # Ver backups"
        echo "- restore_academico.sh stats      # Estad√≠sticas"
        echo ""
        echo "‚úÖ Sistema de backup acad√©mico listo"