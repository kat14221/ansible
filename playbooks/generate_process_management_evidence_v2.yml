---
# Playbook: GeneraciÃ³n de Evidencias - GestiÃ³n de Procesos y Servicios (V3 - LÃ³gica Robusta)
# PropÃ³sito: Demostrar competencia en control y optimizaciÃ³n de procesos
# Fecha: 2025-11-25

- name: Generar Evidencias de GestiÃ³n de Procesos y Servicios
  hosts: debian_router
  become: yes
  gather_facts: yes

  vars:
    local_dir: "evidence/gestion_procesos"

  tasks:
    # ========================================
    # PREPARACIÃ“N
    # ========================================
    - name: Crear directorio de evidencias en la mÃ¡quina de control
      delegate_to: localhost
      become: no
      run_once: true
      file:
        path: "{{ local_dir }}"
        state: directory
        mode: '0755'

    - name: "EVIDENCIA 0: Crear archivo de inicio"
      copy:
        dest: "{{ local_dir }}/00_INICIO.txt"
        content: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘   EVIDENCIAS: GESTIÃ“N DE PROCESOS Y SERVICIOS                    â•‘
          â•‘   Proyecto: VMWARE-101001 - Red AcadÃ©mica IPv6                   â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Fecha: {{ ansible_date_time.date }}
          Hora: {{ ansible_date_time.time }}
          Host: {{ inventory_hostname }}
          Sistema: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          OBJETIVO:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Demostrar competencia en:
          âœ“ GestiÃ³n de servicios con systemd
          âœ“ Monitoreo de procesos en tiempo real
          âœ“ AnÃ¡lisis de uso de recursos (CPU, Memoria)
          âœ“ Control de prioridades de procesos
          âœ“ OptimizaciÃ³n de servicios crÃ­ticos
          âœ“ ConfiguraciÃ³n de arranque automÃ¡tico
          âœ“ Troubleshooting de servicios
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      delegate_to: localhost
      become: no
      run_once: true

    # ========================================
    # 1. INVENTARIO DE SERVICIOS CRÃTICOS
    # ========================================
    - name: "EVIDENCIA 1: Listar todos los servicios systemd"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  1. INVENTARIO COMPLETO DE SERVICIOS SYSTEMD"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Todos los servicios (activos e inactivos) ---"
        systemctl list-units --type=service --all --no-pager
        echo ""
        echo "--- Resumen por estado ---"
        systemctl list-units --type=service --no-pager | tail -1
      register: ev1_services
      changed_when: false

    - name: Guardar evidencia 1
      copy:
        dest: "{{ local_dir }}/01_inventario_servicios.txt"
        content: "{{ ev1_services.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 2. ESTADO DE SERVICIOS CRÃTICOS
    # ========================================
    - name: "EVIDENCIA 2: Estado detallado de servicios crÃ­ticos"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  2. ESTADO DE SERVICIOS CRÃTICOS DEL LABORATORIO"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        for service in radvd isc-dhcp-server apache2 vsftpd ssh dnsmasq firewalld; do
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚  SERVICIO: $service"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          systemctl status $service --no-pager -l 2>&1 || echo "Servicio no encontrado"
          echo ""
          echo "--- ConfiguraciÃ³n de arranque ---"
          systemctl is-enabled $service 2>/dev/null || echo "N/A"
          echo ""
        done
      register: ev2_critical
      changed_when: false

    - name: Guardar evidencia 2
      copy:
        dest: "{{ local_dir }}/02_servicios_criticos.txt"
        content: "{{ ev2_critical.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 3. ANÃLISIS DE PROCESOS POR CPU
    # ========================================
    - name: "EVIDENCIA 3: Top 20 procesos por uso de CPU"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  3. ANÃLISIS DE PROCESOS - TOP 20 POR CPU"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        ps aux --sort=-%cpu | head -21
        echo ""
        echo "--- Load Average ---"
        uptime
      register: ev3_cpu
      changed_when: false

    - name: Guardar evidencia 3
      copy:
        dest: "{{ local_dir }}/03_top_procesos_cpu.txt"
        content: "{{ ev3_cpu.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 4. ANÃLISIS DE PROCESOS POR MEMORIA
    # ========================================
    - name: "EVIDENCIA 4: Top 20 procesos por uso de Memoria"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  4. ANÃLISIS DE PROCESOS - TOP 20 POR MEMORIA"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        ps aux --sort=-%mem | head -21
        echo ""
        echo "--- Resumen de memoria del sistema ---"
        free -h
      register: ev4_mem
      changed_when: false

    - name: Guardar evidencia 4
      copy:
        dest: "{{ local_dir }}/04_top_procesos_memoria.txt"
        content: "{{ ev4_mem.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 5. CONTROL DE SERVICIOS
    # ========================================
    - name: "EVIDENCIA 5: Demostrar control de servicios"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  5. CONTROL Y GESTIÃ“N DE SERVICIOS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Estado ANTES de reiniciar Apache2 ---"
        systemctl status apache2 --no-pager | head -15
        echo ""
        echo "--- REINICIANDO Apache2 ---"
        systemctl restart apache2
        sleep 2
        echo "âœ“ Servicio reiniciado exitosamente"
        echo ""
        echo "--- Estado DESPUÃ‰S de reiniciar Apache2 ---"
        systemctl status apache2 --no-pager | head -15
        echo ""
        echo "--- Logs recientes (Ãºltimas 10 lÃ­neas) ---"
        journalctl -u apache2 -n 10 --no-pager
      register: ev5_control
      changed_when: false

    - name: Guardar evidencia 5
      copy:
        dest: "{{ local_dir }}/05_control_servicios.txt"
        content: "{{ ev5_control.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 6. CONFIGURACIÃ“N DE ARRANQUE AUTOMÃTICO
    # ========================================
    - name: "EVIDENCIA 6: Verificar arranque automÃ¡tico"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  6. CONFIGURACIÃ“N DE ARRANQUE AUTOMÃTICO"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Servicios habilitados en el arranque ---"
        systemctl list-unit-files --type=service --state=enabled --no-pager | head -30
        echo ""
        echo "--- AnÃ¡lisis de tiempos de arranque ---"
        systemd-analyze blame 2>/dev/null | head -20 || echo "systemd-analyze no disponible"
      register: ev6_boot
      changed_when: false

    - name: Guardar evidencia 6
      copy:
        dest: "{{ local_dir }}/06_arranque_automatico.txt"
        content: "{{ ev6_boot.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 7. LOGS Y TROUBLESHOOTING
    # ========================================
    - name: "EVIDENCIA 7: AnÃ¡lisis de logs de servicios"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  7. LOGS Y TROUBLESHOOTING DE SERVICIOS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Logs de Apache2 (Ãºltimas 20 lÃ­neas) ---"
        journalctl -u apache2 -n 20 --no-pager 2>/dev/null || echo "No hay logs disponibles"
        echo ""
        echo "--- Logs de SSH (Ãºltimas 15 lÃ­neas) ---"
        journalctl -u ssh -n 15 --no-pager 2>/dev/null || echo "No hay logs disponibles"
        echo ""
        echo "--- Errores del sistema (Ãºltimas 10 lÃ­neas) ---"
        journalctl -p err -n 10 --no-pager 2>/dev/null || echo "No hay errores registrados"
      register: ev7_logs
      changed_when: false

    - name: Guardar evidencia 7
      copy:
        dest: "{{ local_dir }}/07_logs_servicios.txt"
        content: "{{ ev7_logs.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 8. PRIORIDADES Y NICE VALUES
    # ========================================
    - name: "EVIDENCIA 8: AnÃ¡lisis de prioridades de procesos"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  8. PRIORIDADES DE PROCESOS (NICE VALUES)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Top 20 procesos con sus prioridades ---"
        ps -eo pid,ni,pri,pcpu,pmem,comm --sort=-pcpu | head -21
      register: ev8_prio
      changed_when: false

    - name: Guardar evidencia 8
      copy:
        dest: "{{ local_dir }}/08_prioridades_procesos.txt"
        content: "{{ ev8_prio.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 9. RECURSOS DEL SISTEMA
    # ========================================
    - name: "EVIDENCIA 9: Monitoreo de recursos del sistema"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  9. RECURSOS DEL SISTEMA"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- InformaciÃ³n de CPU ---"
        lscpu | grep -E "CPU\(s\)|Model name|Thread|Core|Socket"
        echo ""
        echo "--- Memoria RAM ---"
        free -h
        echo ""
        echo "--- Load Average ---"
        uptime
        echo ""
        echo "--- Uso de disco ---"
        df -h | grep -v tmpfs
      register: ev9_res
      changed_when: false

    - name: Guardar evidencia 9
      copy:
        dest: "{{ local_dir }}/09_recursos_sistema.txt"
        content: "{{ ev9_res.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # 10. DEPENDENCIAS DE SERVICIOS
    # ========================================
    - name: "EVIDENCIA 10: Ãrbol de dependencias de servicios"
      shell: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  10. DEPENDENCIAS DE SERVICIOS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "--- Dependencias de Apache2 ---"
        systemctl list-dependencies apache2 --no-pager 2>/dev/null | head -30 || echo "No disponible"
        echo ""
        echo "--- Servicios fallidos (si hay alguno) ---"
        systemctl --failed --no-pager
      register: ev10_deps
      changed_when: false

    - name: Guardar evidencia 10
      copy:
        dest: "{{ local_dir }}/10_dependencias_servicios.txt"
        content: "{{ ev10_deps.stdout }}"
      delegate_to: localhost
      become: no

    # ========================================
    # MENSAJE FINAL
    # ========================================
    - name: Mostrar resumen de ejecuciÃ³n
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  âœ“ EVIDENCIAS GENERADAS EXITOSAMENTE"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“ UbicaciÃ³n: {{ local_dir }}/"
          - ""
          - "ğŸ“„ 11 archivos de evidencia han sido creados en tu mÃ¡quina local."
          - ""
          - "ğŸ¯ PrÃ³ximo paso:"
          - "   Revisa los archivos en {{ local_dir }}/"
          - "   Toma las capturas de pantalla segÃºn la guÃ­a."
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      run_once: true
