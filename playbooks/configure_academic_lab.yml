---
# Playbook: Configuraci√≥n Completa del Laboratorio Acad√©mico
# Descripci√≥n: Configura DHCPv6 con IPs cortas, usuarios acad√©micos y red P2P.

- name: Configurar Debian Router como Gateway IPv6
  hosts: debian_router
  become: yes
  gather_facts: yes
  tasks:
    - name: Aplicar rol de configuraci√≥n del router
      include_role:
        name: debian-ipv6-router
      tags: gateway

- name: Configurar Cliente Ubuntu
  hosts: ubuntu-pc
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Asegurar que el servidor SSH est√° instalado y corriendo
      apt:
        name: openssh-server
        state: present
      become: yes
      notify: start and enable ssh
      tags: users, client

    - name: Crear usuarios acad√©micos en cliente (primero para asegurar conectividad)
      include_role:
        name: academic-users
      tags: users

    - name: Deshabilitar SLAAC en Ubuntu
      sysctl:
        name: "{{ item }}"
        value: '0'
        state: present
        reload: yes
      loop:
        - net.ipv6.conf.all.autoconf
        - net.ipv6.conf.default.autoconf
      tags: client

    - name: Configurar netplan para DHCPv6 puro + IPv4
      copy:
        dest: /etc/netplan/01-netcfg.yaml
        content: |
          network: 
            version: 2
            ethernets:
              ens192:
                # IPv4 para acceso a internet (debian-router tiene internet por IPv4)
                dhcp4: yes
                # IPv6 forzar DHCPv6 y deshabilitar completamente SLAAC
                accept-ra: no
                dhcp6: yes
                # Usar un DUID estable basado en la MAC para obtener siempre la misma IP
                dhcp-identifier: duid
        mode: '0644'
      notify: apply netplan
      tags: client

  handlers:
    - name: apply netplan
      shell: |
        # Aplicar netplan de forma as√≠ncrona para no colgar SSH
        nohup sh -c 'netplan apply' > /dev/null 2>&1 &
        sleep 2
      become: yes
      async: 5
      poll: 0

    - name: start and enable ssh
      systemd:
        name: ssh
        state: started
        enabled: yes
      become: yes

- name: Configurar Cliente Windows
  hosts: windows-pc
  gather_facts: yes
  tasks:
    # NOTA: Esta tarea se omite porque Windows ya est√° configurado con DHCPv6
    # Si necesitas reconfigurar, ejecuta manualmente en Windows PowerShell:
    # netsh interface ipv6 set interface "Ethernet0" managedaddress=enabled
    # Restart-NetAdapter -Name "Ethernet0"
    
    - name: Verificar conectividad IPv6 en Windows
      win_ping:
      register: windows_ping_result
    
    - name: Mostrar resultado de conectividad
      debug:
        msg: "Windows est√° accesible v√≠a IPv6: {{ ansible_host }}"
      changed_when: true

    - name: Verificar configuraci√≥n de red en Windows
      win_shell: ipconfig /all
      register: ipconfig_output
      changed_when: false

    - name: Mostrar configuraci√≥n de red
      debug:
        var: ipconfig_output.stdout_lines

    - name: Habilitar servicio DHCPv6 Client en Windows
      win_service:
        name: Dhcp
        state: started
        start_mode: auto

    - name: Permitir Ping (ICMPv6) en el Firewall de Windows
      win_firewall_rule:
        name: "ICMPv6 Allow Ping In"
        group: "Servicios de red b√°sicos"
        localport: any
        action: allow
        direction: in
        protocol: icmpv6

    - name: Crear usuarios acad√©micos en cliente Windows
      include_role:
        name: academic-users
      tags: users, client

- name: Resumen de Configuraci√≥n
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Mostrar resumen completo
      debug:
        msg:
          - "=========================================="
          - "‚úÖ LABORATORIO ACAD√âMICO CONFIGURADO"
          - "=========================================="
          - ""
          - "üåê RED:"
          - "   Red Fernandez: 2025:db8:101::/64"
          - "   Gateway: 2025:db8:101::1 (debian-router)"
          - ""
          - "üìç DHCPv6 - IPs Cortas:"
          - "   Rango: ::10 a ::99"
          - "   ubuntu-pc: 2025:db8:101::10"
          - "   windows-pc: 2025:db8:101::11"
          - ""
          - "üë• USUARIOS ACAD√âMICOS:"
          - "   Alumnos: alumno1, alumno2, alumno3 (pass: alumno123)"
          - "   Profesores: profesor1, profesor2 (pass: profesor123)"
          - "   Admin: admin (pass: admin123)"
          - ""
          - "üéÆ JUEGOS P2P:"
          - "   Cualquier alumno puede crear una partida local."
          - "   Otros pueden unirse usando la IP del anfitri√≥n."
          - ""
          - "üìä ACCESOS:"
          - "   SSH debian-router: ssh admin@2025:db8:101::1"
          - "   SSH ubuntu-pc: ssh alumno1@2025:db8:101::10"
          - "   Network Monitor: http://[2025:db8:101::1]:5000"
          - ""
          - "üîí SEGURIDAD:"
          - "   ‚úÖ Firewall P2P entre redes de laboratorio"
          - "   ‚úÖ Usuarios con permisos limitados"
          - "   ‚úÖ SLAAC deshabilitado (solo DHCPv6)"
          - "=========================================="
