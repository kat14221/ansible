---
# Playbook: Configuraci√≥n Completa del Laboratorio Acad√©mico
# Descripci√≥n: Configura DHCPv6 con IPs cortas, usuarios acad√©micos y red P2P.

- name: Configurar Debian Router como Gateway IPv6
  hosts: debian_router
  become: yes
  gather_facts: yes
  tasks:
    - name: Aplicar rol de configuraci√≥n del router
      include_role:
        name: debian-ipv6-router
      tags: gateway

- name: Configurar Cliente Ubuntu
  hosts: ubuntu-pc
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Asegurar que el servidor SSH est√° instalado y corriendo
      apt:
        name: openssh-server
        state: present
      become: yes
      notify: start and enable ssh
      tags: users, client

    - name: Crear usuarios acad√©micos en cliente (primero para asegurar conectividad)
      include_role:
        name: academic-users
      tags: users

    - name: Deshabilitar SLAAC en Ubuntu
      sysctl:
        name: "{{ item }}"
        value: '0'
        state: present
        reload: yes
      loop:
        - net.ipv6.conf.all.autoconf
        - net.ipv6.conf.default.autoconf
      tags: client

    - name: Configurar netplan para DHCPv6 puro
      copy:
        dest: /etc/netplan/01-netcfg.yaml
        content: |
          network: 
            version: 2
            renderer: networkd
            ethernets:
              ens192:
                # Deshabilitar SLAAC y forzar DHCPv6
                accept-ra: no
                dhcp4: no
                dhcp6: true
        mode: '0644'
      notify: apply netplan
      tags: client

  handlers:
    - name: apply netplan
      command: netplan apply
      become: yes

    - name: start and enable ssh
      systemd:
        name: ssh
        state: started
        enabled: yes
      become: yes

- name: Configurar Cliente Windows
  hosts: windows-pc
  gather_facts: yes
  vars:
    ansible_user: "{{ vault_windows_ansible_user }}"
    ansible_password: "{{ vault_windows_ansible_password }}"
    ansible_connection: winrm
    ansible_winrm_transport: basic
    ansible_winrm_server_cert_validation: ignore
  tasks:
    - name: Crear usuarios acad√©micos en cliente Windows
      include_role:
        name: academic-users
      tags: users, client

- name: Resumen de Configuraci√≥n
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Mostrar resumen completo
      debug:
        msg:
          - "=========================================="
          - "‚úÖ LABORATORIO ACAD√âMICO CONFIGURADO"
          - "=========================================="
          - ""
          - "üåê RED:"
          - "   Red Fernandez: 2025:db8:101::/64"
          - "   Gateway: 2025:db8:101::1 (debian-router)"
          - ""
          - "üìç DHCPv6 - IPs Cortas:"
          - "   Rango: ::10 a ::99"
          - "   ubuntu-pc: 2025:db8:101::10"
          - "   windows-pc: 2025:db8:101::11"
          - ""
          - "üë• USUARIOS ACAD√âMICOS:"
          - "   Alumnos: alumno1, alumno2, alumno3 (pass: alumno123)"
          - "   Profesores: profesor1, profesor2 (pass: profesor123)"
          - "   Admin: admin (pass: admin123)"
          - ""
          - "üéÆ JUEGOS P2P:"
          - "   Cualquier alumno puede crear una partida local."
          - "   Otros pueden unirse usando la IP del anfitri√≥n."
          - ""
          - "üìä ACCESOS:"
          - "   SSH debian-router: ssh admin@2025:db8:101::1"
          - "   SSH ubuntu-pc: ssh alumno1@2025:db8:101::10"
          - "   Network Monitor: http://[2025:db8:101::1]:5000"
          - ""
          - "üîí SEGURIDAD:"
          - "   ‚úÖ Firewall P2P entre redes de laboratorio"
          - "   ‚úÖ Usuarios con permisos limitados"
          - "   ‚úÖ SLAAC deshabilitado (solo DHCPv6)"
          - "=========================================="
