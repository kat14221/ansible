---
# Playbook: Reparar Conectividad de Red (IPv6 + Internet)
# Descripci√≥n: Soluciona problemas de DHCPv6, NAT y conectividad a internet

- name: Reconfigurar debian-router para acceso a internet
  hosts: debian_router
  become: yes
  gather_facts: yes
  tasks:
    - name: Verificar forwarding IPv4 est√° habilitado
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        reload: yes

    - name: Verificar forwarding IPv6 est√° habilitado
      sysctl:
        name: net.ipv6.conf.all.forwarding
        value: '1'
        state: present
        reload: yes

    - name: Reconfigur radvd (deshabilitar SLAAC)
      template:
        src: ../roles/debian-ipv6-router/templates/radvd.conf.j2
        dest: /etc/radvd.conf
        mode: '0644'
      notify: restart radvd

    - name: Reconfigurar nftables (NAT + forwarding)
      template:
        src: ../roles/debian-ipv6-router/templates/nftables.conf.j2
        dest: /etc/nftables.conf
        mode: '0644'
      notify: reload nftables

    - name: Verificar estado de servicios
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - radvd
        - isc-dhcp-server
        - nftables

    - name: Mostrar tabla de rutas IPv4
      command: ip route show
      register: routes_ipv4
      changed_when: false

    - name: Mostrar tabla de rutas IPv6
      command: ip -6 route show
      register: routes_ipv6
      changed_when: false

    - name: Mostrar reglas de nftables
      command: nft list ruleset
      register: nft_rules
      changed_when: false

    - name: Resumen de configuraci√≥n
      debug:
        msg:
          - "=========================================="
          - "‚úÖ Forwarding IPv4: habilitado"
          - "‚úÖ Forwarding IPv6: habilitado"
          - "‚úÖ RADVD: configurado sin SLAAC"
          - "‚úÖ nftables: NAT + forward configurado"
          - ""
          - "üìã Rutas IPv4:"
          - "{{ routes_ipv4.stdout_lines }}"
          - ""
          - "üìã Rutas IPv6:"
          - "{{ routes_ipv6.stdout_lines }}"
          - "=========================================="

  handlers:
    - name: restart radvd
      systemd:
        name: radvd
        state: restarted

    - name: reload nftables
      systemd:
        name: nftables
        state: reloaded

    - name: restart sshd
      systemd:
        name: sshd
        state: restarted

- name: Reconfigurar Cliente Ubuntu
  hosts: ubuntu-pc
  become: yes
  gather_facts: yes
  tasks:
    - name: Verificar si existe dhclient (Ubuntu antiguo)
      stat:
        path: /sbin/dhclient
      register: dhclient_exists

    - name: Renovar IP con dhclient (si existe)
      block:
        - name: Liberar IP con dhclient
          command: dhclient -6 -r {{ ansible_default_ipv6.interface | default('ens192') }}
          ignore_errors: yes
          changed_when: false

        - name: Renovar IP con dhclient
          command: dhclient -6 {{ ansible_default_ipv6.interface | default('ens192') }}
          changed_when: true
      when: dhclient_exists.stat.exists

    - name: Renovar IP con netplan (Ubuntu 24.04)
      block:
        - name: Reiniciar systemd-networkd de forma segura
          systemd:
            name: systemd-networkd
            state: restarted
          async: 10
          poll: 0
          changed_when: true

        - name: Esperar a que la red se estabilice
          wait_for:
            timeout: 8
          delegate_to: localhost
      when: not dhclient_exists.stat.exists

    - name: Esperar 5 segundos para que se aplique
      pause:
        seconds: 5

    - name: Verificar nueva IP
      command: ip -6 addr show
      register: ubuntu_ipv6
      changed_when: false

    - name: Test de conectividad a gateway
      command: ping6 -c 3 2025:db8:101::1
      register: ping_gateway
      changed_when: false
      failed_when: false

    - name: Test de conectividad a internet (Google DNS)
      command: ping6 -c 3 2001:4860:4860::8888
      register: ping_internet
      changed_when: false
      failed_when: false

    - name: Resumen Ubuntu
      debug:
        msg:
          - "=========================================="
          - "üìç Ubuntu PC - Estado de Red"
          - ""
          - "IPs IPv6:"
          - "{{ ubuntu_ipv6.stdout_lines }}"
          - ""
          - "Ping a Gateway: {{ 'OK' if ping_gateway.rc == 0 else 'FALL√ì' }}"
          - "Ping a Internet: {{ 'OK' if ping_internet.rc == 0 else 'FALL√ì' }}"
          - "=========================================="

- name: Reconfigurar Cliente Windows
  hosts: windows-pc
  gather_facts: yes
  tasks:
    - name: Deshabilitar SLAAC en Windows (forzar DHCPv6 puro)
      win_shell: |
        # Deshabilitar autoconfiguraci√≥n IPv6 (SLAAC)
        netsh interface ipv6 set interface "Ethernet0" routerdiscovery=disabled
        netsh interface ipv6 set interface "Ethernet0" managedaddress=enabled
        netsh interface ipv6 set interface "Ethernet0" otherstateful=enabled
        
        # Liberar y renovar IPv6
        ipconfig /release6
        Start-Sleep -Seconds 2
        ipconfig /renew6
      register: ipv6_config_result

    - name: Esperar 10 segundos para que se aplique DHCPv6
      pause:
        seconds: 10

    - name: Verificar nueva configuraci√≥n de red
      win_shell: ipconfig /all
      register: windows_ipconfig
      changed_when: false

    - name: Test de conectividad a gateway desde Windows
      win_shell: ping -6 -n 3 2025:db8:101::1
      register: windows_ping_gateway
      changed_when: false
      failed_when: false

    - name: Test de conectividad a internet desde Windows
      win_shell: ping -6 -n 3 2001:4860:4860::8888
      register: windows_ping_internet
      changed_when: false
      failed_when: false

    - name: Resumen Windows
      debug:
        msg:
          - "=========================================="
          - "üìç Windows PC - Estado de Red"
          - ""
          - "Configuraci√≥n de red:"
          - "{{ windows_ipconfig.stdout_lines }}"
          - ""
          - "Ping a Gateway: {{ 'OK' if windows_ping_gateway.rc == 0 else 'FALL√ì' }}"
          - "Ping a Internet: {{ 'OK' if windows_ping_internet.rc == 0 else 'FALL√ì' }}"
          - "=========================================="

- name: Resumen Final
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Mostrar resumen de correcciones
      debug:
        msg:
          - "=========================================="
          - "‚úÖ CORRECCIONES APLICADAS"
          - "=========================================="
          - ""
          - "1. ‚úÖ debian-router:"
          - "   - SLAAC deshabilitado (AdvAutonomous off)"
          - "   - NAT configurado para acceso a internet"
          - "   - Forwarding IPv4/IPv6 habilitado"
          - "   - nftables con reglas de masquerade"
          - ""
          - "2. ‚úÖ ubuntu-pc:"
          - "   - IP renovada v√≠a DHCPv6"
          - "   - Deber√≠a tener IP corta (::10)"
          - ""
          - "3. ‚úÖ windows-pc:"
          - "   - SLAAC deshabilitado en adaptador"
          - "   - DHCPv6 forzado"
          - "   - Deber√≠a tener IP corta (::11)"
          - ""
          - "üìã PR√ìXIMOS PASOS:"
          - "   1. Verificar en Windows: ipconfig /all"
          - "   2. Verificar IP corta sin ':0:' en el medio"
          - "   3. Probar ping a internet: ping -6 google.com"
          - "   4. Probar SSH: ssh usuario@2025:db8:101::11"
          - "=========================================="
