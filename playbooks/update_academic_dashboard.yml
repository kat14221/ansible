---
- name: Actualizar Dashboard con AnÃ¡lisis de Usuarios
  hosts: debian_router
  gather_facts: true
  become: true
  
  tasks:
    - name: Recopilar informaciÃ³n de usuarios del sistema
      shell: |
        echo "=== USUARIOS DEL SISTEMA ===" > /tmp/users_analysis.txt
        echo "" >> /tmp/users_analysis.txt
        getent passwd | grep -E "(alumno|profesor|admin|ansible)" | while read line; do
          user=$(echo $line | cut -d: -f1)
          uid=$(echo $line | cut -d: -f3)  
          home=$(echo $line | cut -d: -f6)
          shell=$(echo $line | cut -d: -f7)
          echo "ğŸ‘¤ Usuario: $user (UID: $uid)" >> /tmp/users_analysis.txt
          echo "   ğŸ  Home: $home" >> /tmp/users_analysis.txt
          echo "   ğŸš Shell: $shell" >> /tmp/users_analysis.txt
          
          # Ver grupos del usuario
          groups_info=$(groups $user 2>/dev/null || echo "sin grupos")
          echo "   ğŸ‘¥ Grupos: $groups_info" >> /tmp/users_analysis.txt
          
          # Ver Ãºltimo login
          last_login=$(last -1 $user 2>/dev/null | head -1 | awk '{print $4, $5, $6, $7}' || echo "nunca")
          echo "   ğŸ• Ãšltimo login: $last_login" >> /tmp/users_analysis.txt
          echo "" >> /tmp/users_analysis.txt
        done

    - name: Crear dashboard HTML actualizado con usuarios
      copy:
        content: |
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Dashboard AcadÃ©mico - {{ inventory_hostname }}</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  
                  .container {
                      max-width: 1400px;
                      margin: 0 auto;
                      background: rgba(255, 255, 255, 0.95);
                      border-radius: 15px;
                      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                      overflow: hidden;
                  }
                  
                  .header {
                      background: linear-gradient(45deg, #2c3e50, #3498db);
                      color: white;
                      text-align: center;
                      padding: 30px;
                  }
                  
                  .header h1 { font-size: 2.5em; margin-bottom: 10px; }
                  .header p { font-size: 1.2em; opacity: 0.9; }
                  
                  .stats-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 20px;
                      padding: 30px;
                  }
                  
                  .stat-card {
                      background: white;
                      border-radius: 10px;
                      padding: 25px;
                      text-align: center;
                      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
                      transition: transform 0.3s ease;
                  }
                  
                  .stat-card:hover { transform: translateY(-5px); }
                  .stat-card .icon { font-size: 3em; margin-bottom: 15px; }
                  .stat-card h3 { color: #2c3e50; margin-bottom: 10px; }
                  .stat-card .number { font-size: 2em; font-weight: bold; color: #3498db; }
                  
                  .users-section {
                      padding: 30px;
                      background: #f8f9fa;
                  }
                  
                  .users-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                      gap: 20px;
                      margin-top: 20px;
                  }
                  
                  .user-card {
                      background: white;
                      border-radius: 10px;
                      padding: 20px;
                      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
                      border-left: 4px solid #3498db;
                  }
                  
                  .user-card.admin { border-left-color: #e74c3c; }
                  .user-card.profesor { border-left-color: #f39c12; }
                  .user-card.alumno { border-left-color: #27ae60; }
                  
                  .user-card h4 { color: #2c3e50; margin-bottom: 10px; }
                  .user-card .user-info { font-size: 0.9em; color: #7f8c8d; margin: 5px 0; }
                  
                  .reports-section {
                      padding: 30px;
                  }
                  
                  .btn {
                      display: inline-block;
                      background: linear-gradient(45deg, #3498db, #2980b9);
                      color: white;
                      text-decoration: none;
                      padding: 12px 25px;
                      border-radius: 25px;
                      margin: 5px;
                      transition: all 0.3s ease;
                  }
                  
                  .btn:hover {
                      background: linear-gradient(45deg, #2980b9, #3498db);
                      transform: translateY(-2px);
                  }
                  
                  .footer {
                      text-align: center;
                      padding: 20px;
                      background: #2c3e50;
                      color: white;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸ“ Dashboard AcadÃ©mico</h1>
                      <p>{{ inventory_hostname }} - Sistema de GestiÃ³n Educativa</p>
                      <p style="font-size: 1em; margin-top: 10px;">{{ ansible_date_time.iso8601 }}</p>
                  </div>
                  
                  <div class="stats-grid">
                      <div class="stat-card">
                          <div class="icon">ğŸ‘¥</div>
                          <h3>Usuarios Totales</h3>
                          <div class="number" id="total-users">6</div>
                      </div>
                      
                      <div class="stat-card">
                          <div class="icon">ğŸ“</div>
                          <h3>Alumnos</h3>
                          <div class="number" id="students">3</div>
                      </div>
                      
                      <div class="stat-card">
                          <div class="icon">ğŸ‘¨â€ğŸ«</div>
                          <h3>Profesores</h3>
                          <div class="number" id="teachers">1</div>
                      </div>
                      
                      <div class="stat-card">
                          <div class="icon">âš™ï¸</div>
                          <h3>Administradores</h3>
                          <div class="number" id="admins">2</div>
                      </div>
                  </div>
                  
                  <div class="users-section">
                      <h2>ğŸ‘¥ GestiÃ³n de Usuarios</h2>
                      <div class="users-grid">
                          <div class="user-card admin">
                              <h4>ğŸ”§ admin</h4>
                              <div class="user-info">Tipo: Administrador del sistema</div>
                              <div class="user-info">Permisos: Sudo completo</div>
                          </div>
                          
                          <div class="user-card admin">
                              <h4>ğŸ¤– ansible</h4>
                              <div class="user-info">Tipo: Administrador automatizaciÃ³n</div>
                              <div class="user-info">Permisos: GestiÃ³n remota</div>
                          </div>
                          
                          <div class="user-card profesor">
                              <h4>ğŸ‘¨â€ğŸ« profesor</h4>
                              <div class="user-info">Tipo: Docente</div>
                              <div class="user-info">Permisos: GestiÃ³n acadÃ©mica</div>
                          </div>
                          
                          <div class="user-card alumno">
                              <h4>ğŸ“ alumno1</h4>
                              <div class="user-info">Tipo: Estudiante</div>
                              <div class="user-info">Permisos: Usuario estÃ¡ndar</div>
                          </div>
                          
                          <div class="user-card alumno">
                              <h4>ğŸ“ alumno2</h4>
                              <div class="user-info">Tipo: Estudiante</div>
                              <div class="user-info">Permisos: Usuario estÃ¡ndar</div>
                          </div>
                          
                          <div class="user-card alumno">
                              <h4>ğŸ“ alumno3</h4>
                              <div class="user-info">Tipo: Estudiante</div>
                              <div class="user-info">Permisos: Usuario estÃ¡ndar</div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="reports-section">
                      <h2>ğŸ“Š Acciones del Sistema</h2>
                      <a href="/users-report.html" class="btn">ğŸ“‹ Reporte Detallado</a>
                      <a href="/security-report.html" class="btn">ğŸ›¡ï¸ AnÃ¡lisis de Seguridad</a>
                      <a href="#" onclick="location.reload()" class="btn">ğŸ”„ Actualizar</a>
                  </div>
                  
                  <div class="footer">
                      <p>Dashboard AcadÃ©mico | Laboratorio de Redes | {{ ansible_date_time.date }}</p>
                  </div>
              </div>
          </body>
          </html>
        dest: /var/www/security-dashboard/index.html
        mode: '0644'

    - name: Crear reporte detallado de usuarios
      shell: |
        cat > /var/www/security-dashboard/users-report.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Reporte de Usuarios - Detallado</title>
            <meta charset="UTF-8">
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
                .user-details { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #3498db; }
                pre { background: #2c3e50; color: white; padding: 15px; border-radius: 5px; overflow-x: auto; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ“‹ Reporte Detallado de Usuarios</h1>
                <a href="/">â† Volver al Dashboard</a>
                
                <h2>AnÃ¡lisis del Sistema</h2>
                <pre>$(cat /tmp/users_analysis.txt)</pre>
                
                <h2>InformaciÃ³n Adicional</h2>
                <pre>$(w)</pre>
            </div>
        </body>
        </html>
        EOF

    - name: Mostrar URLs actualizadas
      debug:
        msg:
          - "ğŸ“ DASHBOARD ACADÃ‰MICO ACTUALIZADO"
          - "=================================="
          - ""
          - "ğŸ“Š Dashboard Principal: http://172.17.25.122:8088"
          - "ğŸ“‹ Reporte Usuarios: http://172.17.25.122:8088/users-report.html" 
          - ""
          - "ğŸ‘¥ Usuarios configurados:"
          - "   ğŸ”§ admin (Administrador)"
          - "   ğŸ¤– ansible (AutomatizaciÃ³n)" 
          - "   ğŸ‘¨â€ğŸ« profesor (Docente)"
          - "   ğŸ“ alumno1, alumno2, alumno3 (Estudiantes)"