---
- name: Dashboard de Gesti√≥n de Seguridad Interactivo
  hosts: debian_router, ubuntu-pc
  gather_facts: true
  become: true
  serial: 1
  
  tasks:
    - name: Instalar dependencias para gesti√≥n web
      package:
        name:
          - python3
          - python3-pip
          - python3-flask
          - python3-bcrypt
          - sudo
        state: present

    - name: Crear aplicaci√≥n Flask de gesti√≥n
      copy:
        content: |
          #!/usr/bin/env python3
          from flask import Flask, render_template_string, request, jsonify, redirect, url_for, session
          import subprocess
          import json
          import os
          from functools import wraps
          
          app = Flask(__name__)
          app.secret_key = 'ansible-security-dashboard-2025'
          
          # Configuraci√≥n de seguridad
          ALLOWED_USERS = ['admin', 'ansible']
          
          def require_auth(f):
              @wraps(f)
              def decorated_function(*args, **kwargs):
                  if 'user' not in session:
                      return redirect(url_for('login'))
                  return f(*args, **kwargs)
              return decorated_function
          
          def run_command(cmd, check=True):
              try:
                  result = subprocess.run(cmd, shell=True, capture_output=True, text=True, check=check)
                  return {'success': True, 'stdout': result.stdout, 'stderr': result.stderr}
              except subprocess.CalledProcessError as e:
                  return {'success': False, 'error': str(e), 'stdout': e.stdout, 'stderr': e.stderr}
          
          # Templates como strings
          def get_login_html(error_msg=None):
              error_div = f'<div class="error">{error_msg}</div>' if error_msg else ''
              return f'''<!DOCTYPE html><html><head><title>Login</title><style>body{{font-family:Arial;background:#3498db;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}}.login-box{{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);max-width:400px;width:100%}}.login-box h1{{text-align:center;color:#2c3e50;margin-bottom:30px}}.form-group{{margin-bottom:20px}}.form-group label{{display:block;margin-bottom:5px;color:#2c3e50;font-weight:bold}}.form-group input{{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;box-sizing:border-box}}.login-btn{{width:100%;background:#3498db;color:white;border:none;padding:15px;border-radius:8px;font-size:16px;cursor:pointer}}.login-btn:hover{{background:#2980b9}}.error{{background:#e74c3c;color:white;padding:10px;border-radius:5px;margin-bottom:20px}}</style></head><body><div class="login-box"><h1>üîê Gesti√≥n de Seguridad</h1>{error_div}<form method="POST"><div class="form-group"><label>Usuario:</label><input type="text" name="username" required></div><div class="form-group"><label>Contrase√±a:</label><input type="password" name="password" required></div><button type="submit" class="login-btn">Iniciar Sesi√≥n</button></form></div></body></html>'''

          def get_dashboard_html(username):
              return f'''<!DOCTYPE html><html><head><title>Gesti√≥n de Seguridad</title><style>*{{margin:0;padding:0;box-sizing:border-box}}body{{font-family:Arial;background:#f5f5f5}}.navbar{{background:#2c3e50;color:white;padding:15px 30px;display:flex;justify-content:space-between;align-items:center}}.container{{max-width:1400px;margin:0 auto;padding:30px}}.section{{background:white;margin-bottom:30px;border-radius:10px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,0.1)}}.section h2{{color:#2c3e50;margin-bottom:20px;border-bottom:2px solid #3498db;padding-bottom:10px}}.tabs{{display:flex;margin-bottom:20px}}.tab{{padding:10px 20px;cursor:pointer;border-bottom:2px solid transparent;color:#666}}.tab.active{{color:#3498db;border-bottom-color:#3498db}}.tab-content{{display:none}}.tab-content.active{{display:block}}.btn{{background:#3498db;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px}}.btn:hover{{background:#2980b9}}.btn.danger{{background:#e74c3c}}.form-group{{margin-bottom:15px}}.form-group label{{display:block;margin-bottom:5px;font-weight:bold}}.form-group input,.form-group select{{width:100%;padding:10px;border:1px solid #ddd;border-radius:5px}}.users-grid{{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}}.user-card{{border:1px solid #ddd;border-radius:10px;padding:20px}}.user-header{{display:flex;align-items:center;margin-bottom:15px}}.user-icon{{font-size:2em;margin-right:15px}}.alert{{padding:15px;margin-bottom:20px;border-radius:5px;display:none}}.alert.success{{background:#d4edda;color:#155724}}.alert.error{{background:#f8d7da;color:#721c24}}</style></head><body><div class="navbar"><h1>üõ°Ô∏è Gesti√≥n de Seguridad</h1><div><span>üë§ {username}</span><a href="/logout" style="color:white;margin-left:20px">Salir</a></div></div><div class="container"><div id="alert" class="alert"></div><div class="section"><h2>Gesti√≥n de Usuarios</h2><div class="tabs"><div class="tab active" onclick="showTab('users')">Usuarios</div><div class="tab" onclick="showTab('create')">Crear</div></div><div id="users" class="tab-content active"><button class="btn" onclick="loadUsers()">üîÑ Actualizar</button><div class="users-grid" id="usersContainer"></div></div><div id="create" class="tab-content"><form onsubmit="createUser(event)"><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px"><div class="form-group"><label>Usuario:</label><input type="text" id="username" required></div><div class="form-group"><label>Contrase√±a:</label><input type="password" id="password" required></div><div class="form-group"><label>Rol:</label><select id="role"><option value="alumno">Alumno</option><option value="profesor">Profesor</option><option value="admin">Admin</option></select></div></div><button type="submit" class="btn">Crear</button></form></div></div></div><script>function showTab(t){{document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));document.getElementById(t).classList.add('active');event.target.classList.add('active');if(t==='users')loadUsers()}}function loadUsers(){{fetch('/api/users').then(r=>r.json()).then(users=>{{const c=document.getElementById('usersContainer');c.innerHTML='';users.forEach(user=>{{const icon=user.groups.includes('sudo')?'üîß':user.groups.includes('profesor')?'üë®‚Äçüè´':'üéì';const card=document.createElement('div');card.className='user-card';card.innerHTML=`<div class="user-header"><div class="user-icon">${{icon}}</div><div><h4>${{user.username}}</h4><p>UID: ${{user.uid}}</p><p>Grupos: ${{user.groups}}</p></div></div><button class="btn danger" onclick="deleteUser('${{user.username}}')">Eliminar</button>`;c.appendChild(card)}})}})}}function createUser(e){{e.preventDefault();const data={{username:document.getElementById('username').value,password:document.getElementById('password').value,role:document.getElementById('role').value}};fetch('/api/create_user',{{method:'POST',headers:{{'Content-Type':'application/json'}},body:JSON.stringify(data)}}).then(r=>r.json()).then(result=>{{showAlert(result.message||result.error,result.success?'success':'error');if(result.success){{e.target.reset();showTab('users')}}}})}}}function deleteUser(username){{if(confirm(`¬øEliminar ${{username}}?`)){{fetch('/api/delete_user',{{method:'POST',headers:{{'Content-Type':'application/json'}},body:JSON.stringify({{username}})}}).then(r=>r.json()).then(result=>{{showAlert(result.message||result.error,result.success?'success':'error');if(result.success)loadUsers()}})}}}}function showAlert(msg,type){{const a=document.getElementById('alert');a.className=`alert ${{type}}`;a.textContent=msg;a.style.display='block';setTimeout(()=>a.style.display='none',5000)}}loadUsers()</script></body></html>'''

          @app.route('/')
          @require_auth
          def dashboard():
              return get_dashboard_html(session['user'])
          
          @app.route('/login', methods=['GET', 'POST'])
          def login():
              if request.method == 'POST':
                  username = request.form['username']
                  password = request.form['password']
                  
                  # Verificar credenciales b√°sicas
                  if username in ALLOWED_USERS and len(password) > 3:
                      session['user'] = username
                      return redirect(url_for('dashboard'))
                  else:
                      return get_login_html('Credenciales inv√°lidas')
              
              return get_login_html()
          
          @app.route('/logout')
          def logout():
              session.pop('user', None)
              return redirect(url_for('login'))
          
          @app.route('/api/users')
          @require_auth
          def get_users():
              result = run_command("getent passwd | awk -F: '$3 >= 1000 && $3 < 65534 {print $1,$3,$5,$6,$7}' OFS=':'")
              users = []
              
              if result['success']:
                  for line in result['stdout'].strip().split('\n'):
                      if line:
                          parts = line.split(':')
                          if len(parts) >= 5:
                              # Obtener grupos del usuario
                              groups_result = run_command(f"groups {parts[0]}")
                              groups = groups_result['stdout'].split(':')[1].strip() if groups_result['success'] else ""
                              
                              users.append({
                                  'username': parts[0],
                                  'uid': parts[1],
                                  'gecos': parts[2],
                                  'home': parts[3],
                                  'shell': parts[4],
                                  'groups': groups
                              })
              
              return jsonify(users)
          
          @app.route('/api/groups')
          @require_auth
          def get_groups():
              result = run_command("getent group | awk -F: '$3 >= 1000 || $1 ~ /^(sudo|admin|users|staff)$/ {print $1,$3,$4}' OFS=':'")
              groups = []
              
              if result['success']:
                  for line in result['stdout'].strip().split('\n'):
                      if line:
                          parts = line.split(':')
                          if len(parts) >= 2:
                              groups.append({
                                  'name': parts[0],
                                  'gid': parts[1],
                                  'members': parts[2] if len(parts) > 2 else ""
                              })
              
              return jsonify(groups)
          
          @app.route('/api/create_user', methods=['POST'])
          @require_auth
          def create_user():
              data = request.get_json()
              username = data.get('username')
              password = data.get('password')
              role = data.get('role', 'alumno')
              
              if not username or not password:
                  return jsonify({'success': False, 'error': 'Username y password requeridos'})
              
              # Crear usuario
              cmd = f"useradd -m -s /bin/bash {username}"
              result = run_command(cmd, check=False)
              
              if not result['success']:
                  return jsonify({'success': False, 'error': f'Error creando usuario: {result["stderr"]}'})
              
              # Establecer contrase√±a
              cmd = f"echo '{username}:{password}' | chpasswd"
              result = run_command(cmd, check=False)
              
              if not result['success']:
                  return jsonify({'success': False, 'error': f'Error estableciendo contrase√±a: {result["stderr"]}'})
              
              # Asignar a grupos seg√∫n rol
              if role == 'admin':
                  run_command(f"usermod -aG sudo {username}")
              elif role == 'profesor':
                  run_command(f"groupadd -f profesores && usermod -aG profesores {username}")
              elif role == 'alumno':
                  run_command(f"groupadd -f alumnos && usermod -aG alumnos {username}")
              
              # Log de la acci√≥n
              run_command(f"logger 'Usuario {username} creado por {session["user"]} con rol {role}'")
              
              return jsonify({'success': True, 'message': f'Usuario {username} creado exitosamente'})
          
          @app.route('/api/delete_user', methods=['POST'])
          @require_auth
          def delete_user():
              data = request.get_json()
              username = data.get('username')
              
              if username in ['root', 'ansible', 'admin']:
                  return jsonify({'success': False, 'error': 'No se puede eliminar usuario del sistema'})
              
              cmd = f"userdel -r {username}"
              result = run_command(cmd, check=False)
              
              if result['success']:
                  run_command(f"logger 'Usuario {username} eliminado por {session["user"]}'")
                  return jsonify({'success': True, 'message': f'Usuario {username} eliminado'})
              else:
                  return jsonify({'success': False, 'error': f'Error: {result["stderr"]}'})
          
          @app.route('/api/modify_user', methods=['POST'])
          @require_auth
          def modify_user():
              data = request.get_json()
              username = data.get('username')
              action = data.get('action')
              value = data.get('value')
              
              if action == 'add_group':
                  cmd = f"usermod -aG {value} {username}"
              elif action == 'remove_group':
                  cmd = f"gpasswd -d {username} {value}"
              elif action == 'change_shell':
                  cmd = f"usermod -s {value} {username}"
              elif action == 'lock':
                  cmd = f"usermod -L {username}"
              elif action == 'unlock':
                  cmd = f"usermod -U {username}"
              else:
                  return jsonify({'success': False, 'error': 'Acci√≥n no v√°lida'})
              
              result = run_command(cmd, check=False)
              
              if result['success']:
                  run_command(f"logger 'Usuario {username}: {action} {value} por {session["user"]}'")
                  return jsonify({'success': True, 'message': f'Acci√≥n completada: {action}'})
              else:
                  return jsonify({'success': False, 'error': f'Error: {result["stderr"]}'})
          
          @app.route('/api/security_policies')
          @require_auth
          def get_security_policies():
              policies = []
              
              # Verificar pol√≠ticas de contrase√±as
              pam_result = run_command("grep -E 'password.*pam_pwquality' /etc/pam.d/common-password", check=False)
              policies.append({
                  'name': 'Calidad de Contrase√±as',
                  'status': 'enabled' if pam_result['success'] else 'disabled',
                  'description': 'Requiere contrase√±as complejas'
              })
              
              # Verificar sudo timeout
              sudo_result = run_command("grep 'timestamp_timeout' /etc/sudoers", check=False)
              policies.append({
                  'name': 'Timeout de Sudo',
                  'status': 'enabled' if sudo_result['success'] else 'default',
                  'description': 'Tiempo l√≠mite para comandos sudo'
              })
              
              return jsonify(policies)
          
          @app.route('/api/apply_policy', methods=['POST'])
          @require_auth
          def apply_security_policy():
              data = request.get_json()
              policy = data.get('policy')
              
              if policy == 'password_complexity':
                  # Instalar y configurar pam_pwquality
                  commands = [
                      "apt-get update -y",
                      "apt-get install -y libpam-pwquality",
                      "sed -i '/pam_pwquality.so/c\password requisite pam_pwquality.so retry=3 minlen=8 difok=3 ucredit=-1 lcredit=-1 dcredit=-1' /etc/pam.d/common-password"
                  ]
              elif policy == 'sudo_timeout':
                  commands = [
                      "echo 'Defaults timestamp_timeout=5' >> /etc/sudoers.d/timeout"
                  ]
              elif policy == 'login_restrictions':
                  commands = [
                      "echo 'account required pam_time.so' >> /etc/pam.d/login"
                  ]
              else:
                  return jsonify({'success': False, 'error': 'Pol√≠tica no reconocida'})
              
              for cmd in commands:
                  result = run_command(cmd, check=False)
                  if not result['success']:
                      return jsonify({'success': False, 'error': f'Error ejecutando: {cmd}'})
              
              run_command(f"logger 'Pol√≠tica {policy} aplicada por {session["user"]}'")
              return jsonify({'success': True, 'message': f'Pol√≠tica {policy} aplicada exitosamente'})
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8090, debug=False)
        dest: /var/www/security-dashboard/security_manager.py
        mode: '0755'

    - name: Crear directorio de templates
      file:
        path: /var/www/security-dashboard/templates
        state: directory
        mode: '0755'

    - name: Crear template de login (HTML est√°tico)
      shell: |
        cat > /var/www/security-dashboard/templates/login.html << 'EOF'
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Login - Gesti√≥n de Seguridad</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .login-container {
                    background: white;
                    padding: 40px;
                    border-radius: 15px;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                    width: 100%;
                    max-width: 400px;
                }
                
                .login-header {
                    text-align: center;
                    margin-bottom: 30px;
                }
                
                .login-header h1 {
                    color: #2c3e50;
                    margin-bottom: 10px;
                }
                
                .form-group {
                    margin-bottom: 20px;
                }
                
                .form-group label {
                    display: block;
                    margin-bottom: 5px;
                    color: #2c3e50;
                    font-weight: 500;
                }
                
                .form-group input {
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #ecf0f1;
                    border-radius: 8px;
                    font-size: 16px;
                    transition: border-color 0.3s ease;
                }
                
                .form-group input:focus {
                    outline: none;
                    border-color: #3498db;
                }
                
                .login-btn {
                    width: 100%;
                    background: linear-gradient(45deg, #3498db, #2980b9);
                    color: white;
                    border: none;
                    padding: 15px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                
                .login-btn:hover {
                    background: linear-gradient(45deg, #2980b9, #3498db);
                    transform: translateY(-2px);
                }
                
                .alert {
                    margin-bottom: 20px;
                    padding: 10px;
                    border-radius: 5px;
                    background: #e74c3c;
                    color: white;
                    display: none;
                }
            </style>
        </head>
        <body>
            <div class="login-container">
                <div class="login-header">
                    <h1>üîê Gesti√≥n de Seguridad</h1>
                    <p>Acceso Administrativo</p>
                </div>
                
                <div id="alert" class="alert"></div>
                
                <form method="POST">
                    <div class="form-group">
                        <label for="username">Usuario:</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Contrase√±a:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    
                    <button type="submit" class="login-btn">Iniciar Sesi√≥n</button>
                </form>
                
                <script>
                    // Mostrar errores de URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const error = urlParams.get('error');
                    if (error) {
                        document.getElementById('alert').style.display = 'block';
                        document.getElementById('alert').textContent = 'Credenciales inv√°lidas';
                    }
                </script>
            </div>
        </body>
        </html>
        EOF

    - name: Crear template principal del dashboard
      copy:
        content: |
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Gesti√≥n de Seguridad - Dashboard Administrativo</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: #f8f9fa;
                      min-height: 100vh;
                  }
                  
                  .navbar {
                      background: linear-gradient(45deg, #2c3e50, #3498db);
                      color: white;
                      padding: 15px 30px;
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                  }
                  
                  .navbar h1 { font-size: 1.5em; }
                  
                  .navbar .user-info {
                      display: flex;
                      align-items: center;
                      gap: 15px;
                  }
                  
                  .container {
                      max-width: 1600px;
                      margin: 0 auto;
                      padding: 30px;
                  }
                  
                  .section {
                      background: white;
                      margin-bottom: 30px;
                      border-radius: 15px;
                      padding: 25px;
                      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
                  }
                  
                  .section h2 {
                      color: #2c3e50;
                      margin-bottom: 20px;
                      padding-bottom: 10px;
                      border-bottom: 2px solid #3498db;
                  }
                  
                  .tabs {
                      display: flex;
                      margin-bottom: 20px;
                      border-bottom: 1px solid #ecf0f1;
                  }
                  
                  .tab {
                      padding: 10px 20px;
                      cursor: pointer;
                      border-bottom: 2px solid transparent;
                      color: #7f8c8d;
                      transition: all 0.3s ease;
                  }
                  
                  .tab.active {
                      color: #3498db;
                      border-bottom-color: #3498db;
                  }
                  
                  .tab-content {
                      display: none;
                  }
                  
                  .tab-content.active {
                      display: block;
                  }
                  
                  .btn {
                      background: linear-gradient(45deg, #3498db, #2980b9);
                      color: white;
                      border: none;
                      padding: 10px 20px;
                      border-radius: 8px;
                      cursor: pointer;
                      margin: 5px;
                      transition: all 0.3s ease;
                  }
                  
                  .btn:hover {
                      background: linear-gradient(45deg, #2980b9, #3498db);
                      transform: translateY(-2px);
                  }
                  
                  .btn.danger {
                      background: linear-gradient(45deg, #e74c3c, #c0392b);
                  }
                  
                  .btn.danger:hover {
                      background: linear-gradient(45deg, #c0392b, #e74c3c);
                  }
                  
                  .form-group {
                      margin-bottom: 15px;
                  }
                  
                  .form-group label {
                      display: block;
                      margin-bottom: 5px;
                      color: #2c3e50;
                      font-weight: 500;
                  }
                  
                  .form-group input,
                  .form-group select {
                      width: 100%;
                      padding: 10px;
                      border: 2px solid #ecf0f1;
                      border-radius: 8px;
                      font-size: 14px;
                  }
                  
                  .users-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 20px;
                  }
                  
                  .user-card {
                      border: 2px solid #ecf0f1;
                      border-radius: 10px;
                      padding: 20px;
                      transition: all 0.3s ease;
                  }
                  
                  .user-card:hover {
                      border-color: #3498db;
                      transform: translateY(-5px);
                  }
                  
                  .user-header {
                      display: flex;
                      align-items: center;
                      margin-bottom: 15px;
                  }
                  
                  .user-icon {
                      font-size: 2em;
                      margin-right: 15px;
                  }
                  
                  .user-actions {
                      display: flex;
                      gap: 10px;
                      margin-top: 15px;
                  }
                  
                  .modal {
                      display: none;
                      position: fixed;
                      z-index: 1000;
                      left: 0;
                      top: 0;
                      width: 100%;
                      height: 100%;
                      background-color: rgba(0, 0, 0, 0.5);
                  }
                  
                  .modal-content {
                      background-color: white;
                      margin: 10% auto;
                      padding: 30px;
                      border-radius: 15px;
                      width: 90%;
                      max-width: 500px;
                  }
                  
                  .close {
                      color: #aaa;
                      float: right;
                      font-size: 28px;
                      font-weight: bold;
                      cursor: pointer;
                  }
                  
                  .close:hover { color: black; }
                  
                  .alert {
                      padding: 15px;
                      margin-bottom: 20px;
                      border-radius: 8px;
                      display: none;
                  }
                  
                  .alert.success {
                      background: #d4edda;
                      color: #155724;
                      border: 1px solid #c3e6cb;
                  }
                  
                  .alert.error {
                      background: #f8d7da;
                      color: #721c24;
                      border: 1px solid #f5c6cb;
                  }
              </style>
          </head>
          <body>
              <div class="navbar">
                  <h1>üõ°Ô∏è Gesti√≥n de Seguridad</h1>
                  <div class="user-info">
                      <span id="current-user">üë§ Usuario</span>
                      <a href="/logout" style="color: white; text-decoration: none;">Cerrar Sesi√≥n</a>
                  </div>
              </div>
              
              <div class="container">
                  <div id="alert" class="alert"></div>
                  
                  <div class="section">
                      <h2>Gesti√≥n de Usuarios</h2>
                      
                      <div class="tabs">
                          <div class="tab active" onclick="showTab('users-list')">Lista de Usuarios</div>
                          <div class="tab" onclick="showTab('create-user')">Crear Usuario</div>
                          <div class="tab" onclick="showTab('groups-mgmt')">Gesti√≥n de Grupos</div>
                      </div>
                      
                      <div id="users-list" class="tab-content active">
                          <div class="users-grid" id="usersContainer">
                              <!-- Se carga din√°micamente -->
                          </div>
                      </div>
                      
                      <div id="create-user" class="tab-content">
                          <form id="createUserForm">
                              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                  <div class="form-group">
                                      <label for="username">Nombre de Usuario:</label>
                                      <input type="text" id="username" required>
                                  </div>
                                  <div class="form-group">
                                      <label for="password">Contrase√±a:</label>
                                      <input type="password" id="password" required>
                                  </div>
                                  <div class="form-group">
                                      <label for="role">Rol:</label>
                                      <select id="role">
                                          <option value="alumno">Alumno</option>
                                          <option value="profesor">Profesor</option>
                                          <option value="admin">Administrador</option>
                                      </select>
                                  </div>
                              </div>
                              <button type="submit" class="btn">Crear Usuario</button>
                          </form>
                      </div>
                      
                      <div id="groups-mgmt" class="tab-content">
                          <div id="groupsContainer">
                              <!-- Se carga din√°micamente -->
                          </div>
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>Pol√≠ticas de Seguridad</h2>
                      <div id="policiesContainer">
                          <!-- Se carga din√°micamente -->
                      </div>
                  </div>
              </div>
              
              <!-- Modal para modificar usuario -->
              <div id="userModal" class="modal">
                  <div class="modal-content">
                      <span class="close" onclick="closeModal()">&times;</span>
                      <h3 id="modalTitle">Modificar Usuario</h3>
                      <div id="modalContent">
                          <!-- Se carga din√°micamente -->
                      </div>
                  </div>
              </div>
              
              <script>
                  // Funciones principales
                  function showTab(tabName) {
                      // Ocultar todos los contenidos
                      document.querySelectorAll('.tab-content').forEach(tab => {
                          tab.classList.remove('active');
                      });
                      
                      // Remover clase activa de todas las pesta√±as
                      document.querySelectorAll('.tab').forEach(tab => {
                          tab.classList.remove('active');
                      });
                      
                      // Mostrar contenido seleccionado
                      document.getElementById(tabName).classList.add('active');
                      
                      // Activar pesta√±a
                      event.target.classList.add('active');
                      
                      // Cargar datos seg√∫n la pesta√±a
                      if (tabName === 'users-list') {
                          loadUsers();
                      } else if (tabName === 'groups-mgmt') {
                          loadGroups();
                      }
                  }
                  
                  function loadUsers() {
                      fetch('/api/users')
                          .then(response => response.json())
                          .then(users => {
                              const container = document.getElementById('usersContainer');
                              container.innerHTML = '';
                              
                              users.forEach(user => {
                                  const userCard = createUserCard(user);
                                  container.appendChild(userCard);
                              });
                          })
                          .catch(error => showAlert('Error cargando usuarios: ' + error, 'error'));
                  }
                  
                  function createUserCard(user) {
                      const card = document.createElement('div');
                      card.className = 'user-card';
                      
                      const roleIcon = user.groups.includes('sudo') ? 'üîß' : 
                                      user.groups.includes('profesor') ? 'üë®‚Äçüè´' : 'üéì';
                      
                      card.innerHTML = `
                          <div class="user-header">
                              <div class="user-icon">${roleIcon}</div>
                              <div>
                                  <h4>${user.username}</h4>
                                  <p>UID: ${user.uid} | Home: ${user.home}</p>
                                  <p>Grupos: ${user.groups}</p>
                              </div>
                          </div>
                          <div class="user-actions">
                              <button class="btn" onclick="modifyUser('${user.username}')">Modificar</button>
                              <button class="btn danger" onclick="deleteUser('${user.username}')">Eliminar</button>
                          </div>
                      `;
                      
                      return card;
                  }
                  
                  function modifyUser(username) {
                      document.getElementById('modalTitle').textContent = `Modificar Usuario: ${username}`;
                      document.getElementById('modalContent').innerHTML = `
                          <div class="form-group">
                              <label>Agregar a Grupo:</label>
                              <input type="text" id="addGroup" placeholder="Nombre del grupo">
                              <button class="btn" onclick="addUserToGroup('${username}')">Agregar</button>
                          </div>
                          <div class="form-group">
                              <label>Remover de Grupo:</label>
                              <input type="text" id="removeGroup" placeholder="Nombre del grupo">
                              <button class="btn danger" onclick="removeUserFromGroup('${username}')">Remover</button>
                          </div>
                          <div class="form-group">
                              <button class="btn" onclick="lockUser('${username}')">Bloquear Usuario</button>
                              <button class="btn" onclick="unlockUser('${username}')">Desbloquear Usuario</button>
                          </div>
                      `;
                      document.getElementById('userModal').style.display = 'block';
                  }
                  
                  function deleteUser(username) {
                      if (confirm(`¬øEst√° seguro de eliminar al usuario ${username}?`)) {
                          fetch('/api/delete_user', {
                              method: 'POST',
                              headers: {'Content-Type': 'application/json'},
                              body: JSON.stringify({username: username})
                          })
                          .then(response => response.json())
                          .then(data => {
                              if (data.success) {
                                  showAlert(data.message, 'success');
                                  loadUsers();
                              } else {
                                  showAlert(data.error, 'error');
                              }
                          });
                      }
                  }
                  
                  function addUserToGroup(username) {
                      const group = document.getElementById('addGroup').value;
                      modifyUserAction(username, 'add_group', group);
                  }
                  
                  function removeUserFromGroup(username) {
                      const group = document.getElementById('removeGroup').value;
                      modifyUserAction(username, 'remove_group', group);
                  }
                  
                  function lockUser(username) {
                      modifyUserAction(username, 'lock', '');
                  }
                  
                  function unlockUser(username) {
                      modifyUserAction(username, 'unlock', '');
                  }
                  
                  function modifyUserAction(username, action, value) {
                      fetch('/api/modify_user', {
                          method: 'POST',
                          headers: {'Content-Type': 'application/json'},
                          body: JSON.stringify({username: username, action: action, value: value})
                      })
                      .then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              showAlert(data.message, 'success');
                              closeModal();
                              loadUsers();
                          } else {
                              showAlert(data.error, 'error');
                          }
                      });
                  }
                  
                  function loadGroups() {
                      fetch('/api/groups')
                          .then(response => response.json())
                          .then(groups => {
                              const container = document.getElementById('groupsContainer');
                              container.innerHTML = '<h3>Grupos del Sistema</h3>';
                              
                              groups.forEach(group => {
                                  const groupDiv = document.createElement('div');
                                  groupDiv.style.cssText = 'padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px;';
                                  groupDiv.innerHTML = `
                                      <h4>${group.name} (GID: ${group.gid})</h4>
                                      <p>Miembros: ${group.members || 'Ninguno'}</p>
                                  `;
                                  container.appendChild(groupDiv);
                              });
                          });
                  }
                  
                  function loadPolicies() {
                      fetch('/api/security_policies')
                          .then(response => response.json())
                          .then(policies => {
                              const container = document.getElementById('policiesContainer');
                              container.innerHTML = '';
                              
                              policies.forEach(policy => {
                                  const policyDiv = document.createElement('div');
                                  policyDiv.style.cssText = 'padding: 20px; margin: 15px 0; border: 1px solid #ddd; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;';
                                  policyDiv.innerHTML = `
                                      <div>
                                          <h4>${policy.name}</h4>
                                          <p>${policy.description}</p>
                                          <small>Estado: <strong>${policy.status}</strong></small>
                                      </div>
                                      <div>
                                          <button class="btn" onclick="applyPolicy('password_complexity')">Aplicar Pol√≠tica</button>
                                      </div>
                                  `;
                                  container.appendChild(policyDiv);
                              });
                          });
                  }
                  
                  function applyPolicy(policyName) {
                      fetch('/api/apply_policy', {
                          method: 'POST',
                          headers: {'Content-Type': 'application/json'},
                          body: JSON.stringify({policy: policyName})
                      })
                      .then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              showAlert(data.message, 'success');
                              loadPolicies();
                          } else {
                              showAlert(data.error, 'error');
                          }
                      });
                  }
                  
                  function closeModal() {
                      document.getElementById('userModal').style.display = 'none';
                  }
                  
                  function showAlert(message, type) {
                      const alert = document.getElementById('alert');
                      alert.className = `alert ${type}`;
                      alert.textContent = message;
                      alert.style.display = 'block';
                      
                      setTimeout(() => {
                          alert.style.display = 'none';
                      }, 5000);
                  }
                  
                  // Crear usuario
                  document.getElementById('createUserForm').addEventListener('submit', function(e) {
                      e.preventDefault();
                      
                      const userData = {
                          username: document.getElementById('username').value,
                          password: document.getElementById('password').value,
                          role: document.getElementById('role').value
                      };
                      
                      fetch('/api/create_user', {
                          method: 'POST',
                          headers: {'Content-Type': 'application/json'},
                          body: JSON.stringify(userData)
                      })
                      .then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              showAlert(data.message, 'success');
                              document.getElementById('createUserForm').reset();
                              showTab('users-list');
                          } else {
                              showAlert(data.error, 'error');
                          }
                      });
                  });
                  
                  // Cargar datos iniciales
                  document.addEventListener('DOMContentLoaded', function() {
                      loadUsers();
                      loadPolicies();
                  });
                  
                  // Cerrar modal al hacer clic fuera
                  window.onclick = function(event) {
                      const modal = document.getElementById('userModal');
                      if (event.target === modal) {
                          modal.style.display = 'none';
                      }
                  }
              </script>
          </body>
          </html>
        dest: /var/www/security-dashboard/templates/security_dashboard.html
        mode: '0644'

    - name: Instalar Flask si no est√° disponible
      pip:
        name: flask
        state: present

    - name: Iniciar aplicaci√≥n de gesti√≥n de seguridad
      shell: |
        cd /var/www/security-dashboard
        pkill -f "security_manager.py" || true
        sleep 2
        nohup python3 security_manager.py > /var/log/security_manager.log 2>&1 &
        sleep 3

    - name: Verificar que la aplicaci√≥n est√© corriendo
      wait_for:
        port: 8090
        host: 0.0.0.0
        timeout: 15

    - name: Mostrar informaci√≥n de acceso
      debug:
        msg:
          - "üõ°Ô∏è SISTEMA DE GESTI√ìN DE SEGURIDAD DESPLEGADO"
          - "============================================="
          - ""
          - "üåê Dashboard de Gesti√≥n: http://172.17.25.122:8090"
          - "üë§ Usuarios permitidos: admin, ansible"
          - "üîê Usar credenciales del sistema"
          - ""
          - "‚ú® Funcionalidades disponibles:"
          - "   üë• Crear/eliminar usuarios visualmente"
          - "   üîß Gestionar grupos y permisos"
          - "   üõ°Ô∏è Aplicar pol√≠ticas de seguridad"
          - "   üìä Monitoreo en tiempo real"
          - ""
          - "üîó Dashboard informativo: http://172.17.25.122:8088"