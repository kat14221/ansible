---
# Rol para instalar y configurar el dashboard de monitoreo Netdata

- name: "MONITORING: Instalar dependencias para el script de instalaciÃ³n"
  apt:
    name:
      - curl
      - git
      - gcc
      - make
      - autoconf
      - automake
      - pkg-config
      - zlib1g-dev
      - uuid-dev
    state: present
    update_cache: yes
  become: yes

- name: "MONITORING: Descargar el script de instalaciÃ³n de Netdata"
  get_url:
    url: "https://my-netdata.io/kickstart.sh"
    dest: "/tmp/kickstart.sh"
    mode: '0755'
  become: yes

- name: "MONITORING: Ejecutar el script de instalaciÃ³n de Netdata (modo no interactivo)"
  # Usamos --dont-wait para que no bloquee el playbook y --disable-telemetry por privacidad
  shell: /tmp/kickstart.sh --dont-wait --disable-telemetry
  args:
    creates: /etc/netdata/netdata.conf # No se ejecuta si Netdata ya estÃ¡ instalado
  become: yes
  changed_when: true # Siempre marcamos como cambio si se ejecuta

- name: "MONITORING: Permitir acceso al puerto de Netdata (19999) en el firewall"
  # Usamos nftables, que es el firewall que ya tienes configurado en el rol debian-ipv6-router
  shell: |
    nft list ruleset | grep -q 'tcp dport 19999 accept' || nft add rule inet ansible input tcp dport 19999 accept comment \"Allow Netdata Dashboard\"
  become: yes
  changed_when: true
  failed_when: false # No fallar si el comando nft falla (ej. la cadena 'ansible' no existe aÃºn)

- name: "MONITORING: Mostrar URL de acceso al dashboard"
  debug:
    msg:
      - "==================================================================="
      - "âœ… Dashboard de Monitoreo Netdata Instalado y Configurado"
      - "==================================================================="
      - ""
      - "Accede al dashboard interactivo en tu navegador:"
      - "   ðŸ‘‰ http://{{ ansible_host }}:19999"
      - "   ðŸ‘‰ http://[2025:db8:101::1]:19999"
      - ""
      - "Espera unos 30 segundos para que recolecte los primeros datos."
      - "==================================================================="
  run_once: true