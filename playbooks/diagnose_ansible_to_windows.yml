---
- name: DiagnÃ³stico de conectividad desde Ansible a Windows
  hosts: debian_router
  gather_facts: false
  become: true
  
  tasks:
    - name: Test ping IPv6 a Windows desde debian-router
      shell: ping6 -c 5 2025:db8:101::11
      register: ping_windows
      ignore_errors: true
      
    - name: Test conectividad puerto WinRM desde debian-router
      shell: |
        timeout 10 nc -v 2025:db8:101::11 5985 < /dev/null
      register: nc_winrm
      ignore_errors: true
      
    - name: Test curl a WinRM desde debian-router
      shell: |
        timeout 15 curl -v --connect-timeout 10 \
             --user "ansible:Ansible123!" \
             --header "Content-Type: application/soap+xml;charset=UTF-8" \
             "http://[2025:db8:101::11]:5985/wsman" 2>&1 || echo "CURL_FAILED"
      register: curl_winrm
      ignore_errors: true
      
    - name: Mostrar resultados de conectividad
      debug:
        msg:
          - "=== DIAGNÃ“STICO CONECTIVIDAD A WINDOWS ==="
          - ""
          - "ğŸ” Ping IPv6:"
          - "{{ ping_windows.stdout_lines | default(['FAILED']) | join(' | ') }}"
          - ""
          - "ğŸ” Puerto 5985 (nc):"
          - "{{ nc_winrm.stdout_lines | default(['FAILED']) | join(' | ') }}"  
          - "{{ nc_winrm.stderr_lines | default(['']) | join(' | ') }}"
          - ""
          - "ğŸ” WinRM HTTP (curl):"
          - "{{ curl_winrm.stdout_lines | default(['FAILED']) | join(' | ') }}"
          - ""
          - "ğŸ’¡ ANÃLISIS:"
          - "{% if 'ttl=' in ping_windows.stdout %}âœ… IPv6 funciona{% else %}âŒ IPv6 no funciona{% endif %}"
          - "{% if 'succeeded' in nc_winrm.stdout or 'Connected' in nc_winrm.stderr %}âœ… Puerto accesible{% else %}âŒ Puerto no accesible{% endif %}"