---
- name: Dashboard de GestiÃ³n de Seguridad Limpio
  hosts: debian_router
  gather_facts: true
  become: true
  
  tasks:
    - name: Instalar dependencias del sistema
      apt:
        name:
          - python3
          - python3-flask
          - python3-venv
          - sudo
        state: present
        update_cache: yes

    - name: Crear aplicaciÃ³n Flask
      shell: |
        cat > /home/ansible/security_app.py << 'EOF'
        #!/usr/bin/env python3
        from flask import Flask, request, jsonify, redirect, session
        import subprocess
        import json
          
          app = Flask(__name__)
          app.secret_key = 'ansible-security-2025'
          
          def run_cmd(cmd):
              try:
                  result = subprocess.run(cmd, shell=True, capture_output=True, text=True, check=True)
                  return {'success': True, 'output': result.stdout}
              except subprocess.CalledProcessError as e:
                  return {'success': False, 'error': str(e), 'output': e.stdout}
          
          @app.route('/')
          def dashboard():
              if 'user' not in session:
                  return redirect('/login')
              return '''
          <!DOCTYPE html>
          <html>
          <head>
              <title>GestiÃ³n de Seguridad</title>
              <style>
                  * { margin:0; padding:0; box-sizing:border-box; }
                  body { font-family:Arial; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height:100vh; }
                  .navbar { background:rgba(44,62,80,0.9); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center; }
                  .container { max-width:1200px; margin:0 auto; padding:30px; }
                  .section { background:rgba(255,255,255,0.95); margin:20px 0; border-radius:15px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
                  .btn { background:#3498db; color:white; border:none; padding:12px 25px; border-radius:8px; cursor:pointer; margin:5px; font-size:16px; }
                  .btn:hover { background:#2980b9; transform:translateY(-2px); }
                  .btn.danger { background:#e74c3c; }
                  .form-group { margin:15px 0; }
                  .form-group input, .form-group select { width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; }
                  .users-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-top:20px; }
                  .user-card { background:#f8f9fa; border:2px solid #dee2e6; border-radius:12px; padding:20px; transition:transform 0.3s; }
                  .user-card:hover { transform:translateY(-5px); box-shadow:0 8px 25px rgba(0,0,0,0.15); }
                  .alert { padding:15px; margin:15px 0; border-radius:8px; display:none; }
                  .alert.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
                  .alert.error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
              </style>
          </head>
          <body>
              <div class="navbar">
                  <h1>ğŸ›¡ï¸ GestiÃ³n de Seguridad</h1>
                  <div>
                      <span>ğŸ‘¤ ''' + session.get('user', 'Usuario') + '''</span>
                      <a href="/logout" style="color:white; margin-left:20px; text-decoration:none;">Salir</a>
                  </div>
              </div>
              <div class="container">
                  <div id="alert" class="alert"></div>
                  
                  <div class="section">
                      <h2>ğŸ“Š Estado del Sistema</h2>
                      <button class="btn" onclick="checkStatus()">ğŸ” Verificar Estado</button>
                      <div id="statusContainer"></div>
                  </div>
                  
                  <div class="section">
                      <h2>ğŸ‘¥ GestiÃ³n de Usuarios</h2>
                      <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px;">
                          <div>
                              <h3>Crear Usuario</h3>
                              <form onsubmit="createUser(event)">
                                  <div class="form-group">
                                      <input type="text" id="username" placeholder="Nombre de usuario" required>
                                  </div>
                                  <div class="form-group">
                                      <input type="password" id="password" placeholder="ContraseÃ±a" required>
                                  </div>
                                  <div class="form-group">
                                      <select id="role" required>
                                          <option value="">Seleccionar rol</option>
                                          <option value="alumno">ğŸ‘¨â€ğŸ“ Alumno</option>
                                          <option value="profesor">ğŸ‘¨â€ğŸ« Profesor</option>
                                          <option value="admin">ğŸ”§ Administrador</option>
                                      </select>
                                  </div>
                                  <button type="submit" class="btn">â• Crear Usuario</button>
                              </form>
                          </div>
                          <div>
                              <h3>Usuarios Actuales</h3>
                              <button class="btn" onclick="loadUsers()">ğŸ”„ Actualizar Lista</button>
                              <div class="users-grid" id="usersContainer"></div>
                          </div>
                      </div>
                  </div>
              </div>
              
              <script>
                  function showAlert(msg, type) {
                      const alert = document.getElementById('alert');
                      alert.className = 'alert ' + type;
                      alert.textContent = msg;
                      alert.style.display = 'block';
                      setTimeout(() => alert.style.display = 'none', 5000);
                  }
                  
                  function loadUsers() {
                      fetch('/api/users')
                          .then(r => r.json())
                          .then(users => {
                              const container = document.getElementById('usersContainer');
                              container.innerHTML = '';
                              users.forEach(user => {
                                  const icon = user.groups.includes('sudo') ? 'ğŸ”§' : 
                                             user.groups.includes('profesor') ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ‘¨â€ğŸ“';
                                  const card = document.createElement('div');
                                  card.className = 'user-card';
                                  card.innerHTML = `
                                      <div style="display:flex; align-items:center; margin-bottom:10px;">
                                          <span style="font-size:2em; margin-right:15px;">${icon}</span>
                                          <div>
                                              <h4>${user.username}</h4>
                                              <p>UID: ${user.uid}</p>
                                              <p>Grupos: ${user.groups}</p>
                                          </div>
                                      </div>
                                      <button class="btn danger" onclick="deleteUser('${user.username}')">
                                          ğŸ—‘ï¸ Eliminar
                                      </button>
                                  `;
                                  container.appendChild(card);
                              });
                          })
                          .catch(e => showAlert('Error cargando usuarios: ' + e.message, 'error'));
                  }
                  
                  function createUser(e) {
                      e.preventDefault();
                      const data = {
                          username: document.getElementById('username').value,
                          password: document.getElementById('password').value,
                          role: document.getElementById('role').value
                      };
                      
                      fetch('/api/create_user', {
                          method: 'POST',
                          headers: {'Content-Type': 'application/json'},
                          body: JSON.stringify(data)
                      })
                      .then(r => r.json())
                      .then(result => {
                          showAlert(result.message || result.error, result.success ? 'success' : 'error');
                          if (result.success) {
                              e.target.reset();
                              loadUsers();
                          }
                      });
                  }
                  
                  function deleteUser(username) {
                      if (confirm('Â¿Eliminar usuario ' + username + '?')) {
                          fetch('/api/delete_user', {
                              method: 'POST',
                              headers: {'Content-Type': 'application/json'},
                              body: JSON.stringify({username: username})
                          })
                          .then(r => r.json())
                          .then(result => {
                              showAlert(result.message || result.error, result.success ? 'success' : 'error');
                              if (result.success) loadUsers();
                          });
                      }
                  }
                  
                  function checkStatus() {
                      fetch('/api/status')
                          .then(r => r.json())
                          .then(status => {
                              const container = document.getElementById('statusContainer');
                              container.innerHTML = `
                                  <div style="margin-top:20px; padding:20px; background:#f8f9fa; border-radius:8px;">
                                      <p><strong>ğŸ–¥ï¸ Sistema:</strong> ${status.hostname}</p>
                                      <p><strong>â° Fecha:</strong> ${status.date}</p>
                                      <p><strong>ğŸ‘¥ Usuarios conectados:</strong> ${status.users}</p>
                                      <p><strong>ğŸ’¾ Espacio libre:</strong> ${status.disk}</p>
                                  </div>
                              `;
                          });
                  }
                  
                  // Cargar datos iniciales
                  loadUsers();
                  checkStatus();
              </script>
          </body>
          </html>'''
          
          @app.route('/login', methods=['GET', 'POST'])
          def login():
              if request.method == 'POST':
                  username = request.form.get('username')
                  password = request.form.get('password')
                  if username in ['admin', 'ansible'] and len(password) > 3:
                      session['user'] = username
                      return redirect('/')
                  else:
                      error_msg = 'Credenciales incorrectas'
              else:
                  error_msg = ''
              
              return f'''
          <!DOCTYPE html>
          <html>
          <head>
              <title>Login</title>
              <style>
                  body {{ font-family:Arial; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }}
                  .login-box {{ background:rgba(255,255,255,0.95); padding:50px; border-radius:20px; box-shadow:0 15px 35px rgba(0,0,0,0.3); max-width:400px; width:100%; }}
                  .login-box h1 {{ text-align:center; color:#2c3e50; margin-bottom:40px; font-size:28px; }}
                  .form-group {{ margin-bottom:25px; }}
                  .form-group input {{ width:100%; padding:15px; border:2px solid #ddd; border-radius:10px; font-size:16px; box-sizing:border-box; }}
                  .login-btn {{ width:100%; background:#3498db; color:white; border:none; padding:18px; border-radius:10px; font-size:18px; cursor:pointer; }}
                  .login-btn:hover {{ background:#2980b9; }}
                  .error {{ background:#e74c3c; color:white; padding:15px; border-radius:8px; margin-bottom:25px; text-align:center; }}
              </style>
          </head>
          <body>
              <div class="login-box">
                  <h1>ğŸ” GestiÃ³n de Seguridad</h1>
                  {"<div class='error'>" + error_msg + "</div>" if error_msg else ""}
                  <form method="POST">
                      <div class="form-group">
                          <input type="text" name="username" placeholder="Usuario" required>
                      </div>
                      <div class="form-group">
                          <input type="password" name="password" placeholder="ContraseÃ±a" required>
                      </div>
                      <button type="submit" class="login-btn">Iniciar SesiÃ³n</button>
                  </form>
              </div>
          </body>
          </html>'''
          
          @app.route('/logout')
          def logout():
              session.clear()
              return redirect('/login')
          
          @app.route('/api/users')
          def api_users():
              if 'user' not in session:
                  return jsonify({'error': 'No autorizado'}), 401
              
              result = run_cmd("getent passwd | grep -E '/home|/Users' | cut -d: -f1,3,6 | sort")
              if not result['success']:
                  return jsonify({'error': 'Error obteniendo usuarios'})
              
              users = []
              for line in result['output'].strip().split('\n'):
                  if line:
                      parts = line.split(':')
                      if len(parts) >= 3:
                          username = parts[0]
                          uid = parts[1]
                          
                          # Obtener grupos
                          groups_result = run_cmd(f"groups {username}")
                          groups = groups_result['output'].split(':')[1].strip() if groups_result['success'] else ''
                          
                          users.append({
                              'username': username,
                              'uid': uid,
                              'groups': groups
                          })
              
              return jsonify(users)
          
          @app.route('/api/create_user', methods=['POST'])
          def api_create_user():
              if 'user' not in session:
                  return jsonify({'error': 'No autorizado'}), 401
              
              data = request.get_json()
              username = data.get('username')
              password = data.get('password')
              role = data.get('role')
              
              if not all([username, password, role]):
                  return jsonify({'error': 'Datos incompletos', 'success': False})
              
              # Crear usuario
              cmd = f"sudo useradd -m -s /bin/bash {username}"
              result = run_cmd(cmd)
              
              if not result['success']:
                  return jsonify({'error': f'Error creando usuario: {result.get("error", "")}', 'success': False})
              
              # Establecer contraseÃ±a
              passwd_cmd = f"echo '{username}:{password}' | sudo chpasswd"
              passwd_result = run_cmd(passwd_cmd)
              
              # Asignar a grupo segÃºn rol
              if role == 'profesor':
                  run_cmd(f"sudo usermod -aG profesor {username}")
              elif role == 'admin':
                  run_cmd(f"sudo usermod -aG sudo {username}")
              
              return jsonify({'message': f'Usuario {username} creado exitosamente', 'success': True})
          
          @app.route('/api/delete_user', methods=['POST'])
          def api_delete_user():
              if 'user' not in session:
                  return jsonify({'error': 'No autorizado'}), 401
              
              data = request.get_json()
              username = data.get('username')
              
              if not username:
                  return jsonify({'error': 'Username requerido', 'success': False})
              
              # Prevenir eliminaciÃ³n de usuarios del sistema
              if username in ['root', 'admin', 'ansible']:
                  return jsonify({'error': 'No se puede eliminar usuario del sistema', 'success': False})
              
              cmd = f"sudo userdel -r {username}"
              result = run_cmd(cmd)
              
              if result['success']:
                  return jsonify({'message': f'Usuario {username} eliminado', 'success': True})
              else:
                  return jsonify({'error': f'Error eliminando usuario: {result.get("error", "")}', 'success': False})
          
          @app.route('/api/status')
          def api_status():
              if 'user' not in session:
                  return jsonify({'error': 'No autorizado'}), 401
              
              hostname = run_cmd('hostname')['output'].strip()
              date = run_cmd('date')['output'].strip()
              users = run_cmd('who | wc -l')['output'].strip()
              disk = run_cmd("df -h / | tail -1 | awk '{print $4}'")['output'].strip()
              
              return jsonify({
                  'hostname': hostname,
                  'date': date,
                  'users': users,
                  'disk': disk
              })
          
        if __name__ == '__main__':
            app.run(host='0.0.0.0', port=8090, debug=True)
        EOF

    - name: Hacer ejecutable la aplicaciÃ³n
      file:
        path: /home/ansible/security_app.py
        mode: '0755'
        owner: ansible
        group: ansible

    - name: Ejecutar aplicaciÃ³n Flask
      shell: |
        cd /home/ansible
        # Detener proceso anterior si existe
        pkill -f "python3 security_app.py" || true
        # Iniciar nueva aplicaciÃ³n en background
        nohup python3 security_app.py > security_app.log 2>&1 &
        sleep 3
      become: false

    - name: Verificar que la aplicaciÃ³n estÃ¡ ejecutÃ¡ndose
      wait_for:
        port: 8090
        host: "{{ ansible_default_ipv4.address }}"
        timeout: 30

    - name: Mostrar informaciÃ³n de acceso
      debug:
        msg:
          - "ğŸ›¡ï¸ SISTEMA DE GESTIÃ“N DE SEGURIDAD DESPLEGADO"
          - "============================================="
          - ""
          - "ğŸŒ Dashboard: http://{{ ansible_default_ipv4.address }}:8090"
          - "ğŸ‘¤ Login: admin/ansible (contraseÃ±a > 3 caracteres)"
          - ""
          - "âœ¨ Funcionalidades disponibles:"
          - "   ğŸ‘¥ Crear/eliminar usuarios visualmente"
          - "   ğŸ“Š Estado del sistema en tiempo real"
          - "   ğŸ”§ API REST completa"
          - ""
          - "ğŸ“‹ Comandos Ãºtiles:"
          - "   - Ver logs: tail -f /home/ansible/security_app.log"
          - "   - Reiniciar: pkill -f security_app.py && nohup python3 security_app.py &"