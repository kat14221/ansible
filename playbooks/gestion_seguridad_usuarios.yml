---
- name: "Gesti√≥n de Seguridad por Usuario - Pol√≠ticas y Permisos"
  hosts: debian-router
  gather_facts: no
  become: true
  
  tasks:
    - name: "Crear sistema de gesti√≥n de seguridad por usuario"
      copy:
        content: |
          #!/usr/bin/env python3
          """
          Sistema de Gesti√≥n de Seguridad por Usuario
          Pol√≠ticas seguras con restricciones claras
          """
          
          import socket
          import threading
          import json
          import subprocess
          import datetime
          import os
          from urllib.parse import parse_qs, urlparse
          
          class GestionSeguridadUsuarios:
              def __init__(self, host='0.0.0.0', port=8085):
                  self.host = host
                  self.port = port
                  self.politicas_usuario = {}
                  self.cargar_politicas()
              
              def cargar_politicas(self):
                  """Carga pol√≠ticas de seguridad por usuario"""
                  # Pol√≠ticas por defecto para diferentes roles
                  self.politicas_default = {
                      'estudiante': {
                          'horario_acceso': '08:00-18:00',
                          'dias_permitidos': 'lunes-viernes',
                          'directorios_permitidos': ['/home/academico/estudiantes', '/tmp'],
                          'comandos_bloqueados': ['sudo', 'su', 'passwd', 'chmod 777'],
                          'tiempo_sesion_max': 480,  # 8 horas
                          'intentos_login_max': 3
                      },
                      'profesor': {
                          'horario_acceso': '07:00-20:00',
                          'dias_permitidos': 'lunes-sabado',
                          'directorios_permitidos': ['/home/academico', '/opt/recursos'],
                          'comandos_bloqueados': ['rm -rf /', 'dd if='],
                          'tiempo_sesion_max': 720,  # 12 horas
                          'intentos_login_max': 5
                      },
                      'administrador': {
                          'horario_acceso': '24/7',
                          'dias_permitidos': 'todos',
                          'directorios_permitidos': ['todos'],
                          'comandos_bloqueados': [],
                          'tiempo_sesion_max': 0,  # sin l√≠mite
                          'intentos_login_max': 10
                      }
                  }
              
              def obtener_usuarios_con_politicas(self):
                  """Obtiene lista de usuarios con sus pol√≠ticas actuales"""
                  usuarios = []
                  
                  try:
                      # Obtener usuarios del sistema
                      resultado = subprocess.run(['getent', 'passwd'], capture_output=True, text=True)
                      
                      for linea in resultado.stdout.split('\n'):
                          if linea and '/home/' in linea:
                              partes = linea.split(':')
                              username = partes[0]
                              uid = partes[2]
                              home = partes[5]
                              
                              # Determinar rol del usuario
                              rol = self.determinar_rol_usuario(username)
                              
                              # Obtener pol√≠ticas actuales
                              politicas = self.obtener_politicas_usuario(username, rol)
                              
                              usuarios.append({
                                  'username': username,
                                  'uid': uid,
                                  'home': home,
                                  'rol': rol,
                                  'politicas': politicas,
                                  'estado': self.verificar_estado_usuario(username)
                              })
                  
                  except Exception as e:
                      print(f"Error obteniendo usuarios: {e}")
                  
                  return usuarios
              
              def determinar_rol_usuario(self, username):
                  """Determina el rol de un usuario basado en sus grupos"""
                  try:
                      resultado = subprocess.run(['groups', username], capture_output=True, text=True)
                      grupos = resultado.stdout.lower()
                      
                      if 'sudo' in grupos or 'admin' in grupos or 'administradores' in grupos:
                          return 'administrador'
                      elif 'profesor' in grupos or 'profesores' in grupos:
                          return 'profesor'
                      else:
                          return 'estudiante'
                  except:
                      return 'estudiante'
              
              def obtener_politicas_usuario(self, username, rol):
                  """Obtiene las pol√≠ticas de seguridad espec√≠ficas del usuario"""
                  politicas_base = self.politicas_default.get(rol, self.politicas_default['estudiante'])
                  
                  # Verificar pol√≠ticas personalizadas
                  archivo_politicas = f"/etc/seguridad/{username}.json"
                  if os.path.exists(archivo_politicas):
                      try:
                          with open(archivo_politicas, 'r') as f:
                              politicas_custom = json.load(f)
                              politicas_base.update(politicas_custom)
                      except:
                          pass
                  
                  return politicas_base
              
              def verificar_estado_usuario(self, username):
                  """Verifica el estado actual del usuario"""
                  try:
                      # Verificar si est√° bloqueado
                      resultado = subprocess.run(['passwd', '-S', username], capture_output=True, text=True)
                      if 'L' in resultado.stdout:
                          return 'bloqueado'
                      
                      # Verificar √∫ltima conexi√≥n
                      resultado = subprocess.run(['lastlog', '-u', username], capture_output=True, text=True)
                      if 'Never logged in' in resultado.stdout:
                          return 'nunca_conectado'
                      
                      return 'activo'
                  except:
                      return 'desconocido'
              
              def aplicar_politica_usuario(self, username, politicas):
                  """Aplica pol√≠ticas de seguridad espec√≠ficas a un usuario"""
                  resultados = []
                  
                  try:
                      # Crear directorio de configuraci√≥n si no existe
                      os.makedirs('/etc/seguridad', exist_ok=True)
                      
                      # 1. Configurar restricciones de tiempo
                      if 'horario_acceso' in politicas:
                          resultado = self.configurar_restriccion_horario(username, politicas['horario_acceso'])
                          resultados.append(resultado)
                      
                      # 2. Configurar l√≠mites de sesi√≥n
                      if 'tiempo_sesion_max' in politicas:
                          resultado = self.configurar_limite_sesion(username, politicas['tiempo_sesion_max'])
                          resultados.append(resultado)
                      
                      # 3. Configurar restricciones de directorio
                      if 'directorios_permitidos' in politicas:
                          resultado = self.configurar_restricciones_directorio(username, politicas['directorios_permitidos'])
                          resultados.append(resultado)
                      
                      # 4. Configurar comandos bloqueados
                      if 'comandos_bloqueados' in politicas:
                          resultado = self.configurar_comandos_bloqueados(username, politicas['comandos_bloqueados'])
                          resultados.append(resultado)
                      
                      # 5. Guardar pol√≠ticas personalizadas
                      archivo_politicas = f"/etc/seguridad/{username}.json"
                      with open(archivo_politicas, 'w') as f:
                          json.dump(politicas, f, indent=2)
                      
                      # Log de la acci√≥n
                      self.log_accion(f"Pol√≠ticas aplicadas al usuario {username}")
                      
                      return {'success': True, 'resultados': resultados}
                  
                  except Exception as e:
                      return {'success': False, 'error': str(e)}
              
              def configurar_restriccion_horario(self, username, horario):
                  """Configura restricciones de horario para el usuario"""
                  try:
                      # Configurar PAM time
                      regla_pam = f"{username};*;*;{horario.replace('-', '-')}"
                      
                      # Agregar regla a /etc/security/time.conf
                      with open('/etc/security/time.conf', 'a') as f:
                          f.write(f"\n# Restricci√≥n para {username}\n")
                          f.write(f"{regla_pam}\n")
                      
                      return f"‚úÖ Horario configurado: {horario}"
                  except Exception as e:
                      return f"‚ùå Error configurando horario: {e}"
              
              def configurar_limite_sesion(self, username, tiempo_max):
                  """Configura l√≠mite de tiempo de sesi√≥n"""
                  try:
                      if tiempo_max > 0:
                          # Configurar en /etc/security/limits.conf
                          regla = f"{username} hard maxlogins 1\n{username} hard cpu {tiempo_max}\n"
                          
                          with open('/etc/security/limits.conf', 'a') as f:
                              f.write(f"\n# L√≠mites para {username}\n")
                              f.write(regla)
                      
                      return f"‚úÖ L√≠mite de sesi√≥n: {tiempo_max} minutos"
                  except Exception as e:
                      return f"‚ùå Error configurando l√≠mites: {e}"
              
              def configurar_restricciones_directorio(self, username, directorios):
                  """Configura restricciones de acceso a directorios"""
                  try:
                      # Crear script de validaci√≥n de rutas
                      script_content = f'''#!/bin/bash
          # Script de validaci√≥n de rutas para {username}
          USUARIO="{username}"
          DIRECTORIOS_PERMITIDOS=({' '.join([f'"{d}"' for d in directorios])})
          
          validar_ruta() {{
              local ruta="$1"
              for dir_permitido in "${{DIRECTORIOS_PERMITIDOS[@]}}"; do
                  if [[ "$ruta" == "$dir_permitido"* ]]; then
                      return 0
                  fi
              done
              echo "‚ùå Acceso denegado a: $ruta"
              return 1
          }}
          
          # Validar comando actual
          if [ "$#" -gt 0 ]; then
              validar_ruta "$1"
          fi
          '''
                      
                      with open(f'/etc/seguridad/rutas_{username}.sh', 'w') as f:
                          f.write(script_content)
                      
                      os.chmod(f'/etc/seguridad/rutas_{username}.sh', 0o755)
                      
                      return f"‚úÖ Restricciones de directorio configuradas"
                  except Exception as e:
                      return f"‚ùå Error configurando directorios: {e}"
              
              def configurar_comandos_bloqueados(self, username, comandos):
                  """Configura lista de comandos bloqueados"""
                  try:
                      # Crear script de validaci√≥n de comandos
                      comandos_bloqueados = '|'.join(comandos)
                      
                      script_content = f'''#!/bin/bash
          # Validador de comandos para {username}
          COMANDOS_BLOQUEADOS="{comandos_bloqueados}"
          
          if echo "$*" | grep -E "$COMANDOS_BLOQUEADOS" > /dev/null; then
              echo "‚ùå Comando bloqueado por pol√≠ticas de seguridad"
              logger "Intento de comando bloqueado por {username}: $*"
              exit 1
          fi
          '''
                      
                      with open(f'/etc/seguridad/comandos_{username}.sh', 'w') as f:
                          f.write(script_content)
                      
                      os.chmod(f'/etc/seguridad/comandos_{username}.sh', 0o755)
                      
                      return f"‚úÖ Comandos bloqueados configurados: {len(comandos)}"
                  except Exception as e:
                      return f"‚ùå Error configurando comandos: {e}"
              
              def generar_reporte_seguridad(self, username=None):
                  """Genera reporte de seguridad de usuarios"""
                  usuarios = self.obtener_usuarios_con_politicas()
                  
                  if username:
                      usuarios = [u for u in usuarios if u['username'] == username]
                  
                  reporte = {
                      'timestamp': datetime.datetime.now().isoformat(),
                      'usuarios_analizados': len(usuarios),
                      'usuarios': usuarios,
                      'resumen_seguridad': {
                          'usuarios_activos': len([u for u in usuarios if u['estado'] == 'activo']),
                          'usuarios_bloqueados': len([u for u in usuarios if u['estado'] == 'bloqueado']),
                          'administradores': len([u for u in usuarios if u['rol'] == 'administrador']),
                          'profesores': len([u for u in usuarios if u['rol'] == 'profesor']),
                          'estudiantes': len([u for u in usuarios if u['rol'] == 'estudiante'])
                      }
                  }
                  
                  return reporte
              
              def log_accion(self, mensaje):
                  """Registra acciones en el log de seguridad"""
                  timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                  with open('/var/log/seguridad_usuarios.log', 'a') as f:
                      f.write(f"[{timestamp}] {mensaje}\n")
              
              def generar_dashboard_html(self):
                  """Genera el dashboard HTML de gesti√≥n de seguridad"""
                  usuarios = self.obtener_usuarios_con_politicas()
                  reporte = self.generar_reporte_seguridad()
                  
                  html = f'''
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>üõ°Ô∏è Gesti√≥n de Seguridad por Usuario</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  
                  body {{
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                      min-height: 100vh;
                      color: #333;
                  }}
                  
                  .header {{
                      background: rgba(52, 73, 94, 0.95);
                      color: white;
                      padding: 20px;
                      text-align: center;
                      backdrop-filter: blur(10px);
                  }}
                  
                  .container {{
                      max-width: 1400px;
                      margin: 0 auto;
                      padding: 30px;
                  }}
                  
                  .stats-grid {{
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px;
                      margin-bottom: 30px;
                  }}
                  
                  .stat-card {{
                      background: rgba(255, 255, 255, 0.95);
                      padding: 25px;
                      border-radius: 15px;
                      text-align: center;
                      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                      transition: transform 0.3s ease;
                  }}
                  
                  .stat-card:hover {{
                      transform: translateY(-5px);
                  }}
                  
                  .stat-value {{
                      font-size: 3em;
                      font-weight: bold;
                      color: #3498db;
                      display: block;
                  }}
                  
                  .stat-label {{
                      color: #7f8c8d;
                      margin-top: 10px;
                  }}
                  
                  .usuarios-grid {{
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                      gap: 25px;
                  }}
                  
                  .usuario-card {{
                      background: rgba(255, 255, 255, 0.95);
                      border-radius: 15px;
                      padding: 25px;
                      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                      transition: transform 0.3s ease;
                  }}
                  
                  .usuario-card:hover {{
                      transform: translateY(-5px);
                  }}
                  
                  .usuario-header {{
                      display: flex;
                      align-items: center;
                      margin-bottom: 20px;
                  }}
                  
                  .usuario-icon {{
                      font-size: 3em;
                      margin-right: 15px;
                  }}
                  
                  .usuario-info h3 {{
                      color: #2c3e50;
                      margin-bottom: 5px;
                  }}
                  
                  .usuario-rol {{
                      display: inline-block;
                      padding: 5px 15px;
                      border-radius: 20px;
                      font-size: 0.9em;
                      font-weight: bold;
                      color: white;
                  }}
                  
                  .rol-administrador {{ background: #e74c3c; }}
                  .rol-profesor {{ background: #3498db; }}
                  .rol-estudiante {{ background: #27ae60; }}
                  
                  .politicas-lista {{
                      margin: 15px 0;
                  }}
                  
                  .politica-item {{
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 8px 0;
                      border-bottom: 1px solid #ecf0f1;
                  }}
                  
                  .politica-label {{
                      font-weight: 500;
                      color: #2c3e50;
                  }}
                  
                  .politica-valor {{
                      color: #7f8c8d;
                      font-size: 0.9em;
                  }}
                  
                  .estado {{
                      display: inline-block;
                      padding: 5px 10px;
                      border-radius: 15px;
                      font-size: 0.8em;
                      font-weight: bold;
                  }}
                  
                  .estado-activo {{ background: #d5f4e6; color: #27ae60; }}
                  .estado-bloqueado {{ background: #fadbd8; color: #e74c3c; }}
                  .estado-nunca_conectado {{ background: #fef9e7; color: #f39c12; }}
                  
                  .acciones {{
                      display: flex;
                      gap: 10px;
                      margin-top: 15px;
                  }}
                  
                  .btn {{
                      padding: 8px 16px;
                      border: none;
                      border-radius: 8px;
                      cursor: pointer;
                      font-weight: 500;
                      transition: all 0.3s ease;
                  }}
                  
                  .btn-primary {{ background: #3498db; color: white; }}
                  .btn-warning {{ background: #f39c12; color: white; }}
                  .btn-danger {{ background: #e74c3c; color: white; }}
                  
                  .btn:hover {{
                      transform: translateY(-2px);
                      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                  }}
                  
                  .modal {{
                      display: none;
                      position: fixed;
                      z-index: 1000;
                      left: 0;
                      top: 0;
                      width: 100%;
                      height: 100%;
                      background-color: rgba(0, 0, 0, 0.5);
                  }}
                  
                  .modal-content {{
                      background-color: white;
                      margin: 5% auto;
                      padding: 30px;
                      border-radius: 15px;
                      width: 90%;
                      max-width: 600px;
                      max-height: 80vh;
                      overflow-y: auto;
                  }}
                  
                  .form-group {{
                      margin-bottom: 15px;
                  }}
                  
                  .form-group label {{
                      display: block;
                      margin-bottom: 5px;
                      font-weight: 500;
                      color: #2c3e50;
                  }}
                  
                  .form-group input,
                  .form-group select {{
                      width: 100%;
                      padding: 10px;
                      border: 2px solid #ecf0f1;
                      border-radius: 8px;
                      font-size: 14px;
                  }}
                  
                  .form-group input:focus,
                  .form-group select:focus {{
                      outline: none;
                      border-color: #3498db;
                  }}
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>üõ°Ô∏è Gesti√≥n de Seguridad por Usuario</h1>
                  <p>Pol√≠ticas Seguras con Restricciones Claras</p>
              </div>
              
              <div class="container">
                  <!-- Estad√≠sticas Generales -->
                  <div class="stats-grid">
                      <div class="stat-card">
                          <span class="stat-value">{reporte['resumen_seguridad']['usuarios_activos']}</span>
                          <div class="stat-label">üë§ Usuarios Activos</div>
                      </div>
                      <div class="stat-card">
                          <span class="stat-value">{reporte['resumen_seguridad']['administradores']}</span>
                          <div class="stat-label">üîß Administradores</div>
                      </div>
                      <div class="stat-card">
                          <span class="stat-value">{reporte['resumen_seguridad']['profesores']}</span>
                          <div class="stat-label">üë®‚Äçüè´ Profesores</div>
                      </div>
                      <div class="stat-card">
                          <span class="stat-value">{reporte['resumen_seguridad']['estudiantes']}</span>
                          <div class="stat-label">üéì Estudiantes</div>
                      </div>
                  </div>
                  
                  <!-- Grid de Usuarios -->
                  <div class="usuarios-grid">
          '''
                  
                  # Generar tarjetas de usuario
                  for usuario in usuarios:
                      rol_class = f"rol-{usuario['rol']}"
                      estado_class = f"estado-{usuario['estado']}"
                      
                      icon_rol = {
                          'administrador': 'üîß',
                          'profesor': 'üë®‚Äçüè´',
                          'estudiante': 'üéì'
                      }.get(usuario['rol'], 'üë§')
                      
                      html += f'''
                      <div class="usuario-card">
                          <div class="usuario-header">
                              <div class="usuario-icon">{icon_rol}</div>
                              <div class="usuario-info">
                                  <h3>{usuario['username']}</h3>
                                  <span class="usuario-rol {rol_class}">{usuario['rol'].title()}</span>
                                  <span class="estado {estado_class}">{usuario['estado'].replace('_', ' ').title()}</span>
                              </div>
                          </div>
                          
                          <div class="politicas-lista">
                              <div class="politica-item">
                                  <span class="politica-label">üïê Horario Acceso:</span>
                                  <span class="politica-valor">{usuario['politicas'].get('horario_acceso', 'No definido')}</span>
                              </div>
                              <div class="politica-item">
                                  <span class="politica-label">üìÖ D√≠as Permitidos:</span>
                                  <span class="politica-valor">{usuario['politicas'].get('dias_permitidos', 'No definido')}</span>
                              </div>
                              <div class="politica-item">
                                  <span class="politica-label">‚è±Ô∏è Tiempo Sesi√≥n Max:</span>
                                  <span class="politica-valor">{usuario['politicas'].get('tiempo_sesion_max', 0)} min</span>
                              </div>
                              <div class="politica-item">
                                  <span class="politica-label">üö´ Comandos Bloqueados:</span>
                                  <span class="politica-valor">{len(usuario['politicas'].get('comandos_bloqueados', []))}</span>
                              </div>
                              <div class="politica-item">
                                  <span class="politica-label">üìÅ Directorios:</span>
                                  <span class="politica-valor">{len(usuario['politicas'].get('directorios_permitidos', []))}</span>
                              </div>
                          </div>
                          
                          <div class="acciones">
                              <button class="btn btn-primary" onclick="editarPoliticas('{usuario['username']}')">
                                  ‚úèÔ∏è Editar Pol√≠ticas
                              </button>
                              <button class="btn btn-warning" onclick="verDetalles('{usuario['username']}')">
                                  üìã Ver Detalles
                              </button>
                          </div>
                      </div>
                      '''
                  
                  html += '''
                  </div>
              </div>
              
              <!-- Modal para editar pol√≠ticas -->
              <div id="modalPoliticas" class="modal">
                  <div class="modal-content">
                      <h3 id="modalTitulo">Editar Pol√≠ticas de Usuario</h3>
                      <form id="formPoliticas">
                          <input type="hidden" id="usuarioActual" />
                          
                          <div class="form-group">
                              <label for="horarioAcceso">Horario de Acceso:</label>
                              <input type="text" id="horarioAcceso" placeholder="08:00-18:00" />
                          </div>
                          
                          <div class="form-group">
                              <label for="diasPermitidos">D√≠as Permitidos:</label>
                              <select id="diasPermitidos">
                                  <option value="lunes-viernes">Lunes a Viernes</option>
                                  <option value="lunes-sabado">Lunes a S√°bado</option>
                                  <option value="todos">Todos los d√≠as</option>
                              </select>
                          </div>
                          
                          <div class="form-group">
                              <label for="tiempoSesion">Tiempo M√°ximo de Sesi√≥n (minutos):</label>
                              <input type="number" id="tiempoSesion" min="0" />
                          </div>
                          
                          <div class="form-group">
                              <label for="intentosLogin">Intentos M√°ximos de Login:</label>
                              <input type="number" id="intentosLogin" min="1" max="10" />
                          </div>
                          
                          <div class="acciones">
                              <button type="submit" class="btn btn-primary">üíæ Guardar Pol√≠ticas</button>
                              <button type="button" class="btn btn-danger" onclick="cerrarModal()">‚ùå Cancelar</button>
                          </div>
                      </form>
                  </div>
              </div>
              
              <script>
                  function editarPoliticas(username) {
                      document.getElementById('usuarioActual').value = username;
                      document.getElementById('modalTitulo').textContent = 'Editar Pol√≠ticas: ' + username;
                      document.getElementById('modalPoliticas').style.display = 'block';
                  }
                  
                  function verDetalles(username) {
                      alert('Mostrando detalles completos de: ' + username);
                  }
                  
                  function cerrarModal() {
                      document.getElementById('modalPoliticas').style.display = 'none';
                  }
                  
                  function aplicarPoliticas() {
                      const username = document.getElementById('usuarioActual').value;
                      const politicas = {
                          horario_acceso: document.getElementById('horarioAcceso').value,
                          dias_permitidos: document.getElementById('diasPermitidos').value,
                          tiempo_sesion_max: parseInt(document.getElementById('tiempoSesion').value),
                          intentos_login_max: parseInt(document.getElementById('intentosLogin').value)
                      };
                      
                      // Aqu√≠ ir√≠a la llamada AJAX para aplicar las pol√≠ticas
                      alert('Pol√≠ticas aplicadas para: ' + username);
                      cerrarModal();
                  }
                  
                  document.getElementById('formPoliticas').addEventListener('submit', function(e) {
                      e.preventDefault();
                      aplicarPoliticas();
                  });
                  
                  // Cerrar modal al hacer clic fuera
                  window.onclick = function(event) {
                      const modal = document.getElementById('modalPoliticas');
                      if (event.target === modal) {
                          modal.style.display = 'none';
                      }
                  }
              </script>
          </body>
          </html>
                  '''
                  
                  return html
              
              def manejar_solicitud(self, conn, addr):
                  """Maneja las solicitudes HTTP"""
                  try:
                      data = conn.recv(1024).decode()
                      if not data:
                          return
                      
                      lines = data.split('\n')
                      request_line = lines[0]
                      method, path, _ = request_line.split()
                      
                      if method == 'GET':
                          if path == '/' or path == '/dashboard':
                              response_body = self.generar_dashboard_html()
                              response = f"HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8\r\nContent-Length: {len(response_body)}\r\n\r\n{response_body}"
                          
                          elif path == '/api/usuarios':
                              usuarios = self.obtener_usuarios_con_politicas()
                              response_body = json.dumps(usuarios, ensure_ascii=False, indent=2)
                              response = f"HTTP/1.1 200 OK\r\nContent-Type: application/json; charset=utf-8\r\nContent-Length: {len(response_body)}\r\n\r\n{response_body}"
                          
                          elif path == '/api/reporte':
                              reporte = self.generar_reporte_seguridad()
                              response_body = json.dumps(reporte, ensure_ascii=False, indent=2)
                              response = f"HTTP/1.1 200 OK\r\nContent-Type: application/json; charset=utf-8\r\nContent-Length: {len(response_body)}\r\n\r\n{response_body}"
                          
                          else:
                              response_body = "<h1>404 - P√°gina no encontrada</h1>"
                              response = f"HTTP/1.1 404 Not Found\r\nContent-Type: text/html\r\nContent-Length: {len(response_body)}\r\n\r\n{response_body}"
                      
                      else:
                          response_body = "<h1>405 - M√©todo no permitido</h1>"
                          response = f"HTTP/1.1 405 Method Not Allowed\r\nContent-Type: text/html\r\nContent-Length: {len(response_body)}\r\n\r\n{response_body}"
                      
                      conn.send(response.encode())
                  
                  except Exception as e:
                      print(f"Error manejando solicitud de {addr}: {e}")
                  
                  finally:
                      conn.close()
              
              def iniciar_servidor(self):
                  """Inicia el servidor web de gesti√≥n de seguridad"""
                  with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as server_socket:
                      server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
                      server_socket.bind((self.host, self.port))
                      server_socket.listen(5)
                      
                      print(f"üõ°Ô∏è Sistema de Gesti√≥n de Seguridad por Usuario iniciado")
                      print(f"üåê Acceso: http://{self.host}:{self.port}")
                      print(f"üë• Pol√≠ticas y permisos: Configuraci√≥n avanzada")
                      print("‚úÖ Sistema listo para administraci√≥n de seguridad")
                      
                      while True:
                          try:
                              conn, addr = server_socket.accept()
                              client_thread = threading.Thread(
                                  target=self.manejar_solicitud,
                                  args=(conn, addr)
                              )
                              client_thread.daemon = True
                              client_thread.start()
                          
                          except KeyboardInterrupt:
                              print("\nüõë Cerrando sistema de gesti√≥n de seguridad...")
                              break
                          except Exception as e:
                              print(f"Error en servidor: {e}")
          
          if __name__ == "__main__":
              gestion = GestionSeguridadUsuarios(host='0.0.0.0', port=8085)
              gestion.iniciar_servidor()
        dest: /usr/local/bin/gestion_seguridad_usuarios.py
        mode: '0755'

    - name: "Crear directorio de configuraci√≥n de seguridad"
      file:
        path: /etc/seguridad
        state: directory
        mode: '0755'

    - name: "Script de inicializaci√≥n del sistema de seguridad"
      copy:
        content: |
          #!/bin/bash
          # Inicializador del Sistema de Gesti√≥n de Seguridad por Usuario
          
          echo "üõ°Ô∏è Configurando Sistema de Gesti√≥n de Seguridad por Usuario..."
          
          # Crear estructura de directorios
          mkdir -p /etc/seguridad
          mkdir -p /var/log
          
          # Instalar dependencias PAM si es necesario
          if ! dpkg -l | grep -q libpam-modules-bin; then
            echo "üì¶ Instalando m√≥dulos PAM..."
            apt-get update -q
            apt-get install -y libpam-modules-bin
          fi
          
          # Configurar PAM time si no existe
          if [ ! -f /etc/security/time.conf ]; then
            echo "‚è∞ Configurando restricciones de tiempo PAM..."
            touch /etc/security/time.conf
            echo "# Configuraci√≥n de restricciones de tiempo por usuario" > /etc/security/time.conf
          fi
          
          # Habilitar PAM time en login
          if ! grep -q "pam_time.so" /etc/pam.d/login; then
            echo "account required pam_time.so" >> /etc/pam.d/login
          fi
          
          # Crear archivo de log de seguridad
          touch /var/log/seguridad_usuarios.log
          chmod 640 /var/log/seguridad_usuarios.log
          
          # Detener proceso anterior si existe
          pkill -f "gestion_seguridad_usuarios.py" 2>/dev/null || true
          sleep 2
          
          # Iniciar sistema de gesti√≥n de seguridad
          echo "üöÄ Iniciando sistema de gesti√≥n de seguridad..."
          nohup python3 /usr/local/bin/gestion_seguridad_usuarios.py > /var/log/gestion_seguridad.log 2>&1 &
          
          sleep 3
          
          # Verificar que est√© corriendo
          if pgrep -f "gestion_seguridad_usuarios.py" > /dev/null; then
            echo "‚úÖ Sistema iniciado correctamente"
            echo ""
            echo "üåê ACCESO AL SISTEMA:"
            echo "   ‚Ä¢ Dashboard: http://172.17.25.122:8085"
            echo "   ‚Ä¢ API Usuarios: http://172.17.25.122:8085/api/usuarios" 
            echo "   ‚Ä¢ API Reporte: http://172.17.25.122:8085/api/reporte"
            echo ""
            echo "üõ°Ô∏è FUNCIONALIDADES DISPONIBLES:"
            echo "   ‚úÖ Pol√≠ticas seguras por usuario y rol"
            echo "   ‚úÖ Restricciones de horario y tiempo de sesi√≥n"
            echo "   ‚úÖ Control de directorios permitidos"
            echo "   ‚úÖ Bloqueo de comandos peligrosos"
            echo "   ‚úÖ Monitoreo y reportes de seguridad"
            echo "   ‚úÖ Interface visual para administraci√≥n"
            echo ""
            echo "üë• ROLES CONFIGURADOS:"
            echo "   üéì Estudiantes: Horario 8-18h, acceso limitado"
            echo "   üë®‚Äçüè´ Profesores: Horario 7-20h, permisos extendidos"
            echo "   üîß Administradores: Acceso completo 24/7"
            echo ""
          else
            echo "‚ùå Error iniciando el sistema"
            echo "üìã Verificar logs en: /var/log/gestion_seguridad.log"
          fi
        dest: /usr/local/bin/iniciar_seguridad_usuarios.sh
        mode: '0755'

    - name: "Ejecutar inicializaci√≥n del sistema de seguridad"
      shell: /usr/local/bin/iniciar_seguridad_usuarios.sh

    - name: "Verificar que el servicio est√© corriendo"
      wait_for:
        port: 8085
        host: 172.17.25.122
        timeout: 15
      ignore_errors: yes

    - name: "Mostrar informaci√≥n final del sistema"
      debug:
        msg:
          - "üõ°Ô∏è SISTEMA DE GESTI√ìN DE SEGURIDAD POR USUARIO CONFIGURADO"
          - "============================================================"
          - ""
          - "üåê ACCESO PRINCIPAL:"
          - "   Dashboard: http://172.17.25.122:8085"
          - ""
          - "üîê POL√çTICAS DE SEGURIDAD IMPLEMENTADAS:"
          - "   ‚úÖ Restricciones de horario por rol"
          - "   ‚úÖ L√≠mites de tiempo de sesi√≥n"
          - "   ‚úÖ Control de directorios permitidos"
          - "   ‚úÖ Bloqueo de comandos peligrosos"
          - "   ‚úÖ L√≠mites de intentos de login"
          - ""
          - "üë• GESTI√ìN POR ROLES:"
          - "   üéì Estudiantes: Pol√≠ticas restrictivas"
          - "   üë®‚Äçüè´ Profesores: Permisos intermedios"
          - "   üîß Administradores: Acceso completo"
          - ""
          - "üìä FUNCIONALIDADES ADMINISTRATIVAS:"
          - "   ‚Ä¢ Edici√≥n visual de pol√≠ticas por usuario"
          - "   ‚Ä¢ Monitoreo del estado de usuarios"
          - "   ‚Ä¢ Reportes de seguridad automatizados"
          - "   ‚Ä¢ Logs centralizados de actividades"
          - ""
          - "üîß ARCHIVOS DE CONFIGURACI√ìN:"
          - "   ‚Ä¢ Sistema: /usr/local/bin/gestion_seguridad_usuarios.py"
          - "   ‚Ä¢ Pol√≠ticas: /etc/seguridad/"
          - "   ‚Ä¢ Logs: /var/log/seguridad_usuarios.log"
          - "   ‚Ä¢ PAM Time: /etc/security/time.conf"