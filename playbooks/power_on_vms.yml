---
# Playbook para encender VMs usando comandos SSH directos a ESXi
# Evita problemas de compatibilidad con librerÃ­as VMware
# Uso: ansible-playbook playbooks/power_on_vms.yml -vvv

- name: Encender VMs via SSH a ESXi
  hosts: localhost
  gather_facts: no
  vars:
    esxi_host: "172.17.25.1"
    esxi_user: "root"
    esxi_pass: "qwe123$"
  tasks:
    - name: Obtener lista de VMs y sus IDs
      shell: |
        sshpass -p '{{ esxi_pass }}' ssh -o StrictHostKeyChecking=no {{ esxi_user }}@{{ esxi_host }} "vim-cmd vmsvc/getallvms"
      register: vm_list
      ignore_errors: yes

    - name: Mostrar VMs encontradas
      debug:
        msg: "{{ vm_list.stdout_lines }}"

    - name: Encender vm-debian-router
      shell: |
        VM_ID=$(sshpass -p '{{ esxi_pass }}' ssh -o StrictHostKeyChecking=no {{ esxi_user }}@{{ esxi_host }} "vim-cmd vmsvc/getallvms | grep 'vm-debian-router' | awk '{print \$1}'")
        if [ ! -z "$VM_ID" ]; then
          sshpass -p '{{ esxi_pass }}' ssh -o StrictHostKeyChecking=no {{ esxi_user }}@{{ esxi_host }} "vim-cmd vmsvc/power.on $VM_ID"
          echo "VM Debian Router (ID: $VM_ID) encendida"
        else
          echo "VM Debian Router no encontrada"
        fi
      register: router_result
      ignore_errors: yes

    - name: Encender vm-ubuntu-pc
      shell: |
        VM_ID=$(sshpass -p '{{ esxi_pass }}' ssh -o StrictHostKeyChecking=no {{ esxi_user }}@{{ esxi_host }} "vim-cmd vmsvc/getallvms | grep 'vm-ubuntu-pc' | awk '{print \$1}'")
        if [ ! -z "$VM_ID" ]; then
          sshpass -p '{{ esxi_pass }}' ssh -o StrictHostKeyChecking=no {{ esxi_user }}@{{ esxi_host }} "vim-cmd vmsvc/power.on $VM_ID"
          echo "VM Ubuntu PC (ID: $VM_ID) encendida"
        else
          echo "VM Ubuntu PC no encontrada"
        fi
      register: ubuntu_result
      ignore_errors: yes

    - name: Encender vm-windows-pc
      shell: |
        VM_ID=$(sshpass -p '{{ esxi_pass }}' ssh -o StrictHostKeyChecking=no {{ esxi_user }}@{{ esxi_host }} "vim-cmd vmsvc/getallvms | grep 'vm-windows-pc' | awk '{print \$1}'")
        if [ ! -z "$VM_ID" ]; then
          sshpass -p '{{ esxi_pass }}' ssh -o StrictHostKeyChecking=no {{ esxi_user }}@{{ esxi_host }} "vim-cmd vmsvc/power.on $VM_ID"
          echo "VM Windows PC (ID: $VM_ID) encendida"
        else
          echo "VM Windows PC no encontrada"
        fi
      register: windows_result
      ignore_errors: yes

    - name: Mostrar resultados
      debug:
        msg:
          - "================================================"
          - "âš¡ ENCENDIDO DE VMs VIA SSH"
          - "================================================"
          - ""
          - "Debian Router: {{ router_result.stdout }}"
          - "Ubuntu PC: {{ ubuntu_result.stdout }}"
          - "Windows PC: {{ windows_result.stdout }}"
          - ""
          - "ðŸ“‹ Verificar en ESXi: https://172.17.25.1/ui/"
          - "================================================"
